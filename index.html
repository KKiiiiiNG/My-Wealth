<!DOCTYPE html>
<html lang="zh-CN" class="ios-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>iCost å¤åˆ»ç‰ˆ</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/dexie@3/dist/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* iOS é£æ ¼ä¼˜åŒ– */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* ç¦æ­¢æ©¡çš®ç­‹æ•ˆæœ */
            background-color: #f2f2f7; /* iOS ç³»ç»ŸèƒŒæ™¯è‰² */
        }
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* é€‚é…åˆ˜æµ·å±å’Œåº•éƒ¨æ¨ªæ¡ */
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body>

<div id="app" class="h-screen flex flex-col overflow-hidden">
    
    <main class="flex-1 overflow-y-auto no-scrollbar safe-pt">
        
        <div v-if="currentTab === 'timeline'" class="p-4 space-y-4">
            <div class="bg-white rounded-2xl p-5 shadow-sm">
                <div class="text-sm text-gray-500">æœ¬æœˆç»“ä½™</div>
                <div class="text-3xl font-bold mt-1">{{ formatCurrency(monthlyBalance) }}</div>
                <div class="flex mt-4 text-sm">
                    <div class="flex-1">
                        <div class="text-gray-500">æ”¶å…¥</div>
                        <div class="font-semibold text-green-600 text-lg">{{ formatCurrency(monthlyIncome) }}</div>
                    </div>
                    <div class="flex-1">
                        <div class="text-gray-500">æ”¯å‡º</div>
                        <div class="font-semibold text-red-600 text-lg">{{ formatCurrency(monthlyExpense) }}</div>
                    </div>
                </div>
            </div>

            <div class="space-y-2 pb-20">
                <div v-for="tx in recentTransactions" :key="tx.id" class="bg-white rounded-xl p-4 flex justify-between items-center shadow-sm active:bg-gray-50 transition">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl">
                            {{ getCategoryIcon(tx.category) }}
                        </div>
                        <div>
                            <div class="font-semibold">{{ tx.category }}</div>
                            <div class="text-xs text-gray-400 mt-0.5">
                                {{ formatDate(tx.date) }} Â· 
                                <span v-if="tx.type === 'transfer'">
                                    {{ getAccountName(tx.sourceAccountId) }} â” {{ getAccountName(tx.targetAccountId) }}
                                </span>
                                <span v-else>
                                    {{ getAccountName(tx.type === 'expense' ? tx.sourceAccountId : tx.targetAccountId) }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div :class="getAmountColor(tx.type)" class="font-bold text-lg">
                        {{ tx.type === 'expense' ? '-' : (tx.type === 'income' ? '+' : '') }}{{ formatCurrency(tx.amount) }}
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'assets'" class="p-4 space-y-4 pb-20">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg">
                <div class="opacity-80 text-sm">å‡€èµ„äº§æ€»é¢</div>
                <div class="text-3xl font-bold mt-1">{{ formatCurrency(netWorth) }}</div>
            </div>

            <div>
                <div class="text-gray-500 text-sm ml-2 mb-2 font-bold flex justify-between items-center">
                    èµ„é‡‘è´¦æˆ· (Cash & Banks)
                    <button @click="addNewAccount('asset')" class="text-blue-500 text-xs">æ·»åŠ </button>
                </div>
                <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                    <div v-for="acc in assetAccounts" :key="acc.id" class="p-4 border-b last:border-b-0 flex justify-between active:bg-gray-50">
                        <div>{{ acc.name }}</div>
                        <div class="font-semibold">{{ formatCurrency(acc.balance) }}</div>
                    </div>
                </div>
            </div>

            <div>
                <div class="text-gray-500 text-sm ml-2 mb-2 font-bold flex justify-between items-center">
                    ä¿¡ç”¨è´¦æˆ· (Credit & Loans)
                    <button @click="addNewAccount('liability')" class="text-blue-500 text-xs">æ·»åŠ </button>
                </div>
                <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                    <div v-for="acc in liabilityAccounts" :key="acc.id" class="p-4 border-b last:border-b-0 flex justify-between active:bg-gray-50">
                        <div>{{ acc.name }}</div>
                        <div class="font-semibold text-red-500">{{ formatCurrency(acc.balance) }}</div>
                    </div>
                </div>
            </div>
            
             <div>
                <div class="text-gray-500 text-sm ml-2 mb-2 font-bold flex justify-between items-center">
                    æŠ•èµ„è´¦æˆ· (Investments)
                    <button @click="addNewAccount('investment')" class="text-blue-500 text-xs">æ·»åŠ </button>
                </div>
                <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                    <div v-for="acc in investmentAccounts" :key="acc.id" class="p-4 border-b last:border-b-0 flex justify-between items-center active:bg-gray-50">
                        <div>
                            <div>{{ acc.name }}</div>
                            <div class="text-xs text-gray-400" v-if="acc.quantity > 0">æŒæœ‰: {{ acc.quantity }} ä»½/è‚¡</div>
                        </div>
                        <div class="font-semibold text-blue-600">{{ formatCurrency(acc.balance) }}</div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <nav class="bg-white border-t safe-pb flex justify-around items-center text-gray-400 text-[10px] font-medium h-16 z-10">
        <button @click="currentTab = 'timeline'" :class="{'text-blue-600': currentTab === 'timeline'}" class="flex-1 flex flex-col items-center justify-center h-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
            æ˜ç»†
        </button>
        <button @click="currentTab = 'assets'" :class="{'text-blue-600': currentTab === 'assets'}" class="flex-1 flex flex-col items-center justify-center h-full">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
            èµ„äº§
        </button>
        
        <div class="flex-1 flex justify-center items-center h-full relative top-[-12px]">
            <button @click="openRecordModal" class="bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg active:scale-95 transition-transform border-4 border-[#f2f2f7]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
            </button>
        </div>

        <button class="flex-1 flex flex-col items-center justify-center h-full">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 8v8m-4-5v5m-4-3v3m2 2h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            å›¾è¡¨
        </button>
        <button class="flex-1 flex flex-col items-center justify-center h-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            è®¾ç½®
        </button>
    </nav>

    <div v-if="showRecordModal" class="fixed inset-0 z-20 bg-black/40 flex flex-col justify-end backdrop-blur-sm transition-opacity">
        <div class="flex-1" @click="showRecordModal = false"></div>
        
        <div class="bg-white rounded-t-3xl shadow-2xl overflow-hidden safe-pb">
            <div class="flex justify-center pt-3 pb-1"><div class="w-10 h-1 bg-gray-200 rounded-full"></div></div>
            
            <div class="flex p-2 px-4 gap-2">
                <button v-for="type in ['expense', 'income', 'transfer']" 
                    @click="recordForm.type = type"
                    :class="recordForm.type === type ? (type==='expense'?'bg-red-100 text-red-600':(type==='income'?'bg-green-100 text-green-600':'bg-blue-100 text-blue-600')) : 'bg-gray-100 text-gray-500'"
                    class="flex-1 py-2.5 text-center font-bold rounded-xl transition-colors">
                    {{ type === 'expense' ? 'æ”¯å‡º' : (type === 'income' ? 'æ”¶å…¥' : 'è½¬è´¦') }}
                </button>
            </div>

            <div class="px-4 py-2 flex flex-col gap-3">
                 <div v-if="recordForm.type === 'transfer'" class="flex items-center gap-2 bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div class="flex-1">
                        <div class="text-xs text-gray-400 mb-1">ä» (æµå‡º)</div>
                        <select v-model="recordForm.sourceAccountId" class="w-full bg-transparent font-semibold">
                            <option v-for="acc in assetAccounts" :value="acc.id">{{ acc.name }} ({{formatCurrency(acc.balance)}})</option>
                        </select>
                    </div>
                    <div class="text-gray-400">â†’</div>
                    <div class="flex-1">
                        <div class="text-xs text-gray-400 mb-1">åˆ° (æµå…¥/è¿˜æ¬¾)</div>
                        <select v-model="recordForm.targetAccountId" class="w-full bg-transparent font-semibold">
                            <option v-for="acc in allAccounts" :value="acc.id" :key="acc.id" :disabled="acc.id === recordForm.sourceAccountId">
                                {{ acc.name }} ({{formatCurrency(acc.balance)}})
                            </option>
                        </select>
                    </div>
                </div>
                
                 <div v-else class="flex gap-3">
                     <div class="bg-gray-100 rounded-xl p-3 flex-1 flex items-center gap-2">
                        <span class="text-gray-500">è´¦æˆ·:</span>
                        <select v-model="recordForm.sourceAccountId" class="bg-transparent font-semibold flex-1 outline-none">
                            <option v-for="acc in availableAccountsForType" :value="acc.id">{{ acc.name }}</option>
                        </select>
                    </div>
                    <div class="bg-gray-100 rounded-xl p-3 flex-1 flex items-center gap-2">
                         <span class="text-gray-500">åˆ†ç±»:</span>
                         <input v-model="recordForm.category" type="text" class="bg-transparent font-semibold flex-1 outline-none" placeholder="ä¾‹å¦‚: åˆé¤">
                    </div>
                </div>
                
                 <div v-if="isInvestmentTransaction" class="bg-blue-50 p-3 rounded-xl flex items-center gap-2 text-blue-800 border border-blue-100">
                    <span>ä»½é¢/è‚¡æ•°å˜æ›´:</span>
                    <input v-model="recordForm.quantityChange" type="number" step="0.01" placeholder="ä¾‹å¦‚: +100 æˆ– -100" class="bg-transparent font-semibold flex-1 outline-none">
                </div>
            </div>

            <div class="px-6 py-4 text-right border-t border-b flex items-end justify-between bg-gray-50">
                <span class="text-2xl font-bold text-gray-400">Â¥</span>
                <span class="text-5xl font-bold tracking-tight" :class="{'text-red-500': recordForm.type === 'expense', 'text-green-500': recordForm.type === 'income', 'text-blue-500': recordForm.type === 'transfer'}">
                    {{ keypadValue || '0.00' }}
                </span>
            </div>

            <div class="grid grid-cols-4 bg-white p-1 safe-pb">
                <button v-for="key in ['7','8','9','Del','4','5','6','+','1','2','3','-','.','0','OK']" 
                    :key="key"
                    @click="handleKeypadPress(key)"
                    :class="{'row-span-2 bg-blue-600 text-white text-xl': key === 'OK', 'text-blue-500 bg-blue-50': ['+','-'].includes(key), 'bg-white': !['OK','+','-'].includes(key)}"
                    class="h-14 m-1 rounded-xl font-bold text-2xl shadow-sm border border-gray-100 flex items-center justify-center active:bg-gray-100 transition-colors">
                    {{ key === 'Del' ? 'â†' : key }}
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, reactive } = Vue;
    const Decimal = decimal.Decimal; // å¼•å…¥é‡‘èè®¡ç®—åº“

    // --- 1. æœ¬åœ°æ•°æ®åº“åˆå§‹åŒ– (Dexie.js) ---
    // æ•°æ®å­˜å‚¨åœ¨æ‰‹æœºæœ¬åœ° IndexedDBï¼Œç»å¯¹å®‰å…¨ä¿å¯†
    const db = new Dexie("iCostReplicaDB_V2");
    db.version(1).stores({
        // accountType: 'asset' | 'liability' | 'investment'
        accounts: "++id, name, type, balance, quantity", 
        // type: 'expense' | 'income' | 'transfer'
        transactions: "++id, date, type, amount, sourceAccountId, targetAccountId, category, quantityChange"
    });

    const app = createApp({
        setup() {
            // --- çŠ¶æ€ç®¡ç† ---
            const currentTab = ref('timeline');
            const showRecordModal = ref(false);
            const allAccounts = ref([]);
            const recentTransactions = ref([]);
            
            // è®°è´¦è¡¨å•çŠ¶æ€
            const keypadValue = ref('');
            const recordForm = reactive({
                type: 'expense',
                sourceAccountId: null,
                targetAccountId: null,
                category: 'ä¸€èˆ¬',
                quantityChange: null, // ç”¨äºæŠ•èµ„
            });

            // --- 2. æ ¸å¿ƒé€»è¾‘ (CPA é‡ç‚¹å…³æ³¨) ---

            // åˆå§‹åŒ–æ•°æ®åŠ è½½
            const loadData = async () => {
                allAccounts.value = await db.accounts.toArray();
                recentTransactions.value = (await db.transactions.orderBy('date').reverse().limit(50).toArray());

                // é¦–æ¬¡è¿è¡Œï¼šé¢„è®¾ä¸€äº›è´¦æˆ· (è§£å†³ç—›ç‚¹1ï¼šä¸èƒ½éšæ„æ·»åŠ )
                if (allAccounts.value.length === 0) {
                    await db.accounts.bulkAdd([
                        { name: "æ‹›å•†å‚¨è“„å¡", type: 'asset', balance: 10000.00, quantity: 0 },
                        { name: "å¾®ä¿¡é›¶é’±", type: 'asset', balance: 500.50, quantity: 0 },
                        // è´Ÿå€ºè´¦æˆ·ï¼šä½™é¢é€šå¸¸ä¸ºè´Ÿæ•°ï¼Œè¡¨ç¤ºæ¬ æ¬¾
                        { name: "æ‹›è¡Œä¿¡ç”¨å¡", type: 'liability', balance: -2500.00, quantity: 0 },
                        { name: "èš‚èšèŠ±å‘—", type: 'liability', balance: -800.00, quantity: 0 },
                        // æŠ•èµ„è´¦æˆ·ï¼šæ”¯æŒè®°å½•ä»½é¢ (è§£å†³ç—›ç‚¹3)
                        { name: "åå¤åŸºé‡‘", type: 'investment', balance: 5000.00, quantity: 2500.00 }
                    ]);
                    await loadData();
                    // è®¾ç½®é»˜è®¤é€‰ä¸­é¡¹
                    recordForm.sourceAccountId = assetAccounts.value[0]?.id;
                }
            };

            // é”®ç›˜è¾“å…¥å¤„ç† (æ”¯æŒç®€å•è®¡ç®—)
            const handleKeypadPress = (key) => {
                if (key === 'OK') {
                    submitTransaction();
                } else if (key === 'Del') {
                    keypadValue.value = keypadValue.value.toString().slice(0, -1);
                } else if (['+','-'].includes(key)) {
                    // ç®€å•å®ç°ï¼šå¦‚æœè¾“å…¥äº†è¿ç®—ç¬¦ï¼Œå…ˆè®¡ç®—å½“å‰ç»“æœï¼Œå†ç­‰å¾…ä¸‹ä¸€ä¸ªæ•°å­—
                    // å®é™… iCost é€»è¾‘æ›´å¤æ‚ï¼Œè¿™é‡Œä¸ºæ¼”ç¤ºç®€åŒ–å¤„ç†
                    try {
                         // ä½¿ç”¨ eval å‰è¿›è¡Œä¸¥æ ¼æ ¡éªŒï¼Œé˜²æ­¢å®‰å…¨é—®é¢˜ã€‚è¿™é‡Œä»…å…è®¸æ•°å­—å’ŒåŠ å‡ç‚¹
                        if (/^[\d.+\-]+$/.test(keypadValue.value)) {
                            // ä½¿ç”¨ Decimal è¿›è¡Œè®¡ç®—ä»¥ä¿è¯ç²¾åº¦
                             const parts = keypadValue.value.split(/([+\-])/);
                             let result = new Decimal(parts[0] || 0);
                             for(let i=1; i<parts.length; i+=2) {
                                 const op = parts[i];
                                 const val = new Decimal(parts[i+1] || 0);
                                 if(op === '+') result = result.plus(val);
                                 if(op === '-') result = result.minus(val);
                             }
                             keypadValue.value = result.toString();
                        }
                    } catch (e) { keypadValue.value = 'Error'; }
                } else {
                    // é˜²æ­¢å¤šä¸ªå°æ•°ç‚¹
                    if (key === '.' && keypadValue.value.includes('.')) return;
                    // é™åˆ¶å°æ•°ä½ (è§£å†³ç—›ç‚¹2ï¼šæ— é™å°æ•°åœ¨è¾“å…¥ç«¯çš„æ§åˆ¶)
                    if (keypadValue.value.includes('.') && keypadValue.value.split('.')[1].length >= 2) return;
                    keypadValue.value += key;
                }
            };

            // --- æ ¸å¿ƒæäº¤é€»è¾‘ (è§£å†³æ‰€æœ‰ç—›ç‚¹çš„å…³é”®) ---
            const submitTransaction = async () => {
                // ä½¿ç”¨ Decimal å¤„ç†é‡‘é¢ï¼Œæœç»æµ®ç‚¹è¯¯å·® (è§£å†³ç—›ç‚¹2)
                const amount = new Decimal(keypadValue.value || 0);
                if (amount.isZero() || amount.isNegative()) {
                    alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢"); return;
                }

                const txData = {
                    date: new Date(),
                    type: recordForm.type,
                    amount: amount.toNumber(), // å­˜å…¥æ•°æ®åº“æ—¶è½¬ä¸º Numberï¼Œä½†è®¡ç®—è¿‡ç¨‹å…¨æ˜¯ Decimal
                    category: recordForm.category,
                    sourceAccountId: recordForm.sourceAccountId,
                    targetAccountId: recordForm.targetAccountId,
                    quantityChange: recordForm.quantityChange ? parseFloat(recordForm.quantityChange) : null
                };

                // ACID äº‹åŠ¡ï¼šç¡®ä¿æµæ°´è®°å½•å’Œè´¦æˆ·ä½™é¢åŒæ—¶æ›´æ–°æˆåŠŸï¼Œå¦åˆ™å›æ»š
                await db.transaction('rw', db.accounts, db.transactions, async () => {
                    // 1. å†™å…¥æµæ°´
                    await db.transactions.add(txData);

                    // 2. æ›´æ–°è´¦æˆ·ä½™é¢ (CPA å€Ÿè´·é€»è¾‘)
                    if (recordForm.type === 'expense') {
                        // æ”¯å‡ºï¼šèµ„äº§å‡å°‘
                        const acc = await db.accounts.get(recordForm.sourceAccountId);
                        const newBalance = new Decimal(acc.balance).minus(amount);
                        await db.accounts.update(acc.id, { balance: newBalance.toNumber() });
                    } 
                    else if (recordForm.type === 'income') {
                         // æ”¶å…¥ï¼šèµ„äº§å¢åŠ 
                        const acc = await db.accounts.get(recordForm.sourceAccountId);
                        const newBalance = new Decimal(acc.balance).plus(amount);
                        await db.accounts.update(acc.id, { balance: newBalance.toNumber() });
                    }
                    else if (recordForm.type === 'transfer') {
                        // è½¬è´¦/è¿˜æ¬¾ (è§£å†³ç—›ç‚¹2çš„æ ¸å¿ƒ)ï¼šSource å‡å°‘ï¼ŒTarget å¢åŠ 
                        // ä¾‹ï¼šå‚¨è“„å¡(1ä¸‡) è½¬ 2500 åˆ° ä¿¡ç”¨å¡(-2500)ã€‚
                        // å‚¨è“„å¡å˜ 7500ï¼Œä¿¡ç”¨å¡å˜ 0ã€‚å®Œç¾å¹³è´¦ã€‚
                        if (!recordForm.sourceAccountId || !recordForm.targetAccountId) { throw new Error("è¯·é€‰æ‹©è½¬å…¥è½¬å‡ºè´¦æˆ·"); }
                        
                        const source = await db.accounts.get(recordForm.sourceAccountId);
                        const target = await db.accounts.get(recordForm.targetAccountId);

                        const newSourceBal = new Decimal(source.balance).minus(amount);
                        const newTargetBal = new Decimal(target.balance).plus(amount);

                        await db.accounts.update(source.id, { balance: newSourceBal.toNumber() });
                        await db.accounts.update(target.id, { balance: newTargetBal.toNumber() });
                    }

                    // 3. æ›´æ–°æŠ•èµ„æ•°é‡ (è§£å†³ç—›ç‚¹3)
                    if (isInvestmentTransaction.value && recordForm.quantityChange) {
                         // å‡è®¾æ˜¯å¯¹ source è´¦æˆ·è¿›è¡Œä»½é¢å˜æ›´
                         const acc = await db.accounts.get(recordForm.sourceAccountId);
                         // ä½¿ç”¨ Decimal ç¡®ä¿ä»½é¢è®¡ç®—ä¹Ÿç²¾ç¡®
                         const newQuantity = new Decimal(acc.quantity || 0).plus(new Decimal(recordForm.quantityChange));
                         await db.accounts.update(acc.id, { quantity: newQuantity.toNumber() });
                    }
                });

                // é‡ç½®ç•Œé¢
                closeModal();
                await loadData();
            };

            // --- UI è¾…åŠ©å‡½æ•°ä¸è®¡ç®—å±æ€§ ---
            
            // æ‰“å¼€è®°è´¦é¢æ¿
            const openRecordModal = () => {
                keypadValue.value = '';
                recordForm.category = 'ä¸€èˆ¬';
                // æ™ºèƒ½è®¾ç½®é»˜è®¤è´¦æˆ·
                if (recordForm.type === 'transfer' && assetAccounts.value.length > 0 && liabilityAccounts.value.length > 0) {
                    recordForm.sourceAccountId = assetAccounts.value[0].id;
                    recordForm.targetAccountId = liabilityAccounts.value[0].id;
                }
                showRecordModal.value = true;
            };

            const closeModal = () => {
                 showRecordModal.value = false;
            }
            
            // æ·»åŠ æ–°è´¦æˆ· (è§£å†³ç—›ç‚¹1)
            const addNewAccount = async (type) => {
                const name = prompt("è¯·è¾“å…¥è´¦æˆ·åç§° (ä¾‹å¦‚: äº¤é€šé“¶è¡Œä¿¡ç”¨å¡)");
                if (name) {
                    // è´Ÿå€ºè´¦æˆ·åˆå§‹é»˜è®¤ç»™ä¸ªè´Ÿæ•°ä½™é¢ç¤ºèŒƒ
                    const initialBalance = type === 'liability' ? -1000.00 : 0.00;
                    await db.accounts.add({ name, type, balance: initialBalance, quantity: 0 });
                    await loadData();
                }
            };

            // è®¡ç®—å±æ€§ï¼šè´¦æˆ·åˆ†ç±»
            const assetAccounts = computed(() => allAccounts.value.filter(a => a.type === 'asset'));
            const liabilityAccounts = computed(() => allAccounts.value.filter(a => a.type === 'liability'));
            const investmentAccounts = computed(() => allAccounts.value.filter(a => a.type === 'investment'));
            
            // è®¡ç®—å±æ€§ï¼šæ ¹æ®è®°è´¦ç±»å‹å†³å®šå¯é€‰è´¦æˆ·
            const availableAccountsForType = computed(() => {
                // æ”¯å‡º/æ”¶å…¥å…è®¸é€‰æ‹©èµ„äº§å’Œè´Ÿå€ºè´¦æˆ·ï¼ˆæ¯”å¦‚ç”¨ä¿¡ç”¨å¡ç›´æ¥æ¶ˆè´¹ï¼‰
                return [...assetAccounts.value, ...liabilityAccounts.value];
            });

             // åˆ¤æ–­æ˜¯å¦æ¶‰åŠæŠ•èµ„è´¦æˆ·äº¤æ˜“
            const isInvestmentTransaction = computed(() => {
                if (!recordForm.sourceAccountId) return false;
                const acc = allAccounts.value.find(a => a.id === recordForm.sourceAccountId);
                return acc && acc.type === 'investment';
            });

            // è®¡ç®—å±æ€§ï¼šè´¢åŠ¡æŒ‡æ ‡
            // ä½¿ç”¨ Decimal.js è¿›è¡Œæ±‡æ€»è®¡ç®—ï¼Œç¡®ä¿æŠ¥è¡¨æ— å»¶è¿Ÿä¸”ç²¾å‡† (è§£å†³ç—›ç‚¹4)
            const netWorth = computed(() => {
                return allAccounts.value.reduce((sum, acc) => sum.plus(new Decimal(acc.balance)), new Decimal(0)).toNumber();
            });

            // ç®€å•è®¡ç®—æœ¬æœˆæ”¶æ”¯ (å®é™…åº”ç”¨åº”ç”¨æ—¥æœŸç­›é€‰)
            const monthlyIncome = computed(() => {
                 return recentTransactions.value.filter(t => t.type === 'income')
                    .reduce((sum, t) => sum.plus(new Decimal(t.amount)), new Decimal(0)).toNumber();
            });
            const monthlyExpense = computed(() => {
                 return recentTransactions.value.filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum.plus(new Decimal(t.amount)), new Decimal(0)).toNumber();
            });
            const monthlyBalance = computed(() => new Decimal(monthlyIncome.value).minus(new Decimal(monthlyExpense.value)).toNumber());

            // æ ¼å¼åŒ–å·¥å…·
            const formatCurrency = (val) => {
                 // å¼ºåˆ¶ä¿ç•™ä¸¤ä½å°æ•°ï¼Œè§£å†³ç—›ç‚¹2çš„æ˜¾ç¤ºé—®é¢˜
                return new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY' }).format(val);
            };
            const formatDate = (date) => new Date(date).toLocaleDateString('zh-CN', {month: 'short', day: 'numeric'});
            const getCategoryIcon = (cat) => { const map = {'é¤é¥®': 'ğŸ”', 'äº¤é€š': 'ğŸš—', 'è´­ç‰©': 'ğŸ›ï¸', 'å·¥èµ„': 'ğŸ’°'}; return map[cat] || 'ğŸ·ï¸'; };
            const getAccountName = (id) => allAccounts.value.find(a => a.id === id)?.name || 'æœªçŸ¥è´¦æˆ·';
            const getAmountColor = (type) => ({'expense': 'text-gray-800', 'income': 'text-green-600', 'transfer': 'text-gray-400'}[type]);

            onMounted(loadData);

            return {
                currentTab, showRecordModal, allAccounts, recentTransactions, recordForm, keypadValue,
                assetAccounts, liabilityAccounts, investmentAccounts, availableAccountsForType, isInvestmentTransaction,
                netWorth, monthlyIncome, monthlyExpense, monthlyBalance,
                openRecordModal, closeModal, handleKeypadPress, addNewAccount,
                formatCurrency, formatDate, getCategoryIcon, getAccountName, getAmountColor
            };
        }
    }).mount('#app');
</script>
</body>
</html>
