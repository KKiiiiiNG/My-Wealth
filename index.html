<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f8fafc">
    <title>èµ„äº§ç®¡å®¶ V12.1 (Debug)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; color: #334155; -webkit-tap-highlight-color: transparent; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .card { background: white; border-radius: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .text-income { color: #ef4444; } .text-expense { color: #10b981; }
        .nav-item-active { color: #2563eb; font-weight: bold; }
        .nav-item-inactive { color: #94a3b8; }
        ::-webkit-scrollbar { width: 0px; }
        
        /* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app" class="h-screen w-full flex flex-col bg-slate-50 overflow-hidden">

    <!-- ================= 1. ç™»å½• ================= -->
    <div v-if="!isUnlocked" class="fixed inset-0 z-50 bg-slate-100 flex flex-col items-center justify-center p-6">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center">
            <div class="text-6xl mb-4">ğŸ”§</div>
            <h1 class="text-2xl font-bold text-slate-800">èµ„äº§ç®¡å®¶ V12.1</h1>
            <p class="text-xs text-slate-500 mb-8">åŒæ­¥è¯Šæ–­ Â· é”™è¯¯æ˜¾å½¢</p>
            <div class="space-y-4">
                <input type="password" v-model="passwordInput" placeholder="è¾“å…¥ä¸»å¯†ç " class="w-full bg-slate-50 border rounded-xl p-4 text-center text-lg font-bold outline-none focus:border-blue-500">
                <button @click="unlock" class="w-full py-4 rounded-xl font-bold text-white shadow-lg text-lg bg-gradient-to-r from-blue-600 to-indigo-600 active:scale-95 transition">
                    {{ hasLocalData ? 'è§£é”è¿›å…¥' : 'è®¾ç½®å¯†ç å¹¶å¼€å§‹' }}
                </button>
            </div>
            <div class="mt-8 pt-4 border-t border-slate-100">
                <button @click="showImport=!showImport" class="text-xs text-slate-400 underline">ä»å¤‡ä»½æ¢å¤</button>
                <div v-if="showImport" class="mt-2"><textarea v-model="importString" class="w-full h-16 text-[10px] bg-slate-50 p-2 rounded border" placeholder="ç²˜è´´åŠ å¯†ä¸²..."></textarea><button @click="importData" class="mt-2 w-full py-2 bg-white border text-xs rounded font-bold">æ¢å¤</button></div>
            </div>
        </div>
    </div>

    <!-- ================= 2. ä¸»ç¨‹åº ================= -->
    <div v-else class="flex-1 flex flex-col h-full overflow-hidden">
        
        <!-- å†…å®¹åŒºåŸŸ (æ ¹æ® Tab åˆ‡æ¢) -->
        <main class="flex-1 overflow-y-auto bg-slate-50 pb-20">
            
            <!-- >>>>>> é¡µé¢ A: èµ„äº§ (Home) <<<<<< -->
            <div v-if="currentTab === 'home'" class="p-4 space-y-4 animate-fade-in">
                <!-- é¡¶éƒ¨æ€»èµ„äº§ -->
                <div class="bg-white rounded-[24px] p-6 shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div><p class="text-[10px] text-slate-400 font-bold uppercase">NET WORTH</p><h1 class="text-3xl font-black text-slate-800">Â¥{{ formatNumber(netWorth) }}</h1></div>
                        <div class="flex items-center gap-1 bg-slate-50 px-2 py-1 rounded-full border border-slate-100">
                            <div class="w-2 h-2 rounded-full" :class="syncStatusColor"></div>
                            <span class="text-[10px] text-slate-400">{{ syncStatusText }}</span>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-4">
                        <div class="flex-1 bg-red-50 rounded-lg p-2 border border-red-100"><span class="text-[10px] text-red-400 block">æœ¬æœˆæ”¶å…¥</span><span class="font-bold text-red-600">Â¥{{ formatNumber(monthlyStats.income) }}</span></div>
                        <div class="flex-1 bg-emerald-50 rounded-lg p-2 border border-emerald-100"><span class="text-[10px] text-emerald-400 block">æœ¬æœˆæ”¯å‡º</span><span class="font-bold text-emerald-600">Â¥{{ formatNumber(monthlyStats.expense) }}</span></div>
                    </div>
                </div>

                <!-- èµ„äº§åˆ—è¡¨ -->
                <div class="space-y-3">
                    <!-- ç°é‡‘ç»„ -->
                    <div class="card">
                        <div class="p-3 flex justify-between items-center" @click="ui.cashOpen=!ui.cashOpen">
                            <div class="flex items-center gap-3"><span class="text-xl">ğŸ‘›</span><div><div class="font-bold text-sm">ç°é‡‘ & æ´»æœŸ</div><div class="text-[10px] text-slate-400">Â¥{{formatNumber(cashTotal)}}</div></div></div>
                            <span class="text-xs text-slate-300">â–¼</span>
                        </div>
                        <div v-if="ui.cashOpen" class="bg-slate-50 p-3 space-y-2 border-t border-slate-100">
                            <div class="flex justify-between text-xs"><span class="text-slate-500">ç°é‡‘é’±åŒ…</span><span class="font-bold">Â¥{{formatNumber(assets.cash)}}</span></div>
                            <div class="flex justify-between text-xs"><span class="text-slate-500">å‚¨è“„å¡</span><span class="font-bold">Â¥{{formatNumber(assets.debit)}}</span></div>
                        </div>
                    </div>
                    <!-- ä¿¡ç”¨å¡ -->
                    <div class="card">
                        <div class="p-3 flex justify-between items-center" @click="ui.creditOpen=!ui.creditOpen">
                            <div class="flex items-center gap-3"><span class="text-xl">ğŸ’³</span><div><div class="font-bold text-sm">ä¿¡ç”¨å¡</div><div class="text-[10px] text-slate-400">è´Ÿå€º: <span class="text-emerald-500">Â¥{{formatNumber(creditTotal)}}</span></div></div></div>
                            <span class="text-xs text-slate-300">â–¼</span>
                        </div>
                        <div v-if="ui.creditOpen" class="bg-slate-50 p-3 space-y-3 border-t border-slate-100">
                            <div v-for="(cc,i) in creditCards" :key="cc.id" class="bg-white p-2 rounded border border-slate-200">
                                <div class="flex justify-between mb-1"><span class="font-bold text-xs">{{cc.name}}</span><button @click="creditCards.splice(i,1)" class="text-[10px] text-red-300">åˆ é™¤</button></div>
                                <div class="flex justify-between text-xs mb-1"><span class="text-slate-400">å®æ—¶è´¦å•</span><span class="font-bold text-emerald-500">{{formatNumber(cc.currentBalance)}}</span></div>
                                <div v-for="inst in cc.installments" class="flex justify-between text-[10px] text-slate-500 border-t border-dashed pt-1"><span>{{inst.name}} (æœˆä¾›)</span><span>{{Math.round(inst.monthlyAmount)}}</span></div>
                                <button @click="addInstallment(cc)" class="text-[10px] text-blue-400 mt-1">+ åˆ†æœŸ</button>
                            </div>
                            <button @click="addCreditCard" class="w-full py-1 text-xs text-slate-400 border border-dashed rounded">+ æ·»åŠ å¡ç‰‡</button>
                        </div>
                    </div>
                    <!-- å…¶ä»–èµ„äº§ -->
                    <div class="grid grid-cols-3 gap-2">
                        <div class="card p-2 text-center active:scale-95 transition" @click="ui.stockOpen=!ui.stockOpen"><div class="text-lg">ğŸ“ˆ</div><div class="text-[10px] text-slate-400">è‚¡ç¥¨</div><div class="text-xs font-bold text-amber-500">Â¥{{formatNumber(stockTotal)}}</div></div>
                        <div class="card p-2 text-center active:scale-95 transition" @click="ui.depositOpen=!ui.depositOpen"><div class="text-lg">ğŸ¦</div><div class="text-[10px] text-slate-400">å®šæœŸ</div><div class="text-xs font-bold">Â¥{{formatNumber(depositTotal)}}</div></div>
                        <div class="card p-2 text-center active:scale-95 transition" @click="ui.loanOpen=!ui.loanOpen"><div class="text-lg">ğŸ </div><div class="text-[10px] text-slate-400">è´·æ¬¾</div><div class="text-xs font-bold text-emerald-500">-Â¥{{formatNumber(loanTotal)}}</div></div>
                    </div>
                    <!-- ç®€æ˜“ç®¡ç†å…¥å£ -->
                    <div v-if="ui.stockOpen" class="card p-3 bg-slate-50"><div v-for="(s,i) in stocks" :key="i" class="flex justify-between text-xs mb-2 bg-white p-2 rounded border"><span>{{s.name}}</span><span>Â¥{{formatNumber(s.shares*s.price)}}</span><button @click="stocks.splice(i,1)" class="text-red-300">Ã—</button></div><button @click="stocks.push({id:Date.now(),name:'æ–°è‚¡ç¥¨',code:'',shares:0,price:0})" class="text-xs text-blue-500 w-full">+ è‚¡ç¥¨</button></div>
                    <div v-if="ui.depositOpen" class="card p-3 bg-slate-50"><div v-for="(d,i) in deposits" :key="i" class="flex justify-between text-xs mb-2 bg-white p-2 rounded border"><span>{{d.name}}</span><span>Â¥{{formatNumber(d.amount)}}</span><button @click="deposits.splice(i,1)" class="text-red-300">Ã—</button></div><button @click="deposits.push({name:'æ–°å­˜å•',amount:0})" class="text-xs text-blue-500 w-full">+ å­˜å•</button></div>
                    <div v-if="ui.loanOpen" class="card p-3 bg-slate-50"><div v-for="(l,i) in loans" :key="i" class="flex justify-between text-xs mb-2 bg-white p-2 rounded border"><span>{{l.name}}</span><span>-Â¥{{formatNumber(l.total)}}</span><button @click="loans.splice(i,1)" class="text-red-300">Ã—</button></div><button @click="loans.push({id:Date.now(),name:'æ–°è´·æ¬¾',total:0,years:20,monthlyPayment:0})" class="text-xs text-blue-500 w-full">+ è´·æ¬¾</button></div>
                </div>

                <!-- è¿‘æœŸè´¦å• -->
                <div class="pt-4">
                    <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-slate-700 text-sm">è´¦å•æµæ°´</h3><span class="text-[10px] text-slate-400">æœ€è¿‘ 10 ç¬”</span></div>
                    <div class="space-y-2">
                        <div v-for="tx in recentTransactions" :key="tx.id" @click="openTxModal(tx)" class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm active:bg-slate-50">
                            <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full flex items-center justify-center text-sm" :class="tx.type==='income'?'bg-red-50':'bg-emerald-50'">{{ tx.icon }}</div><div><div class="font-bold text-slate-700 text-xs">{{ tx.category }}</div><div class="text-[10px] text-slate-400">{{ tx.date.slice(5) }} Â· {{ getAccountName(tx.accountId) }}</div></div></div>
                            <span class="font-bold text-sm font-mono" :class="tx.type==='income'?'text-income':'text-expense'">{{ tx.type==='income' ? '+' : '-' }}{{ formatNumber(tx.amount) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- >>>>>> é¡µé¢ B: æŠ¥è¡¨ (Stats) <<<<<< -->
            <div v-else-if="currentTab === 'stats'" class="p-4 space-y-4 animate-fade-in">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="font-bold text-lg text-slate-800">æ”¶æ”¯æŠ¥è¡¨</h2>
                    <div class="flex bg-white p-1 rounded-lg border border-slate-100">
                        <button @click="statsRange='month'; renderStats()" :class="statsRange==='month'?'bg-blue-50 text-blue-600 font-bold':''" class="px-3 py-1 rounded text-xs transition">æœ¬æœˆ</button>
                        <button @click="statsRange='last_month'; renderStats()" :class="statsRange==='last_month'?'bg-blue-50 text-blue-600 font-bold':''" class="px-3 py-1 rounded text-xs transition">ä¸Šæœˆ</button>
                    </div>
                </div>

                <!-- é¥¼å›¾ï¼šæ”¯å‡ºæ„æˆ -->
                <div class="card p-4">
                    <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase">æ”¯å‡ºæ„æˆ (TOP 5)</h3>
                    <div class="h-48 relative"><canvas id="pieChart"></canvas></div>
                </div>

                <!-- æŸ±çŠ¶å›¾ï¼šæ”¶æ”¯å¯¹æ¯” -->
                <div class="card p-4">
                    <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase">æ¯æ—¥æ”¶æ”¯è¶‹åŠ¿</h3>
                    <div class="h-40 relative"><canvas id="barChart"></canvas></div>
                </div>

                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="card p-4 text-center"><p class="text-[10px] text-slate-400">æœŸé—´æ€»æ”¶å…¥</p><p class="text-lg font-bold text-red-500">Â¥{{formatNumber(statsData.totalIncome)}}</p></div>
                    <div class="card p-4 text-center"><p class="text-[10px] text-slate-400">æœŸé—´æ€»æ”¯å‡º</p><p class="text-lg font-bold text-emerald-500">Â¥{{formatNumber(statsData.totalExpense)}}</p></div>
                </div>
            </div>

            <!-- >>>>>> é¡µé¢ C: è®¾ç½® (Settings) <<<<<< -->
            <div v-else-if="currentTab === 'settings'" class="p-4 space-y-4 animate-fade-in">
                <h2 class="font-bold text-lg text-slate-800 mb-2">è®¾ç½®ä¸åŒæ­¥</h2>
                
                <!-- äº‘åŒæ­¥å¡ç‰‡ -->
                <div class="card p-4">
                    <h3 class="font-bold text-sm mb-2 flex items-center gap-2">â˜ï¸ äº‘åŒæ­¥é…ç½® <span class="text-[10px] px-2 py-0.5 rounded bg-slate-100" :class="cloudConfigured?'text-green-500':'text-slate-400'">{{cloudConfigured?'å·²è¿æ¥':'æœªé…ç½®'}}</span></h3>
                    
                    <div v-if="!cloudConfigured" class="space-y-3">
                        <div class="p-3 bg-blue-50 border border-blue-100 rounded-lg text-xs text-slate-600 leading-relaxed">
                            <p class="font-bold mb-1 text-blue-700">å¦‚ä½•è·å–é…ç½®ï¼Ÿ</p>
                            <ol class="list-decimal pl-4 space-y-1">
                                <li>ç™»å½• <a href="https://console.firebase.google.com" target="_blank" class="text-blue-500 underline">Firebase</a>ï¼Œæ–°å»ºé¡¹ç›®ã€‚</li>
                                <li>ç‚¹å‡» <b>Create Database</b>ï¼Œé€‰æ‹© <b>Test Mode</b> (æµ‹è¯•æ¨¡å¼)ï¼Œå¦åˆ™æ— æ³•åŒæ­¥ã€‚</li>
                                <li>è¿›å…¥ Project Settingsï¼Œåœ¨åº•éƒ¨æ³¨å†Œ Web Appï¼Œå¤åˆ¶ <code class="bg-white px-1">const firebaseConfig = {...}</code> é‡Œçš„å†…å®¹ã€‚</li>
                            </ol>
                        </div>
                        <textarea v-model="firebaseConfigInput" class="w-full h-24 text-[10px] bg-slate-50 p-2 rounded border resize-none font-mono" placeholder='{ "apiKey": "...", "authDomain": "...", ... }'></textarea>
                        <div class="flex gap-2">
                            <input v-model="syncId" class="flex-1 bg-slate-50 p-2 rounded border text-xs" placeholder="åŒæ­¥ID (å¦‚æ‰‹æœºå·)">
                            <button @click="saveCloudConfig" class="bg-blue-600 text-white px-4 rounded text-xs font-bold">ä¿å­˜</button>
                        </div>
                    </div>
                    <div v-else class="text-center py-4">
                        <p class="text-xs text-slate-500 mb-4">å·²è¿æ¥è‡³åŒæ­¥ID: <b>{{syncId}}</b></p>
                        <button @click="forceSync" class="w-full py-2 bg-blue-50 text-blue-600 font-bold rounded-lg text-xs mb-2 border border-blue-100">ğŸ”„ ç«‹å³æ‰‹åŠ¨åŒæ­¥</button>
                        <button @click="resetCloud" class="text-[10px] text-slate-400 underline">æ–­å¼€è¿æ¥ / ä¿®æ”¹é…ç½®</button>
                    </div>
                </div>

                <!-- æ•°æ®ç®¡ç† -->
                <div class="card p-4 space-y-3">
                    <h3 class="font-bold text-sm">æ•°æ®ç®¡ç†</h3>
                    <button @click="exportToExcel" class="w-full py-3 bg-slate-50 text-slate-700 font-bold rounded-lg text-xs flex items-center justify-center gap-2">ğŸ“Š å¯¼å‡º Excel (CSV)</button>
                    <button @click="showSyncModal=true" class="w-full py-3 bg-slate-50 text-slate-700 font-bold rounded-lg text-xs flex items-center justify-center gap-2">ğŸ“‹ å¤åˆ¶åŠ å¯†æ•°æ®ä¸²</button>
                    <button @click="resetApp" class="w-full py-3 bg-red-50 text-red-500 font-bold rounded-lg text-xs">âš ï¸ æ¸…ç©ºå¹¶é‡ç½® APP</button>
                </div>
            </div>

        </main>

        <!-- åº•éƒ¨å¯¼èˆªæ  (Bottom Nav) -->
        <nav class="bg-white border-t border-slate-100 flex justify-around items-center h-16 safe-area-bottom z-20">
            <button @click="currentTab='home'" class="flex flex-col items-center gap-1 w-full h-full justify-center transition" :class="currentTab==='home'?'nav-item-active':'nav-item-inactive'">
                <span class="text-xl">ğŸ </span><span class="text-[10px]">èµ„äº§</span>
            </button>
            <div class="relative -top-5">
                <button @click="openTxModal(null)" class="w-14 h-14 rounded-full bg-slate-800 text-white shadow-xl flex items-center justify-center text-2xl border-4 border-slate-50 active:scale-90 transition">ï¼‹</button>
            </div>
            <button @click="currentTab='stats'; nextTick(()=>renderStats())" class="flex flex-col items-center gap-1 w-full h-full justify-center transition" :class="currentTab==='stats'?'nav-item-active':'nav-item-inactive'">
                <span class="text-xl">ğŸ“Š</span><span class="text-[10px]">æŠ¥è¡¨</span>
            </button>
            <button @click="currentTab='settings'" class="flex flex-col items-center gap-1 w-full h-full justify-center transition" :class="currentTab==='settings'?'nav-item-active':'nav-item-inactive'">
                <span class="text-xl">âš™ï¸</span><span class="text-[10px]">è®¾ç½®</span>
            </button>
        </nav>

        <!-- è®°è´¦å¼¹çª— -->
        <transition name="slide">
        <div v-if="showTxModal" class="fixed inset-0 z-50 bg-white flex flex-col safe-area-top safe-area-bottom">
            <div class="p-4 flex justify-between items-center border-b border-slate-50"><button @click="showTxModal=false" class="text-slate-400">å–æ¶ˆ</button><div class="flex bg-slate-100 p-1 rounded-lg"><button @click="newTx.type='expense'" :class="newTx.type==='expense'?'bg-white shadow text-emerald-500':'text-slate-400'" class="px-4 py-1 rounded text-xs font-bold transition">æ”¯å‡º</button><button @click="newTx.type='income'" :class="newTx.type==='income'?'bg-white shadow text-red-500':'text-slate-400'" class="px-4 py-1 rounded text-xs font-bold transition">æ”¶å…¥</button></div><button @click="confirmTx" class="text-blue-600 font-bold">ä¿å­˜</button></div>
            <div class="p-6 text-center border-b border-slate-50"><div class="flex justify-center items-end gap-1"><span class="text-2xl font-bold mb-1 text-slate-400">Â¥</span><input type="number" v-model.number="newTx.amount" class="text-5xl font-black text-center outline-none w-48 bg-transparent" placeholder="0" autofocus></div></div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50">
                <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-2">è´¦æˆ·</p><div class="flex gap-2 overflow-x-auto pb-2"><button @click="newTx.accountId='cash'" :class="newTx.accountId==='cash'?'bg-slate-800 text-white':'bg-white text-slate-500 border'" class="px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap shadow-sm">ğŸ‘› ç°é‡‘</button><button @click="newTx.accountId='debit'" :class="newTx.accountId==='debit'?'bg-slate-800 text-white':'bg-white text-slate-500 border'" class="px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap shadow-sm">ğŸ’³ å‚¨è“„å¡</button><button v-for="cc in creditCards" :key="cc.id" @click="newTx.accountId=cc.id" :class="newTx.accountId===cc.id?'bg-slate-800 text-white':'bg-white text-slate-500 border'" class="px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap shadow-sm">ğŸ’³ {{cc.name}}</button></div></div>
                <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-2">åˆ†ç±»</p><div class="grid grid-cols-5 gap-3"><div v-for="cat in currentCategories" :key="cat.name" @click="newTx.category=cat.name; newTx.icon=cat.icon" class="flex flex-col items-center gap-1 transition active:scale-95" :class="{'opacity-100': newTx.category===cat.name, 'opacity-50': newTx.category!==cat.name}"><div class="w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-sm" :class="newTx.category===cat.name?'bg-white border-2 border-blue-500':'bg-white'">{{cat.icon}}</div><span class="text-[10px] font-medium">{{cat.name}}</span></div></div></div>
                <div class="space-y-3"><input type="date" v-model="newTx.date" class="w-full bg-white p-3 rounded-xl text-sm font-bold text-slate-600 outline-none border border-slate-200"><input type="text" v-model="newTx.desc" class="w-full bg-white p-3 rounded-xl text-sm font-bold text-slate-600 outline-none border border-slate-200" placeholder="å¤‡æ³¨..."></div>
                <div v-if="editingTx" class="pt-4"><button @click="deleteTx" class="w-full py-3 bg-red-50 text-red-500 font-bold rounded-xl text-sm">åˆ é™¤æ­¤è®°å½•</button></div>
            </div>
        </div>
        </transition>

        <!-- å¤‡ä»½å¼¹çª— -->
        <div v-if="showSyncModal" class="fixed inset-0 z-50 bg-slate-900/40 flex items-center justify-center p-6"><div class="bg-white rounded-2xl p-6 w-full"><h3 class="font-bold mb-2">æ•°æ®å¤‡ä»½</h3><textarea readonly class="w-full h-24 bg-slate-50 text-[10px] p-2 rounded mb-4">{{ encryptedString }}</textarea><div class="flex gap-2"><button @click="copyString" class="flex-1 py-2 bg-blue-600 text-white rounded text-xs">å¤åˆ¶</button><button @click="showSyncModal=false" class="flex-1 py-2 bg-slate-100 rounded text-xs">å…³é—­</button></div></div></div>

    </div>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    window.initFirebaseServices = (config) => {
        try {
            const app = initializeApp(config);
            window.db = getFirestore(app);
            window.dbHelpers = { doc, getDoc, setDoc };
            return true;
        } catch(e) { console.error(e); return false; }
    };
</script>

<script>
    const { createApp, nextTick } = Vue;

    createApp({
        data() {
            return {
                isUnlocked: false, hasLocalData: false, showImport: false, showTxModal: false, showSyncModal: false,
                passwordInput: '', firebaseConfigInput: '', syncId: '', masterKey: '', encryptedString: '',
                isSyncing: false, cloudConfigured: false, syncStatusText: 'ç¦»çº¿',
                
                currentTab: 'home', // home | stats | settings
                statsRange: 'month', // month | last_month
                statsData: { totalIncome:0, totalExpense:0 },
                
                assets: { cash: 0, debit: 0 },
                deposits: [], stocks: [], loans: [], creditCards: [], 
                transactions: [], history: [], 
                
                newTx: { type: 'expense', amount: '', category: 'é¤é¥®', icon: 'ğŸ”', desc: '', accountId: 'cash', date: new Date().toISOString().slice(0,10) },
                editingTx: null,
                ui: { cashOpen: false, creditOpen: true, depositOpen: false, stockOpen: false, loanOpen: false },
                
                categories: {
                    expense: [
                        {name:'é¤é¥®',icon:'ğŸ”'},{name:'è´­ç‰©',icon:'ğŸ›ï¸'},{name:'äº¤é€š',icon:'ğŸš—'},{name:'ä½æˆ¿',icon:'ğŸ '},
                        {name:'å¨±ä¹',icon:'ğŸ®'},{name:'åŒ»ç–—',icon:'ğŸ’Š'},{name:'æ•™è‚²',icon:'ğŸ“'},{name:'è¿˜æ¬¾',icon:'ğŸ’¸'},
                        {name:'å® ç‰©',icon:'ğŸ¾'},{name:'ç¾å¦†',icon:'ğŸ’„'},{name:'è¿åŠ¨',icon:'ğŸƒ'},{name:'ç¤¾äº¤',icon:'ğŸ¥‚'},
                        {name:'æ—…æ¸¸',icon:'âœˆï¸'},{name:'æ•°ç ',icon:'ğŸ“±'},{name:'é€šè®¯',icon:'ğŸ“'},{name:'å…¶ä»–',icon:'ğŸ“'}
                    ],
                    income: [
                        {name:'å·¥èµ„',icon:'ğŸ’°'},{name:'ç†è´¢',icon:'ğŸ“ˆ'},{name:'å…¼èŒ',icon:'ğŸ’¼'},{name:'å€Ÿå…¥',icon:'ğŸ™‹'},
                        {name:'å¥–é‡‘',icon:'ğŸ…'},{name:'æŠ¥é”€',icon:'ğŸ§¾'},{name:'å…¶ä»–',icon:'ğŸ§§'}
                    ]
                },
                pieChart: null, barChart: null
            }
        },
        computed: {
            cashTotal() { return (this.assets.cash||0) + (this.assets.debit||0); },
            depositTotal() { return this.deposits.reduce((s,i)=>s+(i.amount||0),0); },
            stockTotal() { return this.stocks.reduce((s,i)=>s+((i.shares||0)*(i.price||0)),0); },
            creditTotal() { return this.creditCards.reduce((sum, c) => sum + (c.currentBalance||0) + (c.installments||[]).reduce((is,i)=>is+(i.total-(i.monthlyAmount*(i.paidMonths||0))),0), 0); },
            loanTotal() { return this.loans.reduce((s,i)=>s+(i.total||0),0); },
            totalAssets() { return this.cashTotal + this.depositTotal + this.stockTotal; },
            totalLiabilities() { return this.creditTotal + this.loanTotal; },
            netWorth() { return this.totalAssets - this.totalLiabilities; },
            currentCategories() { return this.newTx.type === 'expense' ? this.categories.expense : this.categories.income; },
            recentTransactions() { return [...this.transactions].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,20); },
            monthlyStats() {
                const cm = new Date().toISOString().slice(0,7);
                const income = this.transactions.filter(t=>t.type==='income' && t.date.startsWith(cm)).reduce((s,t)=>s+t.amount,0);
                let expense = this.transactions.filter(t=>t.type==='expense' && t.date.startsWith(cm)).reduce((s,t)=>s+t.amount,0);
                this.loans.forEach(l => expense += (l.monthlyPayment||0));
                this.creditCards.forEach(c => (c.installments||[]).forEach(i => expense += (i.monthlyAmount||0)));
                return { income, expense };
            },
            syncStatusColor() { return this.isSyncing ? 'bg-amber-400' : (this.cloudConfigured ? 'bg-green-500' : 'bg-slate-300'); }
        },
        mounted() {
            if(localStorage.getItem('myWealth_V11')) this.hasLocalData = true;
            const cloudCfg = localStorage.getItem('myWealth_Cloud');
            if(cloudCfg) {
                const parsed = JSON.parse(cloudCfg);
                this.firebaseConfigInput = JSON.stringify(parsed.config);
                this.syncId = parsed.syncId;
                this.initCloud(parsed.config);
            }
        },
        methods: {
            initCloud(config) { if(window.initFirebaseServices && window.initFirebaseServices(config)) { this.cloudConfigured = true; this.syncStatusText = 'å·²è¿æ¥'; } },
            saveCloudConfig() {
                try {
                    let config;
                    try { config = JSON.parse(this.firebaseConfigInput); } catch(e) { 
                        // å°è¯•ä¿®å¤æ— å¼•å· JSON
                        config = new Function("return " + this.firebaseConfigInput)(); 
                    }
                    if(!config || !config.apiKey) throw new Error();
                    if(!this.syncId) return alert("è¯·è¾“å…¥åŒæ­¥ID");
                    localStorage.setItem('myWealth_Cloud', JSON.stringify({config, syncId: this.syncId}));
                    this.initCloud(config);
                    alert("é…ç½®æˆåŠŸï¼");
                } catch(e) { alert("é…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ ¼å¼"); }
            },
            resetCloud() { localStorage.removeItem('myWealth_Cloud'); this.cloudConfigured=false; location.reload(); },
            
            async forceSync() {
                if(!this.cloudConfigured) return alert("è¯·å…ˆé…ç½®äº‘åŒæ­¥");
                this.isSyncing = true;
                await this.syncToCloud();
                await this.syncFromCloud();
                this.isSyncing = false;
            },
            async syncToCloud() {
                if(!this.cloudConfigured || !this.isUnlocked) return;
                this.isSyncing = true; this.syncStatusText='ä¸Šä¼ ä¸­...';
                try {
                    await window.dbHelpers.setDoc(window.dbHelpers.doc(window.db, "wealth_data", this.syncId), { encrypted: this.encryptedString, timestamp: Date.now() });
                    this.syncStatusText='å·²åŒæ­¥';
                } catch(e) { 
                    console.error(e); 
                    this.syncStatusText='åŒæ­¥å¤±è´¥'; 
                    // å¼¹çª—æ˜¾ç¤ºå…·ä½“é”™è¯¯
                    alert("ä¸Šä¼ å¤±è´¥: " + (e.message || e)); 
                }
                this.isSyncing = false;
            },
            async syncFromCloud() {
                if(!this.cloudConfigured) return;
                try {
                    const snap = await window.dbHelpers.getDoc(window.dbHelpers.doc(window.db, "wealth_data", this.syncId));
                    if(snap.exists()) this.decryptAndLoad(snap.data().encrypted, true);
                } catch(e) { 
                    console.error("Sync Down Fail", e); 
                    alert("ä¸‹è½½å¤±è´¥: " + (e.message || e)); 
                }
            },
            unlock() {
                if(!this.passwordInput) return;
                this.masterKey = this.passwordInput;
                if(this.cloudConfigured) {
                    this.isSyncing = true; this.syncStatusText='åŒæ­¥ä¸­...';
                    this.syncFromCloud().finally(() => { 
                        this.isSyncing = false; 
                        this.syncStatusText='å·²åŒæ­¥';
                        if(!this.isUnlocked) this.tryLocalUnlock(); 
                    });
                } else this.tryLocalUnlock();
            },
            tryLocalUnlock() {
                const local = localStorage.getItem('myWealth_V11');
                if(local) { if(!this.decryptAndLoad(local)) alert("å¯†ç é”™è¯¯"); } else { this.isUnlocked = true; this.saveData(); }
            },
            decryptAndLoad(str, fromCloud=false) {
                try {
                    const bytes = CryptoJS.AES.decrypt(str, this.masterKey);
                    const data = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                    Object.assign(this, data);
                    this.isUnlocked = true;
                    this.encryptedString = str;
                    if(fromCloud) localStorage.setItem('myWealth_V11', str);
                    nextTick(()=>this.renderChart());
                    return true;
                } catch(e) { return false; }
            },
            
            // ... (Transactions, Account Logic, etc. same as V10) ...
            openTxModal(tx) { 
                this.editingTx = tx;
                this.newTx = tx ? JSON.parse(JSON.stringify(tx)) : { type: 'expense', amount: '', category: 'é¤é¥®', icon: 'ğŸ”', desc: '', accountId: 'cash', date: new Date().toISOString().slice(0,10) };
                this.showTxModal = true; 
            },
            updateAccount(tx, revert=false) {
                const f = revert ? -1 : 1;
                const {type, amount, accountId, extra} = tx;
                if(accountId==='cash') this.assets.cash += (type==='income'?amount:-amount)*f;
                else if(accountId==='debit') this.assets.debit += (type==='income'?amount:-amount)*f;
                else {
                    let cc=this.creditCards.find(c=>c.id===accountId), st=this.stocks.find(s=>s.id===accountId), ln=this.loans.find(l=>l.id===accountId);
                    if(cc) cc.currentBalance += (type==='expense'?amount:-amount)*f;
                    else if(st && st.price>0) st.shares += (type==='income'?1:-1)*(extra?.sharesDelta || amount/st.price)*f;
                    else if(ln) ln.total += (type==='income'?-amount:amount)*f;
                }
            },
            confirmTx() {
                if(!this.newTx.amount) return;
                if(this.editingTx) { this.updateAccount(this.editingTx, true); this.transactions = this.transactions.filter(t=>t.id!==this.editingTx.id); }
                let extra={};
                if(['income','expense'].includes(this.newTx.type)) {
                    const st = this.stocks.find(s=>s.id===this.newTx.accountId);
                    if(st && st.price>0) extra.sharesDelta = this.newTx.amount/st.price;
                }
                const final = { id: this.editingTx?.id||Date.now(), ...this.newTx, extra };
                this.updateAccount(final);
                this.transactions.push(final);
                this.showTxModal = false;
                this.saveData(true);
            },
            deleteTx() {
                if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
                this.updateAccount(this.editingTx, true);
                this.transactions = this.transactions.filter(t=>t.id!==this.editingTx.id);
                this.showTxModal = false;
                this.saveData(true);
            },
            addCreditCard() { this.creditCards.push({id:Date.now(), name:'', currentBalance:0, installments:[]}); },
            addInstallment(card) {
                const name=prompt("å•†å“å"), total=Number(prompt("æ€»é¢")), months=Number(prompt("æœŸæ•°"));
                if(name&&total&&months) card.installments.push({name, total, months, monthlyAmount:total/months, paidMonths:0});
            },
            calcLoanMonthly(l) { if(l.total && l.years) l.monthlyPayment = Math.round(l.total / (l.years * 12)); },
            getAccountName(id) {
                if(id==='cash') return 'ç°é‡‘'; if(id==='debit') return 'æ´»æœŸ';
                return (this.creditCards.concat(this.stocks, this.loans).find(x=>x.id===id)||{}).name || 'æœªçŸ¥';
            },
            toggleAll() { this.ui.cashOpen=!this.ui.cashOpen; this.ui.creditOpen=this.ui.cashOpen; this.ui.depositOpen=this.ui.cashOpen; this.ui.stockOpen=this.ui.cashOpen; this.ui.loanOpen=this.ui.cashOpen; },
            
            saveData(animate) {
                const today = new Date().toLocaleDateString();
                if(!this.history.find(h=>h.date===today)) { this.history.push({date:today, val:this.netWorth}); if(this.history.length>30) this.history.shift(); }
                else this.history.find(h=>h.date===today).val = this.netWorth;
                const data = { assets:this.assets, deposits:this.deposits, stocks:this.stocks, loans:this.loans, creditCards:this.creditCards, transactions:this.transactions, history:this.history };
                const str = CryptoJS.AES.encrypt(JSON.stringify(data), this.masterKey).toString();
                localStorage.setItem('myWealth_V11', str);
                this.encryptedString = str;
                this.syncToCloud();
                if(this.isUnlocked) this.renderChart();
            },
            resetApp() { if(confirm("ç¡®å®šé‡ç½®ï¼Ÿæ•°æ®å°†ä¸¢å¤±ï¼")) { localStorage.removeItem('myWealth_V11'); location.reload(); } },
            lockApp() { this.saveData(); this.isUnlocked = false; this.passwordInput = ''; },
            importData() {
                this.masterKey = this.passwordInput;
                if(this.decryptAndLoad(this.importString)) { this.saveData(true); this.showImport = false; } else alert("æ¢å¤å¤±è´¥");
            },
            exportToExcel() {
                let csv = "\uFEFFæ—¥æœŸ,ç±»å‹,é‡‘é¢,åˆ†ç±»,è´¦æˆ·,å¤‡æ³¨\n";
                this.transactions.forEach(t => csv += `${t.date},${t.type==='income'?'æ”¶å…¥':'æ”¯å‡º'},${t.amount},${t.category},${this.getAccountName(t.accountId)},${t.desc}\n`);
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
                link.download = `è´¦å•_${new Date().toLocaleDateString()}.csv`;
                link.click();
            },
            renderChart() {
                const ctx = document.getElementById('mainChart');
                if(!ctx) return;
                if(this.chartInstance) this.chartInstance.destroy();
                this.chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels: this.history.map(h=>h.date.slice(5)), datasets: [{ label: 'å‡€èµ„äº§', data: this.history.map(h=>h.val), borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }] },
                    options: { responsive: true, maintainAspectRatio: false, scales:{x:{display:false},y:{display:false}}, plugins:{legend:{display:false}} }
                });
            },
            formatNumber(num) { return num ? num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') : '0.00'; }
        }
    }).mount('#app');
</script>
</body>
</html>
