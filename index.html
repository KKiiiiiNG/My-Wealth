<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8fafc">
    <title>èµ„äº§ç®¡å®¶ V16</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; color: #334155; -webkit-tap-highlight-color: transparent; }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; overflow: hidden; }
        
        /* é¢œè‰²å®šä¹‰ */
        .text-income { color: #ef4444; } .bg-income { background-color: #fee2e2; }
        .text-expense { color: #10b981; } .bg-expense { background-color: #d1fae5; }
        .text-transfer { color: #3b82f6; } .bg-transfer { background-color: #dbeafe; }

        /* åŠ¨ç”» */
        .slide-enter-active, .slide-leave-active { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); max-height: 800px; opacity: 1; }
        .slide-enter-from, .slide-leave-to { max-height: 0; opacity: 0; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        ::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body>

<div id="app" class="h-screen w-full flex flex-col bg-slate-50 relative overflow-hidden">

    <!-- ================= 1. ç™»å½• ================= -->
    <div v-if="!isUnlocked" class="fixed inset-0 z-50 bg-slate-100 flex flex-col items-center justify-center p-8 safe-area-top">
        <div class="bg-white p-8 rounded-[2rem] shadow-2xl w-full max-w-sm text-center border border-white">
            <div class="text-6xl mb-4">ğŸ¦</div>
            <h1 class="text-2xl font-bold text-slate-800 mb-1">èµ„äº§ç®¡å®¶ V16</h1>
            <p class="text-xs text-slate-400 mb-8 uppercase tracking-widest">Flagship Edition</p>

            <div class="space-y-4">
                <div class="bg-slate-50 rounded-2xl p-2 border border-slate-200">
                    <input type="password" v-model="passwordInput" placeholder="è¾“å…¥ä¸»å¯†ç " class="w-full bg-transparent p-3 text-center text-lg font-bold outline-none">
                </div>
                <button @click="unlock" class="w-full py-4 rounded-2xl font-bold text-white shadow-xl text-lg bg-slate-900 active:scale-95 transition">
                    {{ hasLocalData ? 'éªŒè¯è§£é”' : 'è®¾ç½®å¯†ç å¹¶å¼€å§‹' }}
                </button>
            </div>
            
            <div class="mt-8 pt-6 border-t border-slate-100">
                <button @click="showImport=!showImport" class="text-xs text-blue-500 font-bold">ğŸ“‚ æ¢å¤å¤‡ä»½æ•°æ®</button>
                <div v-if="showImport" class="mt-3"><textarea v-model="importString" class="w-full h-20 text-[10px] bg-slate-50 p-3 rounded-xl border resize-none outline-none" placeholder="ç²˜è´´åŠ å¯†æ•°æ®ä¸²..."></textarea><button @click="importData" class="mt-2 w-full py-3 bg-white border text-xs rounded-xl font-bold shadow-sm">ç¡®è®¤æ¢å¤</button></div>
            </div>
        </div>
    </div>

    <!-- ================= 2. ä¸»ç¨‹åº ================= -->
    <div v-else class="flex-1 flex flex-col h-full safe-area-top safe-area-bottom">
        
        <!-- é¡¶éƒ¨: å‡€èµ„äº§ + é¢„ç®—æ¡ (å›ºå®š) -->
        <header class="px-6 pt-4 pb-4 bg-white shadow-sm z-10 rounded-b-[2rem]">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Net Worth</span>
                <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500">{{ currentDate }}</span>
            </div>
            <h1 class="text-4xl font-black text-slate-800 mb-4 tracking-tight">Â¥ {{ formatNumber(netWorth) }}</h1>
            
            <!-- ç®€æ˜“é¢„ç®—æ¡ -->
            <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                <div class="flex justify-between text-xs mb-1 font-bold text-slate-600">
                    <span>æœ¬æœˆé¢„ç®—</span>
                    <span :class="budgetProgress > 100 ? 'text-red-500' : 'text-slate-600'">{{Math.round(budgetProgress)}}%</span>
                </div>
                <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div class="h-full bg-slate-800 rounded-full transition-all duration-500" :style="{width: Math.min(budgetProgress, 100) + '%', backgroundColor: budgetProgress > 100 ? '#ef4444' : '#1e293b'}"></div>
                </div>
                <div class="flex justify-between text-[10px] mt-1 text-slate-400">
                    <span>å·²ç”¨: Â¥{{formatNumber(monthlyStats.expense)}}</span>
                    <span>å‰©ä½™: Â¥{{formatNumber(settings.monthlyBudget - monthlyStats.expense)}}</span>
                </div>
            </div>
        </header>

        <!-- å†…å®¹åŒºåŸŸ -->
        <main class="flex-1 overflow-y-auto p-4 space-y-5 pb-28">
            
            <!-- >>>>>> Tab 1: æ˜ç»† (Home) <<<<<< -->
            <div v-if="currentTab === 'home'" class="space-y-4 animate-fade-in">
                
                <!-- èµ„äº§æŠ˜å å¡ç‰‡ -->
                <div class="space-y-3">
                    <div class="flex justify-between items-center px-2">
                        <h3 class="font-bold text-slate-800 text-sm">æˆ‘çš„è´¦æˆ·</h3>
                        <button @click="toggleAll" class="text-[10px] bg-white px-3 py-1 rounded-full border shadow-sm font-bold text-slate-500">{{ui.cashOpen?'æ”¶èµ·':'å±•å¼€'}}</button>
                    </div>

                    <!-- ç°é‡‘ -->
                    <div class="card"><div class="p-4 flex justify-between items-center bg-white active:bg-slate-50 transition" @click="ui.cashOpen=!ui.cashOpen"><div class="flex items-center gap-3"><span class="text-xl">ğŸ‘›</span><div><div class="font-bold text-sm">ç°é‡‘ & æ´»æœŸ</div><div class="text-[10px] text-slate-400">Â¥{{formatNumber(cashTotal)}}</div></div></div><span class="text-slate-300 text-xs">â–¼</span></div><div v-if="ui.cashOpen" class="bg-slate-50 p-4 space-y-3 border-t border-slate-100"><div class="flex justify-between items-center text-xs"><span class="font-bold text-slate-600">ğŸ’µ ç°é‡‘é’±åŒ…</span><input v-model.number="assets.cash" type="number" class="text-right font-bold bg-transparent outline-none w-24"></div><div class="flex justify-between items-center text-xs"><span class="font-bold text-slate-600">ğŸ’³ å‚¨è“„å¡</span><input v-model.number="assets.debit" type="number" class="text-right font-bold bg-transparent outline-none w-24"></div></div></div>
                    
                    <!-- ä¿¡ç”¨å¡ -->
                    <div class="card"><div class="p-4 flex justify-between items-center bg-white active:bg-slate-50 transition" @click="ui.creditOpen=!ui.creditOpen"><div class="flex items-center gap-3"><span class="text-xl">ğŸ’³</span><div><div class="font-bold text-sm">ä¿¡ç”¨å¡</div><div class="text-[10px] text-slate-400">è´Ÿå€º: <span class="text-emerald-500">Â¥{{formatNumber(creditTotal)}}</span></div></div></div><span class="text-slate-300 text-xs">â–¼</span></div><div v-if="ui.creditOpen" class="bg-slate-50 p-3 space-y-3 border-t border-slate-100"><div v-for="(cc,i) in creditCards" :key="cc.id" class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm"><div class="flex justify-between mb-2"><input v-model="cc.name" class="font-bold text-sm bg-transparent outline-none w-1/2" placeholder="å¡å"><button @click="removeCreditCard(i)" class="text-[10px] text-slate-300">âœ•</button></div><div class="flex justify-between text-xs items-center mb-2"><span class="text-slate-400">å®æ—¶æ¬ æ¬¾</span><input v-model.number="cc.currentBalance" class="text-right font-bold text-emerald-500 bg-transparent outline-none w-24"></div><div class="bg-slate-50 p-2 rounded border border-dashed border-slate-200"><div class="flex justify-between text-[10px] text-slate-400 mb-1"><span>åˆ†æœŸè®¡åˆ’</span><button @click="addInstallment(cc)" class="text-blue-500 font-bold">+ æ–°å¢</button></div><div v-for="(inst,ii) in cc.installments" class="flex justify-between text-[10px] text-slate-600 mb-1"><span>{{inst.name}}</span><span>æœˆä¾›:{{Math.round(inst.monthlyAmount)}}</span><span @click="cc.installments.splice(ii,1)" class="text-red-300">âœ•</span></div></div></div><button @click="addCreditCard" class="w-full py-2 bg-white border border-dashed text-xs text-slate-400 rounded-xl font-bold">+ æ·»åŠ å¡ç‰‡</button></div></div>
                    
                    <!-- æŠ•èµ„è´·æ¬¾ -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="card p-3 flex flex-col justify-center items-center active:scale-95 transition" @click="ui.investOpen=!ui.investOpen"><span class="text-2xl mb-1">ğŸ“ˆ</span><span class="text-[10px] font-bold text-slate-400">æŠ•èµ„/å®šå­˜</span><span class="text-sm font-bold text-amber-500">Â¥{{formatNumber(stockTotal+depositTotal)}}</span></div>
                        <div class="card p-3 flex flex-col justify-center items-center active:scale-95 transition" @click="ui.loanOpen=!ui.loanOpen"><span class="text-2xl mb-1">ğŸ </span><span class="text-[10px] font-bold text-slate-400">è´·æ¬¾</span><span class="text-sm font-bold text-emerald-500">-Â¥{{formatNumber(loanTotal)}}</span></div>
                    </div>
                    
                    <!-- éšè—è¯¦æƒ… (ç®€åŒ–) -->
                    <div v-if="ui.investOpen" class="card p-3 bg-slate-50 space-y-2"><div v-for="(s,i) in stocks" class="flex justify-between text-xs bg-white p-2 rounded border"><span>{{s.name}}</span><span>Â¥{{formatNumber(s.shares*s.price)}}</span><button @click="stocks.splice(i,1)" class="text-red-300">âœ•</button></div><button @click="stocks.push({id:Date.now(),name:'æ–°è‚¡ç¥¨',shares:0,price:0})" class="text-[10px] w-full text-blue-500">+ è‚¡ç¥¨</button><div class="h-px bg-slate-200 my-2"></div><div v-for="(d,i) in deposits" class="flex justify-between text-xs bg-white p-2 rounded border"><span>{{d.name}}</span><span>Â¥{{formatNumber(d.amount)}}</span><button @click="deposits.splice(i,1)" class="text-red-300">âœ•</button></div><button @click="deposits.push({name:'æ–°å­˜å•',amount:0})" class="text-[10px] w-full text-blue-500">+ å­˜å•</button></div>
                    <div v-if="ui.loanOpen" class="card p-3 bg-slate-50 space-y-2"><div v-for="(l,i) in loans" class="bg-white p-2 rounded border"><div class="flex justify-between text-xs mb-1"><input v-model="l.name" class="font-bold w-1/2 outline-none"><input v-model.number="l.total" class="text-right w-24 outline-none text-emerald-500"></div><div class="flex justify-between text-[10px] text-slate-400"><span>æœˆä¾›: <input v-model.number="l.monthlyPayment" class="w-10 bg-slate-50 text-center"></span><span @click="loans.splice(i,1)" class="text-red-300">åˆ é™¤</span></div></div><button @click="loans.push({id:Date.now(),name:'æˆ¿è´·',total:0,years:30,monthlyPayment:0})" class="text-[10px] w-full text-blue-500">+ è´·æ¬¾</button></div>
                </div>

                <!-- æœç´¢ä¸æµæ°´ -->
                <div class="pt-4">
                    <div class="relative mb-4">
                        <span class="absolute left-3 top-2.5 text-slate-400 text-sm">ğŸ”</span>
                        <input v-model="searchText" class="w-full bg-white pl-9 pr-4 py-2.5 rounded-xl text-xs font-bold text-slate-700 outline-none shadow-sm border border-slate-100" placeholder="æœç´¢å¤‡æ³¨ã€é‡‘é¢ã€é¡¹ç›®...">
                    </div>
                    
                    <h3 class="font-bold text-slate-800 text-sm mb-3 px-1">è´¦å•æµæ°´</h3>
                    <div class="space-y-3">
                        <div v-for="tx in filteredTransactions" :key="tx.id" @click="openTxModal(tx)" 
                            class="bg-white p-4 rounded-2xl border border-slate-50 shadow-sm flex items-center justify-between active:scale-95 transition">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg" :class="getTypeColor(tx.type, true)">{{ tx.icon }}</div>
                                <div>
                                    <div class="font-bold text-slate-700 text-sm flex items-center gap-2">
                                        {{ tx.category }}
                                        <span v-if="tx.project" class="text-[8px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200">{{tx.project}}</span>
                                    </div>
                                    <div class="text-[10px] text-slate-400 mt-0.5">
                                        {{ tx.date.slice(5) }} <span v-if="tx.desc">- {{tx.desc}}</span>
                                        <span v-if="tx.type==='transfer'" class="text-blue-400">Â· {{getAccountName(tx.fromId)}} â” {{getAccountName(tx.toId)}}</span>
                                        <span v-else>Â· {{ getAccountName(tx.accountId) }}</span>
                                    </div>
                                </div>
                            </div>
                            <span class="font-bold text-base font-mono" :class="getTypeColor(tx.type)">
                                {{ tx.type==='expense'?'-':(tx.type==='income'?'+':'') }}{{ formatNumber(tx.amount) }}
                            </span>
                        </div>
                        <div v-if="filteredTransactions.length===0" class="text-center text-slate-400 text-xs py-8">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®°å½•</div>
                    </div>
                </div>
            </div>

            <!-- >>>>>> Tab 2: æŠ¥è¡¨ (Stats) <<<<<< -->
            <div v-else-if="currentTab === 'stats'" class="space-y-6 animate-fade-in">
                <!-- é¡¶éƒ¨ç­›é€‰ -->
                <div class="bg-white p-2 rounded-xl flex justify-between items-center shadow-sm">
                    <h2 class="font-bold text-slate-800 ml-2">æ”¶æ”¯æŠ¥è¡¨</h2>
                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button v-for="r in ['week','month','year']" :key="r" @click="statsRange=r; renderStats()" 
                            :class="statsRange===r ? 'bg-white shadow text-slate-800' : 'text-slate-400'"
                            class="px-3 py-1.5 rounded-md text-xs font-bold transition capitalize">{{r}}</button>
                    </div>
                </div>

                <!-- ç»Ÿè®¡å¡ -->
                <div class="grid grid-cols-3 gap-2">
                    <div class="card p-3 text-center"><div class="text-[10px] text-slate-400 mb-1">æ”¶å…¥</div><div class="font-bold text-red-500 text-sm">Â¥{{formatNumber(statsData.income)}}</div></div>
                    <div class="card p-3 text-center"><div class="text-[10px] text-slate-400 mb-1">æ”¯å‡º</div><div class="font-bold text-emerald-500 text-sm">Â¥{{formatNumber(statsData.expense)}}</div></div>
                    <div class="card p-3 text-center"><div class="text-[10px] text-slate-400 mb-1">ç»“ä½™</div><div class="font-bold text-slate-700 text-sm">Â¥{{formatNumber(statsData.income - statsData.expense)}}</div></div>
                </div>

                <!-- å›¾è¡¨åŒº -->
                <div class="card p-5">
                    <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase">æ”¶æ”¯è¶‹åŠ¿</h3>
                    <div class="h-40 relative"><canvas id="trendChart"></canvas></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card p-5">
                        <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase">åˆ†ç±»å æ¯” (Top 5)</h3>
                        <div class="h-48 relative"><canvas id="catChart"></canvas></div>
                    </div>
                    <div class="card p-5">
                        <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase">é¡¹ç›®çœ‹æ¿ (Project)</h3>
                        <div class="space-y-3">
                            <div v-for="p in statsData.projectStats" :key="p.name" class="flex justify-between items-center text-xs">
                                <span class="font-bold text-slate-600">{{p.name}}</span>
                                <div class="flex items-center gap-2">
                                    <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-blue-500" :style="{width: p.percent+'%'}"></div></div>
                                    <span class="font-mono text-slate-500 w-12 text-right">Â¥{{formatNumber(p.amount)}}</span>
                                </div>
                            </div>
                            <div v-if="statsData.projectStats.length===0" class="text-center text-xs text-slate-300 py-4">æ— é¡¹ç›®æ•°æ®</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- >>>>>> Tab 3: æˆ‘çš„ (Mine) <<<<<< -->
            <div v-else-if="currentTab === 'mine'" class="space-y-4 animate-fade-in">
                <div class="card p-6 bg-slate-800 text-white flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full bg-slate-700 flex items-center justify-center text-3xl">ğŸ‘¤</div>
                    <div>
                        <h2 class="text-lg font-bold">æˆ‘çš„è´¦æˆ·</h2>
                        <p class="text-xs text-slate-400 mt-1">æ•°æ®ä»…å­˜å‚¨åœ¨æœ¬åœ°</p>
                    </div>
                </div>

                <div class="card p-4 space-y-1">
                    <div class="px-2 py-2 border-b border-slate-50"><h3 class="text-xs font-bold text-slate-400 uppercase">ç³»ç»Ÿè®¾ç½®</h3></div>
                    <div class="flex justify-between items-center p-3 hover:bg-slate-50 rounded-xl transition">
                        <span class="text-sm font-bold text-slate-700">æœˆåº¦é¢„ç®—</span>
                        <input v-model.number="settings.monthlyBudget" @change="saveData" type="number" class="text-right text-sm font-bold text-blue-600 bg-transparent outline-none w-24">
                    </div>
                    <div class="flex justify-between items-center p-3 hover:bg-slate-50 rounded-xl transition">
                        <span class="text-sm font-bold text-slate-700">é¡¹ç›®ç®¡ç†</span>
                        <button @click="manageProjects" class="text-xs font-bold text-blue-500 bg-blue-50 px-3 py-1 rounded-lg">ç¼–è¾‘</button>
                    </div>
                </div>

                <div class="card p-4 space-y-3">
                    <h3 class="text-xs font-bold text-slate-400 uppercase px-2 mb-1">æ•°æ®å®‰å…¨</h3>
                    <button @click="exportToFile" class="w-full py-3 bg-white border border-slate-200 text-slate-700 font-bold rounded-xl text-xs flex items-center justify-center gap-2">ğŸ“¤ å¯¼å‡ºå¤‡ä»½æ–‡ä»¶ (iCloud)</button>
                    <label class="w-full py-3 bg-white border border-slate-200 text-slate-700 font-bold rounded-xl text-xs flex items-center justify-center gap-2 cursor-pointer">
                        ğŸ“¥ å¯¼å…¥å¤‡ä»½æ•°æ® <input type="file" class="hidden" accept=".json,.txt" @change="handleFileImport">
                    </label>
                    <button @click="exportToExcel" class="w-full py-3 bg-white border border-slate-200 text-slate-700 font-bold rounded-xl text-xs">ğŸ“Š å¯¼å‡º Excel æŠ¥è¡¨</button>
                    <button @click="resetApp" class="w-full py-3 bg-red-50 text-red-500 font-bold rounded-xl text-xs mt-2">âš ï¸ æ¸…ç©ºå¹¶é‡ç½® APP</button>
                </div>
            </div>

        </main>

        <!-- åº•éƒ¨å¯¼èˆª (Bottom Nav) -->
        <nav class="bg-white/90 backdrop-blur border-t border-slate-200 flex justify-around items-center h-20 safe-area-bottom z-30 px-2 shadow-[0_-4px_20px_rgba(0,0,0,0.02)]">
            <button @click="currentTab='home'" :class="currentTab==='home'?'text-slate-800':'text-slate-400'" class="flex flex-col items-center gap-1 w-16 transition-all active:scale-90">
                <span class="text-2xl mb-0.5">ğŸ </span><span class="text-[10px] font-bold">æ˜ç»†</span>
            </button>
            <div class="relative -top-6">
                <button @click="openTxModal(null)" class="w-16 h-16 rounded-[20px] bg-slate-800 text-white shadow-2xl flex items-center justify-center text-3xl border-4 border-slate-50 active:scale-90 transition hover:rotate-90 duration-300">ï¼‹</button>
            </div>
            <button @click="currentTab='stats'; nextTick(()=>renderStats())" :class="currentTab==='stats'?'text-slate-800':'text-slate-400'" class="flex flex-col items-center gap-1 w-16 transition-all active:scale-90">
                <span class="text-2xl mb-0.5">ğŸ“Š</span><span class="text-[10px] font-bold">æŠ¥è¡¨</span>
            </button>
            <button @click="currentTab='mine'" :class="currentTab==='mine'?'text-slate-800':'text-slate-400'" class="flex flex-col items-center gap-1 w-16 transition-all active:scale-90">
                <span class="text-2xl mb-0.5">ğŸ‘¤</span><span class="text-[10px] font-bold">æˆ‘çš„</span>
            </button>
        </nav>

        <!-- è®°è´¦å¼¹çª— (Full) -->
        <transition name="slide">
        <div v-if="showTxModal" class="fixed inset-0 z-50 bg-slate-50 flex flex-col safe-area-top safe-area-bottom">
            <div class="bg-white p-4 flex justify-between items-center border-b border-slate-100 shadow-sm z-10">
                <button @click="showTxModal=false" class="text-slate-400 font-bold text-sm px-2">å–æ¶ˆ</button>
                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <button v-for="t in ['expense','income','transfer']" :key="t" @click="newTx.type=t" 
                        :class="newTx.type===t ? (t==='expense'?'bg-white shadow text-emerald-500':(t==='income'?'bg-white shadow text-red-500':'bg-white shadow text-blue-500')) : 'text-slate-400'"
                        class="px-4 py-1.5 rounded-lg text-xs font-bold transition capitalize">
                        {{t==='expense'?'æ”¯å‡º':(t==='income'?'æ”¶å…¥':'è½¬è´¦')}}
                    </button>
                </div>
                <button @click="confirmTx" class="text-blue-600 font-bold text-sm px-2">ä¿å­˜</button>
            </div>
            
            <div class="bg-white p-6 text-center shadow-sm z-10">
                <div class="text-xs text-slate-400 font-bold uppercase mb-1">Amount</div>
                <div class="flex justify-center items-end gap-1">
                    <span class="text-3xl font-bold mb-2 text-slate-300">Â¥</span>
                    <input type="number" v-model.number="newTx.amount" class="text-6xl font-black text-center outline-none w-64 bg-transparent text-slate-800" placeholder="0" autofocus>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- è´¦æˆ·é€‰æ‹© -->
                <div v-if="newTx.type === 'transfer'">
                    <div class="flex items-center gap-2 justify-between">
                        <div class="w-1/2">
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">ä» (è½¬å‡º)</p>
                            <select v-model="newTx.fromId" class="w-full bg-white p-3 rounded-xl text-sm font-bold border border-slate-200 outline-none">
                                <option value="cash">ğŸ‘› ç°é‡‘</option><option value="debit">ğŸ’³ å‚¨è“„å¡</option>
                            </select>
                        </div>
                        <div class="text-xl text-slate-300 mt-4">â”</div>
                        <div class="w-1/2">
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">åˆ° (è½¬å…¥)</p>
                            <select v-model="newTx.toId" class="w-full bg-white p-3 rounded-xl text-sm font-bold border border-slate-200 outline-none">
                                <option value="cash">ğŸ‘› ç°é‡‘</option><option value="debit">ğŸ’³ å‚¨è“„å¡</option>
                                <option v-for="c in creditCards" :key="c.id" :value="c.id">ğŸ’³ {{c.name}}</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div v-else>
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">è´¦æˆ·</p>
                    <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                        <button @click="newTx.accountId='cash'" :class="newTx.accountId==='cash'?'bg-slate-800 text-white':'bg-white text-slate-500 border'" class="px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap shadow-sm transition">ğŸ‘› ç°é‡‘</button>
                        <button @click="newTx.accountId='debit'" :class="newTx.accountId==='debit'?'bg-slate-800 text-white':'bg-white text-slate-500 border'" class="px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap shadow-sm transition">ğŸ’³ å‚¨è“„å¡</button>
                        <button v-for="c in creditCards" :key="c.id" @click="newTx.accountId=c.id" :class="newTx.accountId===c.id?'bg-slate-800 text-white':'bg-white text-slate-500 border'" class="px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap shadow-sm transition">ğŸ’³ {{c.name}}</button>
                        <button v-if="newTx.type!=='expense'" v-for="l in loans" :key="l.id" @click="newTx.accountId=l.id" :class="newTx.accountId===l.id?'bg-slate-800 text-white':'bg-white text-slate-500 border'" class="px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap shadow-sm transition">ğŸ  {{l.name}}</button>
                    </div>
                </div>

                <!-- åˆ†ç±» (éè½¬è´¦) -->
                <div v-if="newTx.type !== 'transfer'">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">åˆ†ç±»</p>
                    <div class="grid grid-cols-5 gap-3">
                        <div v-for="cat in currentCategories" :key="cat.name" @click="newTx.category=cat.name; newTx.icon=cat.icon" class="flex flex-col items-center gap-1 transition active:scale-95" :class="{'opacity-100': newTx.category===cat.name, 'opacity-40 grayscale': newTx.category!==cat.name}">
                            <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-2xl shadow-sm transition duration-300" :class="newTx.category===cat.name?'bg-white border-2 border-slate-800 shadow-md':'bg-white border border-slate-100'">{{cat.icon}}</div>
                            <span class="text-[10px] font-bold text-slate-600">{{cat.name}}</span>
                        </div>
                    </div>
                </div>

                <!-- æ‚é¡¹ (æ—¥æœŸã€é¡¹ç›®ã€å¤‡æ³¨) -->
                <div class="space-y-3">
                    <div class="flex gap-3">
                        <input type="date" v-model="newTx.date" class="bg-white p-3 rounded-xl text-xs font-bold text-slate-600 outline-none border border-slate-100 shadow-sm w-1/2">
                        <select v-model="newTx.project" class="bg-white p-3 rounded-xl text-xs font-bold text-slate-600 outline-none border border-slate-100 shadow-sm w-1/2">
                            <option value="">æ— é¡¹ç›®</option>
                            <option v-for="p in settings.projects" :key="p" :value="p">{{p}}</option>
                        </select>
                    </div>
                    <input type="text" v-model="newTx.desc" class="w-full bg-white p-3 rounded-xl text-xs font-bold text-slate-600 outline-none border border-slate-100 shadow-sm" placeholder="æ·»åŠ å¤‡æ³¨...">
                </div>

                <div v-if="editingTx" class="pt-4"><button @click="deleteTx" class="w-full py-4 bg-red-50 text-red-500 font-bold rounded-2xl text-sm border border-red-100">ğŸ—‘ï¸ åˆ é™¤æ­¤è®°å½•</button></div>
            </div>
        </div>
        </transition>

    </div>
</div>

<script>
    const { createApp, nextTick } = Vue;

    createApp({
        data() {
            return {
                isUnlocked: false, hasLocalData: false, showImport: false, showTxModal: false,
                passwordInput: '', masterKey: '', encryptedString: '', importString: '',
                currentTab: 'home', searchText: '',
                
                // æ•°æ®æ¨¡å‹
                assets: { cash: 0, debit: 0 },
                deposits: [], stocks: [], loans: [], creditCards: [], 
                transactions: [], history: [], 
                settings: { monthlyBudget: 5000, projects: ['è£…ä¿®','æ—…æ¸¸','äººæƒ…','å® ç‰©','æ±½è½¦'] }, // é»˜è®¤é¡¹ç›®
                
                newTx: { type: 'expense', amount: '', category: 'é¤é¥®', icon: 'ğŸ”', desc: '', accountId: 'cash', fromId:'cash', toId:'debit', date: new Date().toISOString().slice(0,10), project: '' },
                editingTx: null,
                ui: { cashOpen: false, creditOpen: true, investOpen: false, loanOpen: false },
                
                categories: {
                    expense: [
                        {name:'é¤é¥®',icon:'ğŸ”'},{name:'è´­ç‰©',icon:'ğŸ›ï¸'},{name:'äº¤é€š',icon:'ğŸš—'},{name:'ä½æˆ¿',icon:'ğŸ '},
                        {name:'å¨±ä¹',icon:'ğŸ®'},{name:'åŒ»ç–—',icon:'ğŸ’Š'},{name:'æ•™è‚²',icon:'ğŸ“'},{name:'å® ç‰©',icon:'ğŸ¾'},
                        {name:'ç¾å¦†',icon:'ğŸ’„'},{name:'è¿åŠ¨',icon:'ğŸƒ'},{name:'ç¤¾äº¤',icon:'ğŸ¥‚'},{name:'æ—…æ¸¸',icon:'âœˆï¸'},
                        {name:'æ•°ç ',icon:'ğŸ“±'},{name:'é€šè®¯',icon:'ğŸ“'},{name:'å…¶ä»–',icon:'ğŸ“'}
                    ],
                    income: [
                        {name:'å·¥èµ„',icon:'ğŸ’°'},{name:'ç†è´¢',icon:'ğŸ“ˆ'},{name:'å…¼èŒ',icon:'ğŸ’¼'},{name:'ç¤¼é‡‘',icon:'ğŸ§§'},
                        {name:'å¥–é‡‘',icon:'ğŸ…'},{name:'æŠ¥é”€',icon:'ğŸ§¾'},{name:'å…¶ä»–',icon:'ğŸ’'}
                    ]
                },
                statsRange: 'month', statsData: { income:0, expense:0, projectStats:[] }, 
                trendChart: null, catChart: null
            }
        },
        computed: {
            currentDate() { return new Date().toLocaleDateString(); },
            cashTotal() { return (this.assets.cash||0) + (this.assets.debit||0); },
            depositTotal() { return this.deposits.reduce((s,i)=>s+(i.amount||0),0); },
            stockTotal() { return this.stocks.reduce((s,i)=>s+((i.shares||0)*(i.price||0)),0); },
            creditTotal() { return this.creditCards.reduce((sum, c) => sum + (c.currentBalance||0) + (c.installments||[]).reduce((is,i)=>is+(i.total-(i.monthlyAmount*(i.paidMonths||0))),0), 0); },
            loanTotal() { return this.loans.reduce((s,i)=>s+(i.total||0),0); },
            totalAssets() { return this.cashTotal + this.depositTotal + this.stockTotal; },
            totalLiabilities() { return this.creditTotal + this.loanTotal; },
            netWorth() { return this.totalAssets - this.totalLiabilities; },
            
            // æŠ¥è¡¨ç”¨çš„æœ¬æœˆç»Ÿè®¡
            monthlyStats() {
                const cm = new Date().toISOString().slice(0,7);
                const income = this.transactions.filter(t=>t.type==='income' && t.date.startsWith(cm)).reduce((s,t)=>s+t.amount,0);
                let expense = this.transactions.filter(t=>t.type==='expense' && t.date.startsWith(cm)).reduce((s,t)=>s+t.amount,0);
                this.loans.forEach(l => expense += (l.monthlyPayment||0));
                this.creditCards.forEach(c => (c.installments||[]).forEach(i => expense += (i.monthlyAmount||0)));
                return { income, expense };
            },
            budgetProgress() { return (this.monthlyStats.expense / (this.settings.monthlyBudget || 1)) * 100; },
            
            currentCategories() { return this.newTx.type === 'expense' ? this.categories.expense : this.categories.income; },
            
            // æœç´¢è¿‡æ»¤
            filteredTransactions() {
                let txs = [...this.transactions].sort((a,b)=>new Date(b.date)-new Date(a.date));
                if(this.searchText) {
                    const low = this.searchText.toLowerCase();
                    txs = txs.filter(t => (t.desc&&t.desc.toLowerCase().includes(low)) || t.amount.toString().includes(low) || (t.project&&t.project.includes(low)));
                }
                return txs.slice(0, 50); // æ€§èƒ½ä¼˜åŒ–
            }
        },
        mounted() {
            if(localStorage.getItem('myWealth_V16')) this.hasLocalData = true;
        },
        methods: {
            unlock() {
                if(!this.passwordInput) return;
                this.masterKey = this.passwordInput;
                const local = localStorage.getItem('myWealth_V16');
                if(local) { if(!this.decryptAndLoad(local)) alert("å¯†ç é”™è¯¯"); } else { this.isUnlocked = true; this.saveData(); }
            },
            decryptAndLoad(str) {
                try {
                    const bytes = CryptoJS.AES.decrypt(str, this.masterKey);
                    const data = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                    Object.assign(this, data);
                    // å…¼å®¹æ€§å¤„ç†
                    if(!this.settings) this.settings = { monthlyBudget: 5000, projects: ['è£…ä¿®','æ—…æ¸¸','äººæƒ…'] };
                    this.isUnlocked = true;
                    return true;
                } catch(e) { return false; }
            },
            
            // === æ ¸å¿ƒï¼šè®°è´¦é€»è¾‘ (å«è½¬è´¦) ===
            openTxModal(tx) { 
                this.editingTx = tx;
                this.newTx = tx ? JSON.parse(JSON.stringify(tx)) : { 
                    type: 'expense', amount: '', category: 'é¤é¥®', icon: 'ğŸ”', desc: '', 
                    accountId: 'cash', fromId: 'cash', toId: 'debit',
                    date: new Date().toISOString().slice(0,10), project: '' 
                };
                this.showTxModal = true; 
            },
            updateAccount(tx, revert=false) {
                const f = revert ? -1 : 1;
                const {type, amount, accountId, fromId, toId} = tx;
                
                if (type === 'transfer') {
                    // è½¬å‡ºè´¦æˆ·å‡å°‘
                    this.modifyBalance(fromId, -amount * f);
                    // è½¬å…¥è´¦æˆ·å¢åŠ 
                    this.modifyBalance(toId, amount * f);
                } else {
                    // æ”¶æ”¯é€»è¾‘
                    // ç°é‡‘/æ´»æœŸï¼šæ”¶å…¥åŠ ï¼Œæ”¯å‡ºå‡
                    if(['cash','debit'].includes(accountId)) {
                        this.modifyBalance(accountId, (type==='income'?amount:-amount)*f);
                    } else {
                        // ä¿¡ç”¨å¡/è´·æ¬¾ï¼šè´Ÿå€ºã€‚æ”¶å…¥(è¿˜æ¬¾)=è´Ÿå€ºå‡ï¼Œæ”¯å‡º=è´Ÿå€ºåŠ 
                        // è‚¡ç¥¨ï¼šæ”¶å…¥(åŠ ä»“)=å€¼åŠ ï¼Œæ”¯å‡º(å‡ä»“)=å€¼å‡
                        let cc=this.creditCards.find(c=>c.id===accountId), st=this.stocks.find(s=>s.id===accountId), ln=this.loans.find(l=>l.id===accountId);
                        if(cc) cc.currentBalance += (type==='expense'?amount:-amount)*f;
                        else if(st) { /* ç®€åŒ–ï¼šè‚¡ç¥¨æš‚ä¸è”åŠ¨ä½™é¢ï¼Œä»…è®°æµæ°´ */ }
                        else if(ln) ln.total += (type==='income'?-amount:amount)*f;
                    }
                }
            },
            modifyBalance(id, delta) {
                if(id==='cash') this.assets.cash += delta;
                else if(id==='debit') this.assets.debit += delta;
                else {
                    let cc=this.creditCards.find(c=>c.id===id);
                    if(cc) cc.currentBalance -= delta; // è½¬å…¥ä¿¡ç”¨å¡=è¿˜æ¬¾=è´Ÿå€ºå‡
                }
            },
            confirmTx() {
                if(!this.newTx.amount) return;
                if(this.editingTx) { this.updateAccount(this.editingTx, true); this.transactions = this.transactions.filter(t=>t.id!==this.editingTx.id); }
                const final = { id: this.editingTx?.id||Date.now(), ...this.newTx };
                this.updateAccount(final);
                this.transactions.push(final);
                this.showTxModal = false;
                this.saveData();
            },
            deleteTx() {
                if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
                this.updateAccount(this.editingTx, true);
                this.transactions = this.transactions.filter(t=>t.id!==this.editingTx.id);
                this.showTxModal = false;
                this.saveData();
            },

            // === æŠ¥è¡¨é€»è¾‘ ===
            renderStats() {
                const ctxTrend = document.getElementById('trendChart');
                const ctxCat = document.getElementById('catChart');
                if(!ctxTrend || !ctxCat) return;
                if(this.trendChart) this.trendChart.destroy();
                if(this.catChart) this.catChart.destroy();

                const now = new Date();
                let startStr = "";
                // è®¡ç®—æ—¥æœŸèŒƒå›´
                if(this.statsRange==='week') { const d=new Date(); d.setDate(d.getDate()-7); startStr=d.toISOString().slice(0,10); }
                else if(this.statsRange==='month') { startStr=now.toISOString().slice(0,7); }
                else { startStr=now.toISOString().slice(0,4); }

                const txs = this.transactions.filter(t => t.date >= startStr && t.type!=='transfer');
                
                // 1. æ€»è®¡
                this.statsData.income = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
                this.statsData.expense = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);

                // 2. é¡¹ç›®ç»Ÿè®¡
                const projMap = {};
                txs.filter(t=>t.type==='expense' && t.project).forEach(t => projMap[t.project] = (projMap[t.project]||0)+t.amount);
                this.statsData.projectStats = Object.entries(projMap).sort((a,b)=>b[1]-a[1]).map(([name, amount])=>({name, amount, percent: Math.round(amount/this.statsData.expense*100)}));

                // 3. åˆ†ç±»å›¾è¡¨
                const catMap = {};
                txs.filter(t=>t.type==='expense').forEach(t => catMap[t.category] = (catMap[t.category]||0)+t.amount);
                const cats = Object.entries(catMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
                
                this.catChart = new Chart(ctxCat, {
                    type: 'doughnut',
                    data: { labels: cats.map(x=>x[0]), datasets: [{ data: cats.map(x=>x[1]), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth:10 } } } }
                });

                // 4. è¶‹åŠ¿å›¾è¡¨ (ç®€åŒ–ä¸ºæ”¶æ”¯æŸ±çŠ¶)
                const days = {};
                txs.forEach(t => { const d=t.date.slice(5); if(!days[d]) days[d]={in:0,out:0}; if(t.type==='income') days[d].in+=t.amount; else days[d].out+=t.amount; });
                const labels = Object.keys(days).sort();
                this.trendChart = new Chart(ctxTrend, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { label:'æ”¯', data: labels.map(d=>days[d].out), backgroundColor:'#10b981', borderRadius:2 },
                            { label:'æ”¶', data: labels.map(d=>days[d].in), backgroundColor:'#ef4444', borderRadius:2 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{display:false}} }
                });
            },

            // é€šç”¨
            manageProjects() {
                const input = prompt("å½“å‰é¡¹ç›®åˆ—è¡¨ (ç”¨é€—å·åˆ†éš”):", this.settings.projects.join(','));
                if(input !== null) { this.settings.projects = input.split(',').map(s=>s.trim()).filter(s=>s); this.saveData(); }
            },
            addCreditCard() { this.creditCards.push({id:Date.now(), name:'', currentBalance:0, installments:[]}); },
            addInstallment(card) {
                const name=prompt("å•†å“å"), total=Number(prompt("æ€»é¢")), months=Number(prompt("æœŸæ•°"));
                if(name&&total&&months) card.installments.push({name, total, months, monthlyAmount:total/months, paidMonths:0});
            },
            removeCreditCard(idx) { if(confirm("åˆ é™¤æ­¤å¡ï¼Ÿ")) this.creditCards.splice(idx,1); },
            calcLoanMonthly(l) { if(l.total && l.years) l.monthlyPayment = Math.round(l.total / (l.years * 12)); },
            getAccountName(id) {
                if(id==='cash') return 'ç°é‡‘'; if(id==='debit') return 'å‚¨è“„å¡';
                return (this.creditCards.concat(this.stocks, this.loans).find(x=>x.id===id)||{}).name || 'æœªçŸ¥';
            },
            getTypeColor(type, bg=false) {
                if(type==='income') return bg ? 'bg-red-50 text-red-500' : 'text-income';
                if(type==='transfer') return bg ? 'bg-blue-50 text-blue-500' : 'text-transfer';
                return bg ? 'bg-emerald-50 text-emerald-500' : 'text-expense';
            },
            toggleAll() { this.ui.cashOpen=!this.ui.cashOpen; this.ui.creditOpen=this.ui.cashOpen; this.ui.investOpen=this.ui.cashOpen; this.ui.loanOpen=this.ui.cashOpen; },
            
            saveData() {
                const today = new Date().toLocaleDateString();
                if(!this.history.find(h=>h.date===today)) { this.history.push({date:today, val:this.netWorth}); if(this.history.length>30) this.history.shift(); }
                else this.history.find(h=>h.date===today).val = this.netWorth;
                const data = { assets:this.assets, deposits:this.deposits, stocks:this.stocks, loans:this.loans, creditCards:this.creditCards, transactions:this.transactions, history:this.history, settings:this.settings };
                const str = CryptoJS.AES.encrypt(JSON.stringify(data), this.masterKey).toString();
                localStorage.setItem('myWealth_V16', str);
                if(this.isUnlocked && this.currentTab==='stats') this.renderStats();
            },
            
            // Backup/File Logic
            exportToFile() {
                const data = localStorage.getItem('myWealth_V16');
                const blob = new Blob([data], { type: 'text/plain' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `wealth_backup_${new Date().toISOString().slice(0,10)}.txt`; a.click();
            },
            handleFileImport(event) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        // Validate format by trying to decrypt
                        const bytes = CryptoJS.AES.decrypt(e.target.result, this.masterKey);
                        JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                        // Valid, save it
                        localStorage.setItem('myWealth_V16', e.target.result);
                        alert("æ¢å¤æˆåŠŸï¼åˆ·æ–°é¡µé¢ç”Ÿæ•ˆã€‚");
                        location.reload();
                    } catch(err) { alert("æ–‡ä»¶æ— æ•ˆæˆ–å¯†ç ä¸åŒ¹é…"); }
                };
                reader.readAsText(event.target.files[0]);
            },
            importData() {
                try {
                    const bytes = CryptoJS.AES.decrypt(this.importString, this.masterKey);
                    const data = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                    Object.assign(this, data);
                    this.saveData();
                    this.showImport = false;
                    alert("æ¢å¤æˆåŠŸ");
                } catch(e){ alert('æ¢å¤å¤±è´¥'); }
            },
            exportToExcel() {
                let csv = "\uFEFFæ—¥æœŸ,ç±»å‹,é‡‘é¢,åˆ†ç±»,é¡¹ç›®,è´¦æˆ·,å¤‡æ³¨\n";
                this.transactions.forEach(t => csv += `${t.date},${t.type==='income'?'æ”¶å…¥':(t.type==='transfer'?'è½¬è´¦':'æ”¯å‡º')},${t.amount},${t.category||'-'},${t.project||'-'},${this.getAccountName(t.accountId)},${t.desc}\n`);
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
                link.download = `è´¦å•_${new Date().toLocaleDateString()}.csv`;
                link.click();
            },
            resetApp() { if(confirm("âš ï¸ ç¡®å®šé‡ç½®ï¼Ÿæ•°æ®å°†æ°¸ä¹…ä¸¢å¤±ï¼")) { localStorage.removeItem('myWealth_V16'); location.reload(); } },
            lockApp() { this.saveData(); this.isUnlocked = false; this.passwordInput = ''; },
            formatNumber(num) { return num ? num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') : '0.00'; }
        }
    }).mount('#app');
</script>
</body>
</html>
