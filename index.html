<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWAè®¾ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8fafc">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/10530/10530467.png"> 
    <title>èµ„äº§ç®¡å®¶ V11.3</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Segoe UI", Roboto, sans-serif; color: #334155; -webkit-tap-highlight-color: transparent; }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .card { background: #ffffff; border-radius: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #f1f5f9; overflow: hidden; }
        .text-income { color: #ef4444; } .text-expense { color: #10b981; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-enter-active, .slide-leave-active { transition: all 0.3s ease; max-height: 800px; opacity: 1; }
        .slide-enter-from, .slide-leave-to { max-height: 0; opacity: 0; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>

<div id="app" class="h-screen w-full flex flex-col bg-slate-50 relative overflow-hidden">

    <!-- ================= 1. ç™»å½• / äº‘é…ç½® ================= -->
    <div v-if="!isUnlocked" class="fixed inset-0 z-50 bg-slate-100 flex flex-col items-center justify-center p-6 safe-area-top overflow-y-auto">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center my-auto">
            <div class="text-6xl mb-4">â˜ï¸</div>
            <h1 class="text-2xl font-bold text-slate-800 mb-2">èµ„äº§ç®¡å®¶ V11.3</h1>
            <p class="text-xs text-slate-500 mb-8">Cloud Sync Â· PWA Â· Zero Knowledge</p>

            <div class="space-y-4">
                <input type="password" v-model="passwordInput" placeholder="è¾“å…¥ä¸»å¯†ç " class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 text-center text-lg font-bold outline-none focus:border-blue-500 transition">
                <button @click="unlock" class="w-full py-4 rounded-xl font-bold text-white shadow-lg text-lg bg-gradient-to-r from-blue-600 to-indigo-600 active:scale-95 transition">
                    {{ cloudConfigured ? 'ç™»å½•å¹¶åŒæ­¥äº‘ç«¯' : (hasLocalData ? 'è§£é”æœ¬åœ°è´¦æœ¬' : 'å¼€å§‹ä½¿ç”¨') }}
                </button>
            </div>

            <!-- åº•éƒ¨åŠŸèƒ½åŒº -->
            <div class="mt-8 pt-6 border-t border-slate-100 space-y-3">
                <button @click="showInstallHelp = true" class="w-full py-2 bg-blue-50 text-blue-600 text-xs font-bold rounded-lg border border-blue-100">
                    ğŸ“± æ‰‹æœº Safari å®‰è£…æ•™ç¨‹
                </button>

                <button @click="showCloudSetup = !showCloudSetup" class="text-xs font-bold text-slate-400 flex items-center justify-center gap-1 mx-auto hover:text-slate-600">
                    {{ cloudConfigured ? 'ğŸŸ¢ äº‘åŒæ­¥å·²é…ç½®' : 'âš™ï¸ é…ç½®äº‘åŒæ­¥' }}
                </button>
                
                <div v-if="showCloudSetup" class="mt-2 text-left bg-slate-50 p-4 rounded-xl border border-slate-200">
                    
                    <!-- æ•™ç¨‹æŠ˜å åŒº -->
                    <div class="mb-4 border-b border-slate-200 pb-4">
                        <button @click="showTutorial = !showTutorial" class="text-xs font-bold text-blue-500 flex items-center gap-1">
                            â“ å¦‚ä½•è·å–é…ç½®ä»£ç ï¼Ÿ(ç‚¹å‡»å±•å¼€)
                        </button>
                        <div v-if="showTutorial" class="mt-3 text-[10px] text-slate-600 space-y-2 leading-relaxed bg-white p-3 rounded border border-slate-100">
                            <p>1. è®¿é—® <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-500 underline">Firebase æ§åˆ¶å°</a> å¹¶ç™»å½• Google è´¦å·ã€‚</p>
                            <p>2. ç‚¹å‡» <b>Create a project</b>ï¼Œè¾“å…¥åå­—ä¸€ç›´ä¸‹ä¸€æ­¥ã€‚</p>
                            <p>3. é¡¹ç›®å»ºå¥½åï¼Œç‚¹å‡»å·¦ä¾§èœå• <b>Build -> Firestore Database</b>ï¼Œç‚¹å‡» <b>Create database</b>ï¼Œé€‰æ‹© <b>Start in test mode</b> (æµ‹è¯•æ¨¡å¼)ï¼Œç‚¹å‡» Enableã€‚</p>
                            <p>4. å›åˆ° <b>Project Overview</b> (å·¦ä¸Šè§’é½¿è½® -> Project settings)ã€‚</p>
                            <p>5. åœ¨åº•éƒ¨ "Your apps" ç‚¹å‡» <b>&lt;/&gt; (Web)</b> å›¾æ ‡ã€‚</p>
                            <p>6. æ³¨å†Œ App åï¼Œä½ ä¼šçœ‹åˆ°ä¸€æ®µ `const firebaseConfig = { ... };`ã€‚</p>
                            <p class="font-bold text-red-500">7. åªå¤åˆ¶å¤§æ‹¬å· `{ ... }` åŠå…¶é‡Œé¢çš„å†…å®¹ï¼Œç²˜è´´åˆ°ä¸‹æ–¹ã€‚</p>
                        </div>
                    </div>

                    <p class="text-[10px] text-slate-400 mb-2">ç²˜è´´ Firebase Config (æ”¯æŒç›´æ¥ç²˜è´´ JS å¯¹è±¡)ï¼š</p>
                    <textarea v-model="firebaseConfigInput" class="w-full h-24 text-[10px] bg-white p-2 rounded border resize-none outline-none font-mono" placeholder='{
  apiKey: "AIzaSy...",
  authDomain: "...",
  projectId: "..."
}'></textarea>
                    <div class="mt-2">
                        <label class="text-[10px] text-slate-400">åŒæ­¥ID (è‡ªå®šä¹‰å”¯ä¸€æ ‡è¯†ï¼Œå¦‚å¾®ä¿¡å·):</label>
                        <input v-model="syncId" class="w-full bg-white p-2 rounded border text-xs font-bold" placeholder="ä¾‹å¦‚: user_zhangsan_001">
                    </div>
                    <button @click="saveCloudConfig" class="mt-3 w-full py-2 bg-slate-800 text-white text-xs rounded-lg font-bold">ä¿å­˜é…ç½®</button>
                </div>
                
                <div class="mt-2 text-center">
                    <button @click="resetApp" class="text-[10px] text-red-300 hover:text-red-500">é‡ç½®åº”ç”¨</button>
                </div>
            </div>
        </div>
        
        <!-- å®‰è£…å¸®åŠ©å¼¹çª— -->
        <div v-if="showInstallHelp" class="absolute inset-0 bg-white z-50 p-6 flex flex-col items-center justify-center text-center">
            <h3 class="text-lg font-bold text-slate-800 mb-4">å¦‚ä½•åœ¨ iPhone ä¸Šå®‰è£…ï¼Ÿ</h3>
            <div class="text-left text-xs text-slate-600 space-y-4 bg-slate-50 p-4 rounded-xl mb-6 leading-relaxed">
                <p>iOS å®‰å…¨é™åˆ¶å¯¼è‡´æ— æ³•ç›´æ¥ç”¨ Safari æ‰“å¼€æœ¬åœ° HTML æ–‡ä»¶ã€‚æ‚¨éœ€è¦ä¸€ä¸ªâ€œç½‘ç»œé“¾æ¥â€ã€‚</p>
                <div class="space-y-2">
                    <p class="font-bold text-slate-800">âœ… æ¨èæ–¹æ³• (30ç§’):</p>
                    <ol class="list-decimal pl-4 space-y-1">
                        <li>ç”µè„‘è®¿é—® <b>tiiny.host</b> (å…è´¹)ã€‚</li>
                        <li>å°†æœ¬ HTML æ–‡ä»¶æ‹–è¿›å»ï¼Œç”Ÿæˆä¸€ä¸ªé“¾æ¥ã€‚</li>
                        <li>ç”¨ iPhone Safari æ‰“å¼€è¯¥é“¾æ¥ã€‚</li>
                        <li>ç‚¹å‡»åº•éƒ¨ <span class="font-bold">åˆ†äº«æŒ‰é’®</span> -> <span class="font-bold">æ·»åŠ åˆ°ä¸»å±å¹•</span>ã€‚</li>
                    </ol>
                </div>
            </div>
            <button @click="showInstallHelp = false" class="px-6 py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg">å…³é—­</button>
        </div>
    </div>

    <!-- ================= 2. ä¸»ç•Œé¢ (APPå¸ƒå±€) ================= -->
    <div v-else class="flex-1 flex flex-col h-full safe-area-top safe-area-bottom">
        <!-- Header -->
        <header class="px-6 pt-4 pb-2 bg-white flex justify-between items-center shadow-sm z-10">
            <div><div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">NET WORTH</div><div class="text-2xl font-black text-slate-800">Â¥{{ formatNumber(netWorth) }}</div></div>
            <div class="flex gap-3">
                <button @click="forceSync" class="w-8 h-8 rounded-full bg-slate-50 border border-slate-200 flex items-center justify-center text-sm shadow-sm active:scale-90 transition">{{ isSyncing ? 'â³' : (cloudConfigured ? 'ğŸŸ¢' : 'â˜ï¸') }}</button>
                <button @click="lockApp" class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center text-xs shadow-lg active:scale-90 transition">ğŸ”’</button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 pb-24">
            <div class="grid grid-cols-2 gap-3">
                <div class="card p-3 bg-red-50 border-red-100 flex flex-col justify-center"><span class="text-[10px] text-red-400 font-bold mb-1">æœ¬æœˆæ”¶å…¥</span><span class="text-lg font-bold text-red-600 truncate">Â¥{{ formatNumber(monthlyStats.income) }}</span></div>
                <div class="card p-3 bg-emerald-50 border-emerald-100 flex flex-col justify-center"><span class="text-[10px] text-emerald-400 font-bold mb-1">æœ¬æœˆæ”¯å‡º</span><span class="text-lg font-bold text-emerald-600 truncate">Â¥{{ formatNumber(monthlyStats.expense) }}</span></div>
            </div>
            <div class="card p-4"><h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Trend</h3><div class="h-32 w-full"><canvas id="mainChart"></canvas></div></div>

            <div class="space-y-3">
                <div class="flex justify-between items-end px-1"><h3 class="font-bold text-slate-700 text-sm">è´¦æˆ·èµ„äº§</h3><button @click="toggleAll" class="text-[10px] text-blue-500 font-bold">å±•å¼€å…¨éƒ¨</button></div>
                <!-- ç°é‡‘ -->
                <div class="card"><div class="p-3 flex justify-between items-center bg-white active:bg-slate-50 transition" @click="ui.cashOpen=!ui.cashOpen"><div class="flex items-center gap-3"><div class="w-9 h-9 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center text-lg">ğŸ‘›</div><div><div class="font-bold text-slate-700 text-sm">ç°é‡‘é’±åŒ…</div><div class="text-[10px] text-slate-400">Â¥{{formatNumber(cashTotal)}}</div></div></div><span class="text-slate-300 text-xs" :class="ui.cashOpen?'rotate-180':''">â–¼</span></div><div v-if="ui.cashOpen" class="bg-slate-50 p-3 space-y-2 border-t border-slate-100"><div class="flex justify-between items-center"><span class="text-xs text-slate-500 ml-2">ç°é‡‘</span><input v-model.number="assets.cash" type="number" class="text-right text-xs font-bold bg-transparent outline-none w-24"></div><div class="flex justify-between items-center"><span class="text-xs text-slate-500 ml-2">æ´»æœŸ/å¡</span><input v-model.number="assets.debit" type="number" class="text-right text-xs font-bold bg-transparent outline-none w-24"></div></div></div>
                <!-- ä¿¡ç”¨å¡ -->
                <div class="card"><div class="p-3 flex justify-between items-center bg-white active:bg-slate-50 transition" @click="ui.creditOpen=!ui.creditOpen"><div class="flex items-center gap-3"><div class="w-9 h-9 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center text-lg">ğŸ’³</div><div><div class="font-bold text-slate-700 text-sm">ä¿¡ç”¨å¡</div><div class="text-[10px] text-slate-400">è´Ÿå€º: <span class="text-emerald-500">Â¥{{formatNumber(creditTotal)}}</span></div></div></div><span class="text-slate-300 text-xs" :class="ui.creditOpen?'rotate-180':''">â–¼</span></div><div v-if="ui.creditOpen" class="bg-slate-50 p-3 space-y-3 border-t border-slate-100"><div v-for="(cc,i) in creditCards" :key="cc.id" class="bg-white p-2 rounded border border-slate-200"><div class="flex justify-between mb-1"><input v-model="cc.name" class="font-bold text-xs bg-transparent outline-none" placeholder="å¡å"><button @click="creditCards.splice(i,1)" class="text-red-300 text-xs">Ã—</button></div><div class="flex justify-between text-xs items-center"><span class="text-slate-400 text-[10px]">è´¦å•</span><input v-model.number="cc.currentBalance" class="text-right font-bold text-emerald-500 bg-transparent outline-none w-20"></div><div v-if="cc.installments?.length" class="mt-1 pt-1 border-t border-dashed border-slate-100"><div v-for="(inst,ii) in cc.installments" :key="ii" class="flex justify-between text-[10px] text-slate-500"><span>{{inst.name}}</span><span>æœˆä¾›:{{Math.round(inst.monthlyAmount)}}</span></div></div><button @click="addInstallment(cc)" class="w-full mt-1 text-[10px] text-blue-400 text-right">+ åˆ†æœŸ</button></div><button @click="addCreditCard" class="w-full py-1.5 bg-white border border-dashed border-slate-300 text-xs text-slate-400 rounded hover:border-blue-400 hover:text-blue-500 transition">+ æ·»åŠ å¡ç‰‡</button></div></div>
                <!-- æŠ•èµ„ç»„ -->
                <div class="grid grid-cols-3 gap-2"><div class="card p-2 flex flex-col items-center justify-center active:scale-95 transition" @click="ui.depositOpen=!ui.depositOpen"><span class="text-lg">ğŸ¦</span><span class="text-[10px] text-slate-400">å®šæœŸ</span><span class="text-xs font-bold">Â¥{{formatNumber(depositTotal)}}</span></div><div class="card p-2 flex flex-col items-center justify-center active:scale-95 transition" @click="ui.stockOpen=!ui.stockOpen"><span class="text-lg">ğŸ“ˆ</span><span class="text-[10px] text-slate-400">è‚¡ç¥¨</span><span class="text-xs font-bold text-amber-500">Â¥{{formatNumber(stockTotal)}}</span></div><div class="card p-2 flex flex-col items-center justify-center active:scale-95 transition" @click="ui.loanOpen=!ui.loanOpen"><span class="text-lg">ğŸ </span><span class="text-[10px] text-slate-400">è´·æ¬¾</span><span class="text-xs font-bold text-emerald-500">-Â¥{{formatNumber(loanTotal)}}</span></div></div>
                <!-- è¯¦æƒ… -->
                <div v-if="ui.depositOpen" class="card p-3 bg-slate-50"><h4 class="text-[10px] font-bold text-slate-400 mb-2">å®šæœŸå­˜å•</h4><div v-for="(d,i) in deposits" :key="i" class="flex gap-2 mb-2"><input v-model="d.name" class="bg-white p-1 rounded text-xs w-1/3" placeholder="åç§°"><input v-model.number="d.amount" type="number" class="bg-white p-1 rounded text-xs flex-1 text-right"><button @click="deposits.splice(i,1)" class="text-slate-300">Ã—</button></div><button @click="deposits.push({name:'',amount:0})" class="text-[10px] text-blue-500 block w-full text-center">+ æ·»åŠ </button></div>
                <div v-if="ui.stockOpen" class="card p-3 bg-slate-50"><h4 class="text-[10px] font-bold text-slate-400 mb-2">è‚¡ç¥¨æŒä»“</h4><div v-for="(s,i) in stocks" :key="i" class="bg-white p-2 rounded mb-2 border border-slate-200 relative"><button @click="stocks.splice(i,1)" class="absolute top-1 right-1 text-slate-300">Ã—</button><div class="flex gap-2 mb-1"><input v-model="s.name" class="text-xs font-bold w-1/2" placeholder="åç§°"><input v-model="s.code" class="text-xs text-slate-400 w-1/3 uppercase" placeholder="ä»£ç "></div><div class="flex gap-2"><input v-model.number="s.shares" type="number" class="bg-slate-50 text-xs w-1/2 p-1 rounded" placeholder="è‚¡"><input v-model.number="s.price" type="number" class="bg-slate-50 text-xs w-1/2 p-1 rounded text-amber-500" placeholder="ä»·"></div></div><button @click="stocks.push({id:Date.now(),name:'',code:'',shares:0,price:0})" class="text-[10px] text-blue-500 block w-full text-center">+ æ·»åŠ </button></div>
                <div v-if="ui.loanOpen" class="card p-3 bg-slate-50"><h4 class="text-[10px] font-bold text-slate-400 mb-2">è´·æ¬¾é¡¹ç›®</h4><div v-for="(l,i) in loans" :key="i" class="bg-white p-2 rounded mb-2 border border-slate-200 relative"><button @click="loans.splice(i,1)" class="absolute top-1 right-1 text-slate-300">Ã—</button><div class="flex justify-between mb-1"><input v-model="l.name" class="text-xs font-bold w-1/2" placeholder="åç§°"><input v-model.number="l.total" class="text-xs font-bold text-right text-orange-500 w-1/3" placeholder="ä½™é¢"></div><div class="flex gap-2 text-[10px] text-slate-400"><span>å¹´:</span><input v-model.number="l.years" class="w-6 bg-slate-50 text-center" @input="calcLoanMonthly(l)"><span>æœˆä¾›:</span><input v-model.number="l.monthlyPayment" class="w-10 bg-slate-50 text-center"></div></div><button @click="loans.push({id:Date.now(),name:'',total:0,years:20,monthlyPayment:0})" class="text-[10px] text-blue-500 block w-full text-center">+ æ·»åŠ </button></div>
            </div>

            <div class="pb-6">
                <h3 class="font-bold text-slate-700 text-sm mb-2 px-1">æœ€è¿‘è´¦å•</h3>
                <div class="space-y-2">
                    <div v-for="tx in recentTransactions" :key="tx.id" @click="openTxModal(tx)" class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm active:bg-slate-50 transition">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full flex items-center justify-center text-sm" :class="tx.type==='income'?'bg-red-50':'bg-emerald-50'">{{ tx.icon }}</div><div><div class="font-bold text-slate-700 text-xs">{{ tx.category }} <span v-if="tx.desc" class="font-normal text-slate-400">- {{tx.desc}}</span></div><div class="text-[10px] text-slate-400">{{ tx.date.slice(5) }} Â· {{ getAccountName(tx.accountId) }}</div></div></div>
                        <span class="font-bold text-sm font-mono" :class="tx.type==='income'?'text-income':'text-expense'">{{ tx.type==='income' ? '+' : '-' }}{{ formatNumber(tx.amount) }}</span>
                    </div>
                </div>
            </div>
        </main>

        <div class="fixed bottom-8 left-0 right-0 flex justify-center pointer-events-none z-20"><button @click="openTxModal(null)" class="pointer-events-auto w-16 h-16 rounded-full bg-slate-800 text-white shadow-2xl flex items-center justify-center text-3xl active:scale-90 transition transform hover:bg-slate-900 border-4 border-slate-50">+</button></div>

        <!-- è®°è´¦ Modal -->
        <transition name="slide">
        <div v-if="showTxModal" class="fixed inset-0 z-50 bg-white flex flex-col safe-area-top safe-area-bottom">
            <div class="p-4 flex justify-between items-center border-b border-slate-50"><button @click="showTxModal=false" class="text-slate-400 p-2">å–æ¶ˆ</button><div class="flex bg-slate-100 p-1 rounded-lg"><button @click="newTx.type='expense'" :class="newTx.type==='expense'?'bg-white shadow text-emerald-500':'text-slate-400'" class="px-4 py-1 rounded text-xs font-bold transition">æ”¯å‡º</button><button @click="newTx.type='income'" :class="newTx.type==='income'?'bg-white shadow text-red-500':'text-slate-400'" class="px-4 py-1 rounded text-xs font-bold transition">æ”¶å…¥</button></div><button @click="confirmTx" class="text-blue-600 font-bold p-2">ä¿å­˜</button></div>
            <div class="p-6 text-center border-b border-slate-50"><div class="flex justify-center items-end gap-1"><span class="text-2xl font-bold mb-1 text-slate-400">Â¥</span><input type="number" v-model.number="newTx.amount" class="text-5xl font-black text-center outline-none w-48 bg-transparent" placeholder="0" autofocus></div></div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50">
                <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-2">é€‰æ‹©è´¦æˆ·</p><div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar"><button @click="newTx.accountId='cash'" :class="newTx.accountId==='cash'?'bg-slate-800 text-white':'bg-white text-slate-500 border border-slate-200'" class="px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap shadow-sm">ğŸ‘› ç°é‡‘</button><button @click="newTx.accountId='debit'" :class="newTx.accountId==='debit'?'bg-slate-800 text-white':'bg-white text-slate-500 border border-slate-200'" class="px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap shadow-sm">ğŸ’³ å‚¨è“„å¡</button><button v-for="cc in creditCards" :key="cc.id" @click="newTx.accountId=cc.id" :class="newTx.accountId===cc.id?'bg-slate-800 text-white':'bg-white text-slate-500 border border-slate-200'" class="px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap shadow-sm">ğŸ’³ {{cc.name}}</button><button v-for="s in stocks" :key="s.id" @click="newTx.accountId=s.id" :class="newTx.accountId===s.id?'bg-slate-800 text-white':'bg-white text-slate-500 border border-slate-200'" class="px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap shadow-sm">ğŸ“ˆ {{s.name}}</button><button v-for="l in loans" :key="l.id" @click="newTx.accountId=l.id" :class="newTx.accountId===l.id?'bg-slate-800 text-white':'bg-white text-slate-500 border border-slate-200'" class="px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap shadow-sm">ğŸ  {{l.name}}</button></div></div>
                <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-2">åˆ†ç±»</p><div class="grid grid-cols-5 gap-3"><div v-for="cat in currentCategories" :key="cat.name" @click="newTx.category=cat.name; newTx.icon=cat.icon" class="flex flex-col items-center gap-1 transition active:scale-95" :class="{'opacity-100': newTx.category===cat.name, 'opacity-50': newTx.category!==cat.name}"><div class="w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-sm" :class="newTx.category===cat.name?'bg-white border-2 border-blue-500':'bg-white'">{{cat.icon}}</div><span class="text-[10px] font-medium">{{cat.name}}</span></div></div></div>
                <div class="space-y-3"><input type="date" v-model="newTx.date" class="w-full bg-white p-3 rounded-xl text-sm font-bold text-slate-600 outline-none border border-slate-200"><input type="text" v-model="newTx.desc" class="w-full bg-white p-3 rounded-xl text-sm font-bold text-slate-600 outline-none border border-slate-200" placeholder="å¤‡æ³¨..."></div>
                <div v-if="editingTx" class="pt-4"><button @click="deleteTx" class="w-full py-3 bg-red-50 text-red-500 font-bold rounded-xl text-sm">åˆ é™¤æ­¤è®°å½•</button></div>
            </div>
        </div>
        </transition>
    </div>
</div>

<!-- Firebase Modular SDK -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    
    window.initFirebaseServices = (config) => {
        try {
            const app = initializeApp(config);
            window.db = getFirestore(app);
            window.dbHelpers = { doc, getDoc, setDoc };
            return true;
        } catch(e) { console.error(e); return false; }
    };
</script>

<script>
    const { createApp, nextTick } = Vue;

    createApp({
        data() {
            return {
                isUnlocked: false, hasLocalData: false, showCloudSetup: false, showTxModal: false, showInstallHelp: false, showTutorial: false,
                passwordInput: '', firebaseConfigInput: '', syncId: '', masterKey: '', encryptedString: '',
                isSyncing: false, cloudConfigured: false,
                
                assets: { cash: 0, debit: 0 },
                deposits: [], stocks: [], loans: [], creditCards: [], 
                transactions: [], history: [], 
                
                newTx: { type: 'expense', amount: '', category: 'é¤é¥®', icon: 'ğŸ”', desc: '', accountId: 'cash', date: new Date().toISOString().slice(0,10) },
                editingTx: null,
                ui: { cashOpen: false, creditOpen: true, depositOpen: false, stockOpen: false, loanOpen: false },
                
                categories: {
                    expense: [
                        {name:'é¤é¥®',icon:'ğŸ”'},{name:'è´­ç‰©',icon:'ğŸ›ï¸'},{name:'äº¤é€š',icon:'ğŸš—'},{name:'ä½æˆ¿',icon:'ğŸ '},
                        {name:'å¨±ä¹',icon:'ğŸ®'},{name:'åŒ»ç–—',icon:'ğŸ’Š'},{name:'æ•™è‚²',icon:'ğŸ“'},{name:'è¿˜æ¬¾',icon:'ğŸ’¸'},
                        {name:'å® ç‰©',icon:'ğŸ¾'},{name:'ç¾å¦†',icon:'ğŸ’„'},{name:'è¿åŠ¨',icon:'ğŸƒ'},{name:'ç¤¾äº¤',icon:'ğŸ¥‚'},
                        {name:'æ—…æ¸¸',icon:'âœˆï¸'},{name:'æ•°ç ',icon:'ğŸ“±'},{name:'é€šè®¯',icon:'ğŸ“'},{name:'å…¶ä»–',icon:'ğŸ“'}
                    ],
                    income: [
                        {name:'å·¥èµ„',icon:'ğŸ’°'},{name:'ç†è´¢',icon:'ğŸ“ˆ'},{name:'å…¼èŒ',icon:'ğŸ’¼'},{name:'å€Ÿå…¥',icon:'ğŸ™‹'},
                        {name:'å¥–é‡‘',icon:'ğŸ…'},{name:'æŠ¥é”€',icon:'ğŸ§¾'},{name:'å…¶ä»–',icon:'ğŸ§§'}
                    ]
                },
                chartInstance: null
            }
        },
        computed: {
            cashTotal() { return (this.assets.cash||0) + (this.assets.debit||0); },
            depositTotal() { return this.deposits.reduce((s,i)=>s+(i.amount||0),0); },
            stockTotal() { return this.stocks.reduce((s,i)=>s+((i.shares||0)*(i.price||0)),0); },
            creditTotal() { return this.creditCards.reduce((sum, c) => sum + (c.currentBalance||0) + (c.installments||[]).reduce((is,i)=>is+(i.total-(i.monthlyAmount*(i.paidMonths||0))),0), 0); },
            loanTotal() { return this.loans.reduce((s,i)=>s+(i.total||0),0); },
            totalAssets() { return this.cashTotal + this.depositTotal + this.stockTotal; },
            totalLiabilities() { return this.creditTotal + this.loanTotal; },
            netWorth() { return this.totalAssets - this.totalLiabilities; },
            currentCategories() { return this.newTx.type === 'expense' ? this.categories.expense : this.categories.income; },
            recentTransactions() { return [...this.transactions].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,20); },
            monthlyStats() {
                const cm = new Date().toISOString().slice(0,7);
                const income = this.transactions.filter(t=>t.type==='income' && t.date.startsWith(cm)).reduce((s,t)=>s+t.amount,0);
                let expense = this.transactions.filter(t=>t.type==='expense' && t.date.startsWith(cm)).reduce((s,t)=>s+t.amount,0);
                this.loans.forEach(l => expense += (l.monthlyPayment||0));
                this.creditCards.forEach(c => (c.installments||[]).forEach(i => expense += (i.monthlyAmount||0)));
                return { income, expense };
            }
        },
        mounted() {
            if(localStorage.getItem('myWealth_V11')) this.hasLocalData = true;
            const cloudCfg = localStorage.getItem('myWealth_Cloud');
            if(cloudCfg) {
                const parsed = JSON.parse(cloudCfg);
                this.firebaseConfigInput = JSON.stringify(parsed.config);
                this.syncId = parsed.syncId;
                this.initCloud(parsed.config);
            }
        },
        methods: {
            initCloud(config) { if(window.initFirebaseServices && window.initFirebaseServices(config)) this.cloudConfigured = true; },
            saveCloudConfig() {
                try {
                    let config;
                    try {
                        config = JSON.parse(this.firebaseConfigInput);
                    } catch (e) {
                        try {
                            const jsonStr = this.firebaseConfigInput
                                .replace(/(\w+):/g, '"$1":')
                                .replace(/'/g, '"')
                                .replace(/,\s*}/g, '}');
                            config = JSON.parse(jsonStr);
                        } catch (e2) {
                             config = new Function("return " + this.firebaseConfigInput)();
                        }
                    }
                    
                    if (!config || !config.apiKey) throw new Error("æ— æ•ˆçš„é…ç½®å¯¹è±¡");

                    if(!this.syncId) return alert("è¯·è¾“å…¥åŒæ­¥ID");
                    localStorage.setItem('myWealth_Cloud', JSON.stringify({config, syncId: this.syncId}));
                    this.initCloud(config);
                    alert("é…ç½®æˆåŠŸï¼è¯·ç™»å½•ä»¥åŒæ­¥ã€‚");
                    this.showCloudSetup = false;
                } catch(e) { 
                    console.error(e);
                    alert("é…ç½®æ ¼å¼é”™è¯¯: è¯·ç¡®ä¿å¤åˆ¶äº†å®Œæ•´çš„ { ... } å†…å®¹ï¼Œæˆ–è€…æ˜¯æ ‡å‡†çš„ JSON æ ¼å¼ã€‚"); 
                }
            },
            async forceSync() {
                if(!this.cloudConfigured) return alert("è¯·å…ˆé…ç½®äº‘åŒæ­¥");
                this.isSyncing = true;
                await this.syncToCloud();
                await this.syncFromCloud();
                this.isSyncing = false;
            },
            async syncToCloud() {
                if(!this.cloudConfigured || !this.isUnlocked) return;
                const { doc, setDoc } = window.dbHelpers;
                const data = { encrypted: this.encryptedString, timestamp: Date.now() };
                try { await setDoc(doc(window.db, "wealth_data", this.syncId), data); } catch(e) { console.error("Sync Up Fail", e); }
            },
            async syncFromCloud() {
                if(!this.cloudConfigured || !this.isUnlocked) return;
                const { doc, getDoc } = window.dbHelpers;
                try {
                    const snap = await getDoc(doc(window.db, "wealth_data", this.syncId));
                    if(snap.exists()) this.decryptAndLoad(snap.data().encrypted, true);
                } catch(e) { console.error("Sync Down Fail", e); }
            },
            unlock() {
                if(!this.passwordInput) return;
                this.masterKey = this.passwordInput;
                if(this.cloudConfigured) {
                    this.isSyncing = true;
                    this.syncFromCloud().finally(() => { this.isSyncing = false; if(!this.isUnlocked) this.tryLocalUnlock(); });
                } else this.tryLocalUnlock();
            },
            tryLocalUnlock() {
                const local = localStorage.getItem('myWealth_V11');
                if(local) { if(!this.decryptAndLoad(local)) alert("å¯†ç é”™è¯¯"); } else { this.isUnlocked = true; this.saveData(); }
            },
            decryptAndLoad(str, fromCloud=false) {
                try {
                    const bytes = CryptoJS.AES.decrypt(str, this.masterKey);
                    const data = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                    Object.assign(this, data);
                    this.isUnlocked = true;
                    this.encryptedString = str;
                    if(fromCloud) localStorage.setItem('myWealth_V11', str);
                    nextTick(()=>this.renderChart());
                    return true;
                } catch(e) { return false; }
            },
            openTxModal(tx) { 
                this.editingTx = tx;
                this.newTx = tx ? JSON.parse(JSON.stringify(tx)) : { type: 'expense', amount: '', category: 'é¤é¥®', icon: 'ğŸ”', desc: '', accountId: 'cash', date: new Date().toISOString().slice(0,10) };
                this.showTxModal = true; 
            },
            updateAccount(tx, revert=false) {
                const f = revert ? -1 : 1;
                const {type, amount, accountId, extra} = tx;
                if(accountId==='cash') this.assets.cash += (type==='income'?amount:-amount)*f;
                else if(accountId==='debit') this.assets.debit += (type==='income'?amount:-amount)*f;
                else {
                    let cc=this.creditCards.find(c=>c.id===accountId), st=this.stocks.find(s=>s.id===accountId), ln=this.loans.find(l=>l.id===accountId);
                    if(cc) cc.currentBalance += (type==='expense'?amount:-amount)*f;
                    else if(st && st.price>0) st.shares += (type==='income'?1:-1)*(extra?.sharesDelta || amount/st.price)*f;
                    else if(ln) ln.total += (type==='income'?-amount:amount)*f;
                }
            },
            confirmTx() {
                if(!this.newTx.amount) return;
                if(this.editingTx) { this.updateAccount(this.editingTx, true); this.transactions = this.transactions.filter(t=>t.id!==this.editingTx.id); }
                let extra={};
                if(['income','expense'].includes(this.newTx.type)) {
                    const st = this.stocks.find(s=>s.id===this.newTx.accountId);
                    if(st && st.price>0) extra.sharesDelta = this.newTx.amount/st.price;
                }
                const final = { id: this.editingTx?.id||Date.now(), ...this.newTx, extra };
                this.updateAccount(final);
                this.transactions.push(final);
                this.showTxModal = false;
                this.saveData(true);
            },
            deleteTx() {
                if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
                this.updateAccount(this.editingTx, true);
                this.transactions = this.transactions.filter(t=>t.id!==this.editingTx.id);
                this.showTxModal = false;
                this.saveData(true);
            },
            addCreditCard() { this.creditCards.push({id:Date.now(), name:'', currentBalance:0, installments:[]}); },
            addInstallment(card) {
                const name=prompt("å•†å“å"), total=Number(prompt("æ€»é¢")), months=Number(prompt("æœŸæ•°"));
                if(name&&total&&months) card.installments.push({name, total, months, monthlyAmount:total/months, paidMonths:0});
            },
            calcLoanMonthly(l) { if(l.total && l.years) l.monthlyPayment = Math.round(l.total / (l.years * 12)); },
            getAccountName(id) {
                if(id==='cash') return 'ç°é‡‘'; if(id==='debit') return 'æ´»æœŸ';
                return (this.creditCards.concat(this.stocks, this.loans).find(x=>x.id===id)||{}).name || 'æœªçŸ¥';
            },
            toggleAll() { this.ui.cashOpen=!this.ui.cashOpen; this.ui.creditOpen=this.ui.cashOpen; this.ui.depositOpen=this.ui.cashOpen; this.ui.stockOpen=this.ui.cashOpen; this.ui.loanOpen=this.ui.cashOpen; },
            saveData(animate) {
                const today = new Date().toLocaleDateString();
                if(!this.history.find(h=>h.date===today)) { this.history.push({date:today, val:this.netWorth}); if(this.history.length>30) this.history.shift(); }
                else this.history.find(h=>h.date===today).val = this.netWorth;
                const data = { assets:this.assets, deposits:this.deposits, stocks:this.stocks, loans:this.loans, creditCards:this.creditCards, transactions:this.transactions, history:this.history };
                const str = CryptoJS.AES.encrypt(JSON.stringify(data), this.masterKey).toString();
                localStorage.setItem('myWealth_V11', str);
                this.encryptedString = str;
                this.syncToCloud();
                if(this.isUnlocked) this.renderChart();
            },
            resetApp() { if(confirm("ç¡®å®šé‡ç½®ï¼Ÿæ•°æ®å°†ä¸¢å¤±ï¼")) { localStorage.removeItem('myWealth_V11'); location.reload(); } },
            lockApp() { this.saveData(); this.isUnlocked = false; this.passwordInput = ''; },
            importData() {
                this.masterKey = this.passwordInput;
                if(this.decryptAndLoad(this.importString)) { this.saveData(true); this.showImport = false; } else alert("æ¢å¤å¤±è´¥");
            },
            exportToExcel() {
                let csv = "\uFEFFæ—¥æœŸ,ç±»å‹,é‡‘é¢,åˆ†ç±»,è´¦æˆ·,å¤‡æ³¨\n";
                this.transactions.forEach(t => csv += `${t.date},${t.type==='income'?'æ”¶å…¥':'æ”¯å‡º'},${t.amount},${t.category},${this.getAccountName(t.accountId)},${t.desc}\n`);
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
                link.download = `è´¦å•_${new Date().toLocaleDateString()}.csv`;
                link.click();
            },
            renderChart() {
                const ctx = document.getElementById('mainChart');
                if(!ctx) return;
                if(this.chartInstance) this.chartInstance.destroy();
                this.chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels: this.history.map(h=>h.date.slice(5)), datasets: [{ label: 'å‡€èµ„äº§', data: this.history.map(h=>h.val), borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }] },
                    options: { responsive: true, maintainAspectRatio: false, scales:{x:{display:false},y:{display:false}}, plugins:{legend:{display:false}} }
                });
            },
            formatNumber(num) { return num ? num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') : '0.00'; }
        }
    }).mount('#app');
</script>
</body>
</html>