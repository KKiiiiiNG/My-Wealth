<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8fafc">
    <title>èµ„äº§ç®¡å®¶ V15</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* å­—ä½“ä¸åŸºç¡€è®¾ç½® */
        body { background-color: #f1f5f9; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "sf pro display", "Segoe UI", Roboto, sans-serif; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        
        /* å®‰å…¨åŒºåŸŸé€‚é… */
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        /* ç°ä»£å¡ç‰‡é£æ ¼ */
        .card-modern { 
            background: #ffffff; 
            border-radius: 20px; 
            box-shadow: 0 4px 20px rgba(148, 163, 184, 0.1); 
            border: 1px solid #f8fafc;
            overflow: hidden; 
            transition: transform 0.1s;
        }
        .card-modern:active { transform: scale(0.995); }

        /* é¢œè‰²å˜é‡ */
        .text-income { color: #ef4444; } 
        .text-expense { color: #10b981; }
        
        /* åŠ¨ç”» */
        .slide-enter-active, .slide-leave-active { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); max-height: 1000px; opacity: 1; }
        .slide-enter-from, .slide-leave-to { max-height: 0; opacity: 0; }
        
        /* éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>

<div id="app" class="h-screen w-full flex flex-col bg-slate-100 relative overflow-hidden">

    <!-- ================= 1. ç™»å½•ç•Œé¢ (å¤§å­—ç‰ˆ) ================= -->
    <div v-if="!isUnlocked" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 safe-area-top">
        <div class="w-full max-w-sm text-center">
            <div class="text-7xl mb-6">ğŸ”</div>
            <h1 class="text-3xl font-bold text-slate-800 mb-3">èµ„äº§ç®¡å®¶ V15</h1>
            <p class="text-sm text-slate-500 mb-10">æœ¬åœ°åŠ å¯† Â· æè‡´ä½“éªŒ</p>

            <div class="space-y-5">
                <div class="bg-slate-50 rounded-2xl p-2 border border-slate-200 focus-within:border-blue-500 focus-within:ring-2 ring-blue-100 transition">
                    <input type="password" v-model="passwordInput" placeholder="è¾“å…¥ä¸»å¯†ç " class="w-full bg-transparent p-4 text-center text-xl font-bold outline-none text-slate-800 placeholder-slate-400">
                </div>
                <button @click="unlock" class="w-full py-4 rounded-2xl font-bold text-white shadow-xl text-lg bg-slate-900 active:scale-95 transition">
                    {{ hasLocalData ? 'è§£é”è¿›å…¥' : 'åˆå§‹åŒ–å¹¶è®¾ç½®å¯†ç ' }}
                </button>
            </div>

            <!-- åº•éƒ¨åŠŸèƒ½ -->
            <div class="mt-12 space-y-4">
                <button @click="showImport=!showImport" class="text-sm font-medium text-blue-600 bg-blue-50 px-4 py-2 rounded-lg">
                    ğŸ“¤ å¯¼å…¥ / æ¢å¤å¤‡ä»½
                </button>
                <div v-if="showImport" class="animate-fade-in mt-4 bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <textarea v-model="importString" class="w-full h-24 text-xs p-3 rounded-lg border border-slate-300 resize-none outline-none" placeholder="åœ¨æ­¤ç²˜è´´åŠ å¯†æ•°æ®ä¸²..."></textarea>
                    <button @click="importData" class="mt-3 w-full py-3 bg-white border border-slate-300 text-slate-700 text-sm font-bold rounded-lg shadow-sm">ç¡®è®¤æ¢å¤</button>
                </div>
                <div class="pt-4">
                    <button @click="resetApp" class="text-xs text-red-300 px-4 py-2">é‡ç½®åº”ç”¨æ•°æ®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= 2. ä¸»ç•Œé¢ (UI Refresh) ================= -->
    <div v-else class="flex-1 flex flex-col h-full safe-area-top">
        
        <!-- é¡¶éƒ¨èµ„äº§å¤§å¡ç‰‡ (å›ºå®š) -->
        <header class="bg-white px-6 pt-12 pb-6 rounded-b-[32px] shadow-sm z-10 border-b border-slate-100 flex-shrink-0">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <p class="text-xs font-bold text-slate-400 tracking-widest uppercase mb-1">Total Net Worth</p>
                    <h1 class="text-4xl font-black text-slate-800 tracking-tight">
                        <span class="text-2xl font-medium text-slate-400 mr-1">Â¥</span>{{ formatNumber(netWorth) }}
                    </h1>
                </div>
                <!-- ç®€å•çš„è¶‹åŠ¿å›¾å ä½æˆ–çŠ¶æ€ -->
                <div class="bg-slate-50 px-3 py-1.5 rounded-full border border-slate-100 flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-xs font-bold text-slate-500">å·²åŠ å¯†</span>
                </div>
            </div>

            <!-- æœ¬æœˆæ”¶æ”¯å— -->
            <div class="grid grid-cols-2 gap-4 mt-6">
                <div class="bg-red-50/50 p-3 rounded-2xl border border-red-100 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-lg shadow-sm">ğŸ’°</div>
                    <div>
                        <div class="text-xs text-slate-400 font-bold">æœ¬æœˆæ”¶å…¥</div>
                        <div class="text-base font-bold text-red-500">Â¥{{ formatNumber(monthlyStats.income) }}</div>
                    </div>
                </div>
                <div class="bg-emerald-50/50 p-3 rounded-2xl border border-emerald-100 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-lg shadow-sm">ğŸ’¸</div>
                    <div>
                        <div class="text-xs text-slate-400 font-bold">æœ¬æœˆæ”¯å‡º</div>
                        <div class="text-base font-bold text-emerald-500">Â¥{{ formatNumber(monthlyStats.expense) }}</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- å¯æ»šåŠ¨å†…å®¹åŒº -->
        <main class="flex-1 overflow-y-auto p-5 space-y-6 pb-32">
            
            <!-- è¶‹åŠ¿å›¾è¡¨ (ç®€åŒ–ç‰ˆ) -->
            <div class="card-modern p-5">
                <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <span class="w-1 h-4 bg-blue-500 rounded-full"></span> èµ„äº§èµ°åŠ¿ (Movement)
                </h3>
                <div class="h-40 w-full"><canvas id="mainChart"></canvas></div>
            </div>

            <!-- === èµ„äº§æ¨¡å— === -->
            <div class="space-y-4">
                <div class="flex justify-between items-center px-1">
                    <h3 class="font-bold text-lg text-slate-800">æˆ‘çš„è´¦æˆ·</h3>
                    <button @click="toggleAll" class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full">
                        {{ ui.cashOpen ? 'æ”¶èµ·å…¨éƒ¨' : 'å±•å¼€å…¨éƒ¨' }}
                    </button>
                </div>

                <!-- 1. ç°é‡‘ (è“è‰²ç³») -->
                <div class="card-modern border-l-4 border-l-blue-500">
                    <div class="p-5 flex justify-between items-center" @click="ui.cashOpen=!ui.cashOpen">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center text-2xl">ğŸ‘›</div>
                            <div>
                                <div class="font-bold text-base text-slate-700">ç°é‡‘ & æ´»æœŸ</div>
                                <div class="text-xs text-slate-400 mt-0.5">å¯ç”¨ä½™é¢</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg text-slate-800">Â¥{{formatNumber(cashTotal)}}</div>
                            <div class="text-xs text-slate-300 mt-1 transition-transform duration-300" :class="ui.cashOpen?'rotate-180':''">â–¼</div>
                        </div>
                    </div>
                    <!-- è¯¦æƒ… -->
                    <transition name="slide">
                        <div v-if="ui.cashOpen" class="bg-slate-50/80 p-5 pt-2 border-t border-slate-100 space-y-3">
                            <div class="flex justify-between items-center p-3 bg-white rounded-xl shadow-sm border border-slate-100">
                                <span class="text-sm font-bold text-slate-600">ğŸ’µ ç°é‡‘é’±åŒ…</span>
                                <input v-model.number="assets.cash" type="number" class="text-right text-base font-bold bg-transparent outline-none w-32 text-blue-600" placeholder="0">
                            </div>
                            <div class="flex justify-between items-center p-3 bg-white rounded-xl shadow-sm border border-slate-100">
                                <span class="text-sm font-bold text-slate-600">ğŸ’³ å‚¨è“„å¡</span>
                                <input v-model.number="assets.debit" type="number" class="text-right text-base font-bold bg-transparent outline-none w-32 text-blue-600" placeholder="0">
                            </div>
                        </div>
                    </transition>
                </div>

                <!-- 2. ä¿¡ç”¨å¡ (ç«ç‘°çº¢ç³» - å¼ºè°ƒè´Ÿå€º) -->
                <div class="card-modern border-l-4 border-l-rose-500">
                    <div class="p-5 flex justify-between items-center" @click="ui.creditOpen=!ui.creditOpen">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-rose-50 text-rose-600 flex items-center justify-center text-2xl">ğŸ’³</div>
                            <div>
                                <div class="font-bold text-base text-slate-700">ä¿¡ç”¨å¡</div>
                                <div class="text-xs text-slate-400 mt-0.5">æ€»è´Ÿå€º (å«åˆ†æœŸ)</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg text-rose-500">Â¥{{formatNumber(creditTotal)}}</div>
                            <div class="text-xs text-slate-300 mt-1 transition-transform duration-300" :class="ui.creditOpen?'rotate-180':''">â–¼</div>
                        </div>
                    </div>
                    <!-- è¯¦æƒ… -->
                    <transition name="slide">
                        <div v-if="ui.creditOpen" class="bg-slate-50/80 p-5 pt-2 border-t border-slate-100 space-y-4">
                            <div v-for="(cc,i) in creditCards" :key="cc.id" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm relative">
                                <button @click="removeCreditCard(i)" class="absolute top-3 right-3 text-slate-300 hover:text-rose-500">âœ•</button>
                                
                                <div class="mb-3">
                                    <input v-model="cc.name" class="font-bold text-base text-slate-800 bg-transparent outline-none w-3/4" placeholder="å¡ç‰‡åç§° (å¦‚:æ‹›å•†)">
                                </div>

                                <!-- æ´»æœŸéƒ¨åˆ† -->
                                <div class="flex justify-between items-center mb-3 pb-3 border-b border-dashed border-slate-100">
                                    <span class="text-xs font-bold text-slate-400">æœ¬æœŸè´¦å•</span>
                                    <input v-model.number="cc.currentBalance" class="text-right font-bold text-rose-500 text-base bg-transparent outline-none w-24" placeholder="0">
                                </div>

                                <!-- åˆ†æœŸéƒ¨åˆ† -->
                                <div class="bg-slate-50 rounded-lg p-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs font-bold text-slate-500">åˆ†æœŸè®¡åˆ’</span>
                                        <button @click="addInstallment(cc)" class="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded">+ æ–°å¢</button>
                                    </div>
                                    <div v-if="cc.installments?.length === 0" class="text-[10px] text-slate-300 text-center py-1">æ— åˆ†æœŸ</div>
                                    <div v-else class="space-y-2">
                                        <div v-for="(inst,ii) in cc.installments" :key="ii" class="flex justify-between items-center text-xs bg-white p-2 rounded border border-slate-100">
                                            <div>
                                                <div class="font-bold text-slate-700">{{inst.name}}</div>
                                                <div class="text-[10px] text-slate-400">å‰©ä½™: {{formatNumber(inst.total - (inst.monthlyAmount * inst.paidMonths))}}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-bold text-rose-500">-{{Math.round(inst.monthlyAmount)}}/æœˆ</div>
                                                <button @click="cc.installments.splice(ii,1)" class="text-[10px] text-red-300 mt-1">ç»“æŸ</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button @click="addCreditCard" class="w-full py-3 bg-white border border-dashed border-slate-300 text-sm font-bold text-slate-400 rounded-xl hover:text-blue-500 hover:border-blue-400 transition">+ æ·»åŠ æ–°å¡ç‰‡</button>
                        </div>
                    </transition>
                </div>

                <!-- 3. æŠ•èµ„ & è´·æ¬¾ (ç½‘æ ¼å¸ƒå±€) -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- æŠ•èµ„ -->
                    <div class="card-modern border-t-4 border-t-amber-400" @click="ui.stockOpen=!ui.stockOpen">
                        <div class="p-4 text-center">
                            <div class="text-2xl mb-1">ğŸ“ˆ</div>
                            <div class="text-xs font-bold text-slate-400">è‚¡ç¥¨/åŸºé‡‘</div>
                            <div class="text-base font-bold text-amber-500 mt-1">Â¥{{formatNumber(stockTotal)}}</div>
                        </div>
                    </div>
                    <!-- å®šæœŸ -->
                    <div class="card-modern border-t-4 border-t-indigo-400" @click="ui.depositOpen=!ui.depositOpen">
                        <div class="p-4 text-center">
                            <div class="text-2xl mb-1">ğŸ¦</div>
                            <div class="text-xs font-bold text-slate-400">å®šæœŸå­˜æ¬¾</div>
                            <div class="text-base font-bold text-indigo-500 mt-1">Â¥{{formatNumber(depositTotal)}}</div>
                        </div>
                    </div>
                </div>
                
                <!-- è´·æ¬¾ (é•¿æ¡) -->
                <div class="card-modern border-l-4 border-l-orange-500" @click="ui.loanOpen=!ui.loanOpen">
                    <div class="p-4 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">ğŸ </span>
                            <span class="font-bold text-sm text-slate-700">æˆ¿è´· / è´·æ¬¾</span>
                        </div>
                        <span class="font-bold text-orange-500">Â¥{{formatNumber(loanTotal)}}</span>
                    </div>
                </div>

                <!-- éšè—çš„è¯¦æƒ… (ç®€åŒ–å±•ç¤º) -->
                <transition name="slide">
                    <div v-if="ui.stockOpen" class="space-y-2">
                        <div v-for="(s,i) in stocks" :key="i" class="card-modern p-3 flex justify-between items-center">
                            <div><div class="font-bold text-sm">{{s.name}}</div><div class="text-xs text-slate-400 uppercase">{{s.code}}</div></div>
                            <div class="text-right"><div class="font-bold text-amber-500">Â¥{{formatNumber(s.shares*s.price)}}</div><div class="text-[10px] text-slate-400">{{s.shares}}è‚¡ @ {{s.price}}</div></div>
                            <button @click="stocks.splice(i,1)" class="text-red-300 px-2">âœ•</button>
                        </div>
                        <button @click="stocks.push({id:Date.now(),name:'æ–°è‚¡ç¥¨',code:'',shares:0,price:0})" class="w-full py-2 text-xs font-bold text-blue-500 bg-white rounded-lg shadow-sm">+ æ·»åŠ è‚¡ç¥¨</button>
                    </div>
                </transition>
                
                <transition name="slide">
                    <div v-if="ui.depositOpen" class="space-y-2">
                        <div v-for="(d,i) in deposits" :key="i" class="card-modern p-3 flex justify-between items-center">
                            <input v-model="d.name" class="font-bold text-sm bg-transparent outline-none w-1/2" placeholder="å­˜å•å">
                            <input v-model.number="d.amount" class="text-right font-bold text-indigo-500 bg-transparent outline-none w-24">
                            <button @click="deposits.splice(i,1)" class="text-red-300">âœ•</button>
                        </div>
                        <button @click="deposits.push({name:'æ–°å­˜å•',amount:0})" class="w-full py-2 text-xs font-bold text-blue-500 bg-white rounded-lg shadow-sm">+ æ·»åŠ å­˜å•</button>
                    </div>
                </transition>

                <transition name="slide">
                    <div v-if="ui.loanOpen" class="space-y-2">
                        <div v-for="(l,i) in loans" :key="i" class="card-modern p-3">
                            <div class="flex justify-between mb-1">
                                <input v-model="l.name" class="font-bold text-sm bg-transparent outline-none" placeholder="è´·æ¬¾å">
                                <span class="font-bold text-orange-500">-Â¥{{formatNumber(l.total)}}</span>
                            </div>
                            <div class="flex gap-2 text-xs text-slate-400">
                                <span>å‰©ä½™: <input v-model.number="l.total" class="w-16 bg-slate-100 rounded px-1"></span>
                                <span>æœˆä¾›: <input v-model.number="l.monthlyPayment" class="w-12 bg-slate-100 rounded px-1"></span>
                            </div>
                            <button @click="loans.splice(i,1)" class="text-[10px] text-red-300 mt-1">åˆ é™¤è´·æ¬¾</button>
                        </div>
                        <button @click="loans.push({id:Date.now(),name:'æ–°è´·æ¬¾',total:0,years:20,monthlyPayment:0})" class="w-full py-2 text-xs font-bold text-blue-500 bg-white rounded-lg shadow-sm">+ æ·»åŠ è´·æ¬¾</button>
                    </div>
                </transition>

            </div>

            <!-- æœ€è¿‘è´¦å• -->
            <div class="pb-6">
                <h3 class="font-bold text-slate-800 text-base mb-3 px-1">æœ€è¿‘è´¦å•</h3>
                <div class="space-y-3">
                    <div v-for="tx in recentTransactions" :key="tx.id" @click="openTxModal(tx)" 
                        class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between active:scale-98 transition">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl" :class="tx.type==='income'?'bg-red-50':'bg-emerald-50'">{{ tx.icon }}</div>
                            <div>
                                <div class="font-bold text-slate-800 text-sm">{{ tx.category }} <span v-if="tx.desc" class="font-normal text-slate-400 text-xs">- {{tx.desc}}</span></div>
                                <div class="text-[10px] text-slate-400 mt-0.5 font-medium">{{ tx.date.slice(5) }} Â· {{ getAccountName(tx.accountId) }}</div>
                            </div>
                        </div>
                        <span class="font-bold text-base font-mono" :class="tx.type==='income'?'text-income':'text-expense'">
                            {{ tx.type==='income' ? '+' : '-' }}{{ formatNumber(tx.amount) }}
                        </span>
                    </div>
                </div>
            </div>
        </main>

        <!-- ================= 3. åº•éƒ¨å¯¼èˆªæ  (Bottom Dock) ================= -->
        <div class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 pb-safe pt-2 px-6 z-40 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
            <div class="flex justify-between items-center h-16 max-w-lg mx-auto">
                
                <!-- å·¦ä¾§ï¼šåŠŸèƒ½é”® -->
                <button @click="showSyncModal=true" class="flex flex-col items-center gap-1 text-slate-400 hover:text-slate-800 transition p-2">
                    <span class="text-xl">ğŸ“‚</span>
                    <span class="text-[10px] font-bold">å¤‡ä»½</span>
                </button>

                <!-- ä¸­é—´ï¼šå·¨å¤§çš„è®°è´¦æŒ‰é’® (Cä½) -->
                <button @click="openTxModal(null)" class="relative -top-6 w-16 h-16 rounded-full bg-slate-800 text-white shadow-2xl flex items-center justify-center text-3xl border-4 border-slate-100 active:scale-90 transition transform hover:bg-black hover:-translate-y-1">
                    âœï¸
                </button>

                <!-- å³ä¾§ï¼šé”å®šé”® -->
                <button @click="lockApp" class="flex flex-col items-center gap-1 text-slate-400 hover:text-slate-800 transition p-2">
                    <span class="text-xl">ğŸ”’</span>
                    <span class="text-[10px] font-bold">é”å®š</span>
                </button>
            </div>
        </div>

        <!-- è®°è´¦å¼¹çª— (ä¼˜åŒ–) -->
        <transition name="slide">
        <div v-if="showTxModal" class="fixed inset-0 z-50 bg-slate-50 flex flex-col safe-area-top safe-area-bottom">
            <div class="bg-white p-4 flex justify-between items-center border-b border-slate-100">
                <button @click="showTxModal=false" class="text-slate-400 font-bold text-sm px-2">å–æ¶ˆ</button>
                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <button @click="newTx.type='expense'" :class="newTx.type==='expense'?'bg-white shadow text-emerald-500':'text-slate-400'" class="px-5 py-1.5 rounded-lg text-sm font-bold transition">æ”¯å‡º</button>
                    <button @click="newTx.type='income'" :class="newTx.type==='income'?'bg-white shadow text-red-500':'text-slate-400'" class="px-5 py-1.5 rounded-lg text-sm font-bold transition">æ”¶å…¥</button>
                </div>
                <button @click="confirmTx" class="text-blue-600 font-bold text-sm px-2">ä¿å­˜</button>
            </div>
            
            <div class="bg-white p-8 text-center shadow-sm">
                <div class="text-xs text-slate-400 font-bold uppercase mb-2">Amount</div>
                <div class="flex justify-center items-end gap-2">
                    <span class="text-3xl font-bold mb-1 text-slate-300">Â¥</span>
                    <input type="number" v-model.number="newTx.amount" class="text-6xl font-black text-center outline-none w-64 bg-transparent text-slate-800" placeholder="0" autofocus>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                <!-- è´¦æˆ· -->
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3 ml-1">Account è´¦æˆ·</p>
                    <div class="flex gap-3 overflow-x-auto pb-4 no-scrollbar">
                        <button @click="newTx.accountId='cash'" :class="newTx.accountId==='cash'?'bg-slate-800 text-white ring-2 ring-slate-800 ring-offset-2':'bg-white text-slate-600 shadow-sm border border-slate-100'" class="px-4 py-3 rounded-2xl text-sm font-bold whitespace-nowrap transition">ğŸ‘› ç°é‡‘</button>
                        <button @click="newTx.accountId='debit'" :class="newTx.accountId==='debit'?'bg-slate-800 text-white ring-2 ring-slate-800 ring-offset-2':'bg-white text-slate-600 shadow-sm border border-slate-100'" class="px-4 py-3 rounded-2xl text-sm font-bold whitespace-nowrap transition">ğŸ’³ å‚¨è“„å¡</button>
                        <button v-for="cc in creditCards" :key="cc.id" @click="newTx.accountId=cc.id" :class="newTx.accountId===cc.id?'bg-slate-800 text-white ring-2 ring-slate-800 ring-offset-2':'bg-white text-slate-600 shadow-sm border border-slate-100'" class="px-4 py-3 rounded-2xl text-sm font-bold whitespace-nowrap transition">ğŸ’³ {{cc.name}}</button>
                    </div>
                </div>

                <!-- åˆ†ç±» -->
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3 ml-1">Category åˆ†ç±»</p>
                    <div class="grid grid-cols-4 gap-4">
                        <div v-for="cat in currentCategories" :key="cat.name" @click="newTx.category=cat.name; newTx.icon=cat.icon" class="flex flex-col items-center gap-2 transition active:scale-90 cursor-pointer" :class="{'opacity-100': newTx.category===cat.name, 'opacity-50 grayscale': newTx.category!==cat.name}">
                            <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-sm transition duration-300" :class="newTx.category===cat.name?'bg-white border-2 border-slate-800 shadow-md':'bg-white border border-slate-100'">{{cat.icon}}</div>
                            <span class="text-xs font-bold text-slate-600">{{cat.name}}</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <input type="date" v-model="newTx.date" class="w-full bg-white p-4 rounded-2xl text-sm font-bold text-slate-600 outline-none border border-slate-100 shadow-sm">
                    <input type="text" v-model="newTx.desc" class="w-full bg-white p-4 rounded-2xl text-sm font-bold text-slate-600 outline-none border border-slate-100 shadow-sm" placeholder="æ·»åŠ å¤‡æ³¨ (å¯é€‰)...">
                </div>

                <div v-if="editingTx" class="pt-4">
                    <button @click="deleteTx" class="w-full py-4 bg-red-50 text-red-500 font-bold rounded-2xl text-sm border border-red-100">ğŸ—‘ï¸ åˆ é™¤æ­¤è®°å½•</button>
                </div>
            </div>
        </div>
        </transition>

        <!-- å¤‡ä»½å¼¹çª— -->
        <div v-if="showSyncModal" class="fixed inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-6 animate-fade-in">
            <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
                <h3 class="font-bold text-lg mb-2 text-slate-800">ğŸ“‚ æ•°æ®å¤‡ä»½</h3>
                <p class="text-xs text-slate-400 mb-4">å¤åˆ¶ä¸‹æ–¹åŠ å¯†ä¸²ï¼Œä¿å­˜åˆ°å¤‡å¿˜å½•æˆ–iCloudæ–‡ä»¶ä¸­ã€‚</p>
                <textarea readonly class="w-full h-32 bg-slate-50 text-[10px] p-3 rounded-xl border border-slate-200 mb-4 resize-none font-mono text-slate-500">{{ encryptedString }}</textarea>
                <div class="flex gap-3">
                    <button @click="copyString" class="flex-1 py-3 bg-slate-800 text-white rounded-xl text-sm font-bold shadow-lg active:scale-95 transition">å¤åˆ¶å…¨éƒ¨</button>
                    <button @click="showSyncModal=false" class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl text-sm font-bold active:scale-95 transition">å…³é—­</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, nextTick } = Vue;

    createApp({
        data() {
            return {
                isUnlocked: false, hasLocalData: false, showImport: false, showTxModal: false, showSyncModal: false,
                passwordInput: '', masterKey: '', encryptedString: '', importString: '',
                
                assets: { cash: 0, debit: 0 },
                deposits: [], stocks: [], loans: [], creditCards: [], 
                transactions: [], history: [], 
                
                newTx: { type: 'expense', amount: '', category: 'é¤é¥®', icon: 'ğŸ”', desc: '', accountId: 'cash', date: new Date().toISOString().slice(0,10) },
                editingTx: null,
                ui: { cashOpen: false, creditOpen: true, depositOpen: false, stockOpen: false, loanOpen: false },
                
                categories: {
                    expense: [
                        {name:'é¤é¥®',icon:'ğŸ”'},{name:'è´­ç‰©',icon:'ğŸ›ï¸'},{name:'äº¤é€š',icon:'ğŸš—'},{name:'ä½æˆ¿',icon:'ğŸ '},
                        {name:'å¨±ä¹',icon:'ğŸ®'},{name:'åŒ»ç–—',icon:'ğŸ’Š'},{name:'æ•™è‚²',icon:'ğŸ“'},{name:'è¿˜æ¬¾',icon:'ğŸ’¸'},
                        {name:'å® ç‰©',icon:'ğŸ¾'},{name:'ç¾å¦†',icon:'ğŸ’„'},{name:'è¿åŠ¨',icon:'ğŸƒ'},{name:'ç¤¾äº¤',icon:'ğŸ¥‚'},
                        {name:'æ—…æ¸¸',icon:'âœˆï¸'},{name:'æ•°ç ',icon:'ğŸ“±'},{name:'é€šè®¯',icon:'ğŸ“'},{name:'å…¶ä»–',icon:'ğŸ“'}
                    ],
                    income: [
                        {name:'å·¥èµ„',icon:'ğŸ’°'},{name:'ç†è´¢',icon:'ğŸ“ˆ'},{name:'å…¼èŒ',icon:'ğŸ’¼'},{name:'å€Ÿå…¥',icon:'ğŸ™‹'},
                        {name:'å¥–é‡‘',icon:'ğŸ…'},{name:'æŠ¥é”€',icon:'ğŸ§¾'},{name:'å…¶ä»–',icon:'ğŸ§§'}
                    ]
                },
                chartInstance: null
            }
        },
        computed: {
            cashTotal() { return (this.assets.cash||0) + (this.assets.debit||0); },
            depositTotal() { return this.deposits.reduce((s,i)=>s+(i.amount||0),0); },
            stockTotal() { return this.stocks.reduce((s,i)=>s+((i.shares||0)*(i.price||0)),0); },
            
            creditCurrentTotal() { return this.creditCards.reduce((sum, c) => sum + (c.currentBalance||0), 0); },
            creditInstallmentTotal() { return this.creditCards.reduce((sum, c) => sum + (c.installments||[]).reduce((is,i)=>is+(i.total-(i.monthlyAmount*(i.paidMonths||0))),0), 0); },
            creditTotal() { return this.creditCurrentTotal + this.creditInstallmentTotal; },
            
            loanTotal() { return this.loans.reduce((s,i)=>s+(i.total||0),0); },
            totalAssets() { return this.cashTotal + this.depositTotal + this.stockTotal; },
            totalLiabilities() { return this.creditTotal + this.loanTotal; },
            netWorth() { return this.totalAssets - this.totalLiabilities; },
            currentCategories() { return this.newTx.type === 'expense' ? this.categories.expense : this.categories.income; },
            recentTransactions() { return [...this.transactions].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,20); },
            monthlyStats() {
                const cm = new Date().toISOString().slice(0,7);
                const income = this.transactions.filter(t=>t.type==='income' && t.date.startsWith(cm)).reduce((s,t)=>s+t.amount,0);
                let expense = this.transactions.filter(t=>t.type==='expense' && t.date.startsWith(cm)).reduce((s,t)=>s+t.amount,0);
                this.loans.forEach(l => expense += (l.monthlyPayment||0));
                this.creditCards.forEach(c => (c.installments||[]).forEach(i => expense += (i.monthlyAmount||0)));
                return { income, expense };
            }
        },
        mounted() {
            if(localStorage.getItem('myWealth_V15')) this.hasLocalData = true;
        },
        methods: {
            unlock() {
                if(!this.passwordInput) return;
                this.masterKey = this.passwordInput;
                const local = localStorage.getItem('myWealth_V15');
                if(local) { if(!this.decryptAndLoad(local)) alert("å¯†ç é”™è¯¯"); } else { this.isUnlocked = true; this.saveData(); }
            },
            decryptAndLoad(str) {
                try {
                    const bytes = CryptoJS.AES.decrypt(str, this.masterKey);
                    const data = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                    Object.assign(this, data);
                    this.isUnlocked = true;
                    this.encryptedString = str;
                    nextTick(()=>this.renderChart());
                    return true;
                } catch(e) { return false; }
            },
            
            // Logic Methods (Same as V11, ensuring data integrity)
            openTxModal(tx) { 
                this.editingTx = tx;
                this.newTx = tx ? JSON.parse(JSON.stringify(tx)) : { type: 'expense', amount: '', category: 'é¤é¥®', icon: 'ğŸ”', desc: '', accountId: 'cash', date: new Date().toISOString().slice(0,10) };
                this.showTxModal = true; 
            },
            updateAccount(tx, revert=false) {
                const f = revert ? -1 : 1;
                const {type, amount, accountId, extra} = tx;
                if(accountId==='cash') this.assets.cash += (type==='income'?amount:-amount)*f;
                else if(accountId==='debit') this.assets.debit += (type==='income'?amount:-amount)*f;
                else {
                    let cc=this.creditCards.find(c=>c.id===accountId), st=this.stocks.find(s=>s.id===accountId), ln=this.loans.find(l=>l.id===accountId);
                    if(cc) cc.currentBalance += (type==='expense'?amount:-amount)*f;
                    else if(st && st.price>0) st.shares += (type==='income'?1:-1)*(extra?.sharesDelta || amount/st.price)*f;
                    else if(ln) ln.total += (type==='income'?-amount:amount)*f;
                }
            },
            confirmTx() {
                if(!this.newTx.amount) return;
                if(this.editingTx) { this.updateAccount(this.editingTx, true); this.transactions = this.transactions.filter(t=>t.id!==this.editingTx.id); }
                let extra={};
                if(['income','expense'].includes(this.newTx.type)) {
                    const st = this.stocks.find(s=>s.id===this.newTx.accountId);
                    if(st && st.price>0) extra.sharesDelta = this.newTx.amount/st.price;
                }
                const final = { id: this.editingTx?.id||Date.now(), ...this.newTx, extra };
                this.updateAccount(final);
                this.transactions.push(final);
                this.showTxModal = false;
                this.saveData(true);
            },
            deleteTx() {
                if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
                this.updateAccount(this.editingTx, true);
                this.transactions = this.transactions.filter(t=>t.id!==this.editingTx.id);
                this.showTxModal = false;
                this.saveData(true);
            },
            addCreditCard() { this.creditCards.push({id:Date.now(), name:'', currentBalance:0, installments:[]}); },
            removeCreditCard(idx) { if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) this.creditCards.splice(idx,1); },
            addInstallment(card) {
                const name=prompt("å•†å“å"), total=Number(prompt("æ€»é¢")), months=Number(prompt("æœŸæ•°"));
                if(name&&total&&months) card.installments.push({name, total, months, monthlyAmount:total/months, paidMonths:0});
            },
            calcLoanMonthly(l) { if(l.total && l.years) l.monthlyPayment = Math.round(l.total / (l.years * 12)); },
            getAccountName(id) {
                if(id==='cash') return 'ç°é‡‘'; if(id==='debit') return 'æ´»æœŸ';
                return (this.creditCards.concat(this.stocks, this.loans).find(x=>x.id===id)||{}).name || 'æœªçŸ¥';
            },
            toggleAll() { this.ui.cashOpen=!this.ui.cashOpen; this.ui.creditOpen=this.ui.cashOpen; this.ui.depositOpen=this.ui.cashOpen; this.ui.stockOpen=this.ui.cashOpen; this.ui.loanOpen=this.ui.cashOpen; },
            
            saveData(animate) {
                const today = new Date().toLocaleDateString();
                if(!this.history.find(h=>h.date===today)) { this.history.push({date:today, val:this.netWorth}); if(this.history.length>30) this.history.shift(); }
                else this.history.find(h=>h.date===today).val = this.netWorth;
                const data = { assets:this.assets, deposits:this.deposits, stocks:this.stocks, loans:this.loans, creditCards:this.creditCards, transactions:this.transactions, history:this.history };
                const str = CryptoJS.AES.encrypt(JSON.stringify(data), this.masterKey).toString();
                localStorage.setItem('myWealth_V15', str);
                this.encryptedString = str;
                if(this.isUnlocked) this.renderChart();
            },
            resetApp() { if(confirm("ç¡®å®šé‡ç½®ï¼Ÿæ•°æ®å°†ä¸¢å¤±ï¼")) { localStorage.removeItem('myWealth_V15'); location.reload(); } },
            lockApp() { this.saveData(); this.isUnlocked = false; this.passwordInput = ''; },
            importData() {
                this.masterKey = this.passwordInput;
                if(this.decryptAndLoad(this.importString)) { this.saveData(true); this.showImport = false; } else alert("æ¢å¤å¤±è´¥");
            },
            exportToExcel() {
                let csv = "\uFEFFæ—¥æœŸ,ç±»å‹,é‡‘é¢,åˆ†ç±»,è´¦æˆ·,å¤‡æ³¨\n";
                this.transactions.forEach(t => csv += `${t.date},${t.type==='income'?'æ”¶å…¥':'æ”¯å‡º'},${t.amount},${t.category},${this.getAccountName(t.accountId)},${t.desc}\n`);
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
                link.download = `è´¦å•_${new Date().toLocaleDateString()}.csv`;
                link.click();
            },
            renderChart() {
                const ctx = document.getElementById('mainChart');
                if(!ctx) return;
                if(this.chartInstance) this.chartInstance.destroy();
                this.chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels: this.history.map(h=>h.date.slice(5)), datasets: [{ label: 'å‡€èµ„äº§', data: this.history.map(h=>h.val), borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }] },
                    options: { responsive: true, maintainAspectRatio: false, scales:{x:{display:false},y:{display:false}}, plugins:{legend:{display:false}} }
                });
            },
            formatNumber(num) { return num ? num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') : '0.00'; }
        }
    }).mount('#app');
</script>
</body>
</html>
