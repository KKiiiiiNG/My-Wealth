<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8fafc">
    <title>èµ„äº§ç®¡å®¶</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* iOS åŸç”Ÿè´¨æ„Ÿ */
        body { 
            background-color: #F5F7FA; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "PingFang SC", "Helvetica Neue", sans-serif; 
            color: #1e293b; 
            -webkit-tap-highlight-color: transparent; 
            -webkit-font-smoothing: antialiased;
        }
        
        /* é€‚é…çµåŠ¨å²›ä¸åº•éƒ¨æ¨ªæ¡ */
        .safe-pt { padding-top: max(20px, env(safe-area-inset-top)); }
        .safe-pb { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        
        /* ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ */
        .card-ios { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px; 
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04); 
            border: 1px solid rgba(255, 255, 255, 0.6); 
            overflow: hidden; 
            transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card-ios:active { transform: scale(0.985); }
        
        /* è¯­ä¹‰è‰² */
        .text-income { color: #ef4444; } .bg-income { background-color: #fee2e2; }
        .text-expense { color: #10b981; } .bg-expense { background-color: #d1fae5; }
        .text-transfer { color: #3b82f6; } .bg-transfer { background-color: #dbeafe; }
        .text-adjust { color: #f59e0b; } .bg-adjust { background-color: #fef3c7; }

        /* åŠ¨ç”» */
        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.4s cubic-bezier(0.32, 0.72, 0, 1); transform: translateY(0); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .input-clean { background: transparent; outline: none; width: 100%; }
        
        /* åº•éƒ¨å¯¼èˆªå‡¸èµ·æ•ˆæœ */
        .nav-fab-shadow { box-shadow: 0 8px 30px rgba(15, 23, 42, 0.25); }
    </style>
</head>
<body>

<div id="app" class="h-screen w-full flex flex-col bg-[#F5F7FA] relative overflow-hidden">

    <!-- ================= 1. ç™»å½• ================= -->
    <div v-if="!isUnlocked" class="fixed inset-0 z-50 bg-[#F5F7FA] flex flex-col items-center justify-center p-8 safe-pt">
        <div class="w-full max-w-sm text-center">
            <div class="w-24 h-24 bg-white rounded-[32px] shadow-xl flex items-center justify-center text-5xl mb-8 mx-auto">ğŸ¦</div>
            <h1 class="text-3xl font-bold text-slate-800 mb-2 tracking-tight">èµ„äº§ç®¡å®¶ <span class="text-xs align-top bg-slate-200 text-slate-500 px-2 py-0.5 rounded-full ml-1">FINAL</span></h1>
            <p class="text-sm text-slate-400 mb-12 font-medium tracking-wide">æœ¬åœ°ç§å¯† Â· æŠ•èµ„å¢å¼º</p>

            <div class="space-y-6">
                <div class="bg-white rounded-3xl p-2 pl-6 shadow-sm border border-slate-100 flex items-center transition focus-within:ring-4 ring-blue-50">
                    <span class="text-xl">ğŸ”‘</span>
                    <input type="password" v-model="passwordInput" placeholder="è¾“å…¥ä¸»å¯†ç " class="w-full bg-transparent p-4 text-lg font-bold text-slate-700 outline-none placeholder:text-slate-300">
                </div>
                <button @click="unlock" class="w-full py-4 rounded-3xl font-bold text-white shadow-xl shadow-slate-200 text-lg bg-slate-900 active:scale-95 transition-all duration-300">
                    {{ hasLocalData ? 'éªŒè¯è§£é”' : 'è®¾ç½®æ–°å¯†ç ' }}
                </button>
            </div>
            
            <div class="mt-12">
                <button @click="showImport=!showImport" class="text-xs font-bold text-blue-500 bg-blue-50 px-4 py-2 rounded-full hover:bg-blue-100 transition">ğŸ“‚ æ¢å¤å¤‡ä»½</button>
                <transition name="fade">
                    <div v-if="showImport" class="mt-4 bg-white p-4 rounded-3xl shadow-lg border border-slate-100">
                        <textarea v-model="importString" class="w-full h-24 text-xs bg-slate-50 p-3 rounded-2xl resize-none outline-none text-slate-600 mb-3" placeholder="ç²˜è´´åŠ å¯†æ•°æ®ä¸²..."></textarea>
                        <button @click="importData" class="w-full py-3 bg-slate-900 text-white text-xs rounded-2xl font-bold">ç¡®è®¤æ¢å¤</button>
                    </div>
                </transition>
            </div>
        </div>
    </div>

    <!-- ================= 2. ä¸»ç¨‹åº ================= -->
    <div v-else class="flex-1 flex flex-col h-full overflow-hidden">
        
        <!-- é¡¶éƒ¨åŒºåŸŸ -->
        <header class="px-6 pt-16 pb-6 bg-white/80 backdrop-blur-md sticky top-0 z-20 border-b border-slate-200/60 rounded-b-[40px] shadow-sm">
            <div class="flex justify-between items-center mb-1">
                <span class="text-[11px] font-bold text-slate-400 uppercase tracking-widest pl-1">Total Assets</span>
                <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded-full font-medium">{{ currentDate }}</span>
            </div>
            <h1 class="text-[42px] leading-tight font-black text-slate-800 tracking-tight mb-5">
                <span class="text-2xl text-slate-400 font-medium align-top mr-1">Â¥</span>{{ formatNumber(netWorth) }}
            </h1>
            
            <!-- é¢„ç®—æ¡ -->
            <div class="bg-slate-100/80 rounded-2xl p-1.5 flex items-center gap-3 pr-4">
                <div class="h-10 bg-white rounded-xl flex-1 flex items-center px-3 relative overflow-hidden shadow-sm">
                    <div class="absolute left-0 top-0 bottom-0 bg-blue-500/10 transition-all duration-700" :style="{width: Math.min(budgetProgress, 100) + '%'}"></div>
                    <div class="relative z-10 flex justify-between w-full text-xs font-bold text-slate-600">
                        <span>æœ¬æœˆé¢„ç®—</span>
                        <span>{{Math.round(budgetProgress)}}%</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-slate-400 font-bold uppercase">Left</div>
                    <div class="text-xs font-bold text-slate-700">Â¥{{formatNumber(settings.monthlyBudget - monthlyStats.expense)}}</div>
                </div>
            </div>
        </header>

        <!-- å†…å®¹åŒºåŸŸ -->
        <main class="flex-1 overflow-y-auto p-5 space-y-6 pb-36">
            
            <!-- >>>>>> Home Tab <<<<<< -->
            <div v-if="currentTab === 'home'" class="space-y-5 animate-fade-in">
                
                <!-- èµ„äº§æ¨¡å— -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center px-2">
                        <h3 class="font-bold text-slate-800 text-lg">è´¦æˆ·æ¦‚è§ˆ</h3>
                        <button @click="toggleAll" class="text-[11px] font-bold text-slate-500 bg-white px-3 py-1.5 rounded-full shadow-sm active:scale-95 transition">{{ui.cashOpen?'æŠ˜å ':'å±•å¼€'}}</button>
                    </div>

                    <!-- ç°é‡‘ -->
                    <div class="card-ios">
                        <div class="p-5 flex justify-between items-center" @click="ui.cashOpen=!ui.cashOpen">
                            <div class="flex items-center gap-4"><div class="w-12 h-12 rounded-[18px] bg-blue-50 text-blue-600 flex items-center justify-center text-2xl">ğŸ‘›</div><div><div class="font-bold text-base text-slate-700">ç°é‡‘ & æ´»æœŸ</div><div class="text-xs font-medium text-slate-400 mt-0.5">Â¥{{formatNumber(cashTotal)}}</div></div></div>
                            <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 text-xs transition-transform duration-300" :class="ui.cashOpen?'rotate-180':''">â–¼</div>
                        </div>
                        <div v-show="ui.cashOpen" class="bg-slate-50/50 p-4 pt-0 space-y-3 pb-5">
                            <div class="flex justify-between items-center bg-white p-3 rounded-2xl shadow-sm border border-slate-100"><span class="text-xs font-bold text-slate-500 pl-1">ğŸ’µ ç°é‡‘é’±åŒ…</span><input v-model.number="assets.cash" type="number" class="text-right font-bold text-slate-800 bg-transparent outline-none w-28 text-sm" placeholder="0"></div>
                            <div class="flex justify-between items-center bg-white p-3 rounded-2xl shadow-sm border border-slate-100"><span class="text-xs font-bold text-slate-500 pl-1">ğŸ’³ å‚¨è“„å¡</span><input v-model.number="assets.debit" type="number" class="text-right font-bold text-slate-800 bg-transparent outline-none w-28 text-sm" placeholder="0"></div>
                        </div>
                    </div>
                    
                    <!-- ä¿¡ç”¨å¡ -->
                    <div class="card-ios">
                        <div class="p-5 flex justify-between items-center" @click="ui.creditOpen=!ui.creditOpen">
                            <div class="flex items-center gap-4"><div class="w-12 h-12 rounded-[18px] bg-emerald-50 text-emerald-600 flex items-center justify-center text-2xl">ğŸ’³</div><div><div class="font-bold text-base text-slate-700">ä¿¡ç”¨å¡</div><div class="text-xs font-medium text-slate-400 mt-0.5">è´Ÿå€º: <span class="text-emerald-500">Â¥{{formatNumber(creditTotal)}}</span></div></div></div>
                            <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 text-xs transition-transform duration-300" :class="ui.creditOpen?'rotate-180':''">â–¼</div>
                        </div>
                        <div v-show="ui.creditOpen" class="bg-slate-50/50 p-4 pt-0 pb-5 space-y-3">
                            <div v-for="(cc,i) in creditCards" :key="cc.id" class="bg-white p-4 rounded-[20px] shadow-sm border border-slate-100 relative">
                                <button @click="removeCreditCard(i)" class="absolute top-3 right-3 text-slate-300 hover:text-red-500 text-lg">Ã—</button>
                                <input v-model="cc.name" class="font-bold text-base text-slate-800 bg-transparent outline-none w-3/4 mb-3" placeholder="é“¶è¡Œåç§°">
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <div class="bg-slate-50 rounded-xl p-2.5"><div class="text-[10px] text-slate-400 font-bold mb-1">ä¸Šæœˆå·²å‡º</div><input v-model.number="cc.lastMonthBill" class="w-full bg-transparent font-bold text-slate-700 text-sm outline-none" placeholder="0"></div>
                                    <div class="bg-slate-50 rounded-xl p-2.5"><div class="text-[10px] text-emerald-500 font-bold mb-1">æœ¬æœˆæœªå‡º</div><input v-model.number="cc.currentMonthBill" class="w-full bg-transparent font-bold text-emerald-600 text-sm outline-none" placeholder="0"></div>
                                </div>
                                <div class="border-t border-dashed border-slate-100 pt-2">
                                    <div class="flex justify-between items-center mb-2"><span class="text-[10px] font-bold text-slate-400 uppercase">åˆ†æœŸè®¡åˆ’</span><button @click="addInstallment(cc)" class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded font-bold">æ–°å¢</button></div>
                                    <div v-if="cc.installments.length===0" class="text-center text-[10px] text-slate-300 py-1">æ— åˆ†æœŸ</div>
                                    <div v-else v-for="(inst,ii) in cc.installments" :key="ii" class="flex justify-between items-center text-xs py-1"><span class="font-medium text-slate-600">{{inst.name}}</span><div class="flex items-center gap-2"><span class="text-slate-400 scale-90">å‰©{{formatNumber(inst.total - (inst.monthlyAmount * inst.paidMonths))}}</span><span class="font-bold text-emerald-500">-{{Math.round(inst.monthlyAmount)}}</span><button @click="cc.installments.splice(ii,1)" class="text-red-300 ml-1">Ã—</button></div></div>
                                </div>
                            </div>
                            <button @click="addCreditCard" class="w-full py-3 bg-white border-2 border-dashed border-slate-200 text-slate-400 text-xs font-bold rounded-2xl hover:border-blue-300 transition">+ æ·»åŠ æ–°å¡ç‰‡</button>
                        </div>
                    </div>
                    
                    <!-- æŠ•èµ„ & è´·æ¬¾ -->
                    <div class="card-ios">
                        <div class="p-5 flex justify-between items-center" @click="ui.investOpen=!ui.investOpen">
                            <div class="flex items-center gap-4"><div class="w-12 h-12 rounded-[18px] bg-amber-50 text-amber-500 flex items-center justify-center text-2xl">ğŸ“ˆ</div><div><div class="font-bold text-base text-slate-700">æŠ•èµ„ & è´·æ¬¾</div><div class="text-xs font-medium text-slate-400 mt-0.5">å‡€å€¼: <span class="text-slate-600">Â¥{{formatNumber(stockTotal+depositTotal-loanTotal)}}</span></div></div></div>
                            <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 text-xs transition-transform duration-300" :class="ui.investOpen?'rotate-180':''">â–¼</div>
                        </div>
                        <div v-show="ui.investOpen" class="bg-slate-50/50 p-4 pt-0 pb-5 space-y-4">
                            <!-- è‚¡ç¥¨ -->
                            <div class="bg-white p-4 rounded-[20px] shadow-sm">
                                <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-3 flex justify-between">è‚¡ç¥¨åŸºé‡‘ <span class="text-amber-500">Â¥{{formatNumber(stockTotal)}}</span></h4>
                                <div v-for="(s,i) in stocks" :key="i" class="flex items-center justify-between mb-3 text-sm pb-2 border-b border-slate-50 last:border-0 last:pb-0">
                                    <div class="flex flex-col"><input v-model="s.name" class="font-bold w-24 input-clean" placeholder="åç§°"><input v-model="s.code" class="text-[10px] text-slate-400 input-clean uppercase" placeholder="ä»£ç "></div>
                                    <div class="flex flex-col items-end gap-1"><div class="flex gap-1"><input v-model.number="s.shares" class="text-right w-12 bg-slate-50 rounded px-1 text-xs" placeholder="è‚¡"><span class="text-xs text-slate-300">Ã—</span><input v-model.number="s.price" class="text-right w-12 bg-slate-50 rounded px-1 text-xs font-bold text-amber-500" placeholder="ä»·"></div><div class="text-[10px] text-slate-400">Â¥{{formatNumber(s.shares*s.price)}}</div></div>
                                    <button @click="stocks.splice(i,1)" class="text-slate-300 ml-2">Ã—</button>
                                </div>
                                <button @click="stocks.push({id:Date.now(),name:'',code:'',shares:0,price:0})" class="w-full py-2 bg-slate-50 text-[10px] font-bold text-blue-500 rounded-xl mt-1">+ åŠ æŒä»“</button>
                            </div>
                            <!-- å®šå­˜ -->
                            <div class="bg-white p-4 rounded-[20px] shadow-sm">
                                <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-3 flex justify-between">å®šæœŸå­˜æ¬¾ <span class="text-indigo-500">Â¥{{formatNumber(depositTotal)}}</span></h4>
                                <div v-for="(d,i) in deposits" :key="i" class="flex justify-between items-center mb-2 text-sm"><input v-model="d.bank" class="font-bold w-1/3 input-clean" placeholder="é“¶è¡Œ"><div class="flex items-center gap-2"><input v-model.number="d.amount" class="text-right font-bold text-indigo-500 input-clean w-20" placeholder="0"><button @click="deposits.splice(i,1)" class="text-slate-300">Ã—</button></div></div>
                                <button @click="deposits.push({name:'å®šå­˜',bank:'',amount:0,date:'',term:''})" class="w-full py-2 bg-slate-50 text-[10px] font-bold text-blue-500 rounded-xl">+ åŠ å­˜å•</button>
                            </div>
                            <!-- è´·æ¬¾ -->
                            <div class="bg-white p-4 rounded-[20px] shadow-sm">
                                <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-3 flex justify-between">æˆ¿è´·è´·æ¬¾ <span class="text-emerald-500">-Â¥{{formatNumber(loanTotal)}}</span></h4>
                                <div v-for="(l,i) in loans" :key="i" class="mb-3 pb-2 border-b border-slate-50 last:border-0 last:pb-0">
                                    <div class="flex justify-between mb-1"><input v-model="l.name" class="font-bold text-sm input-clean" placeholder="è´·æ¬¾åç§°"><button @click="loans.splice(i,1)" class="text-slate-300 text-xs">Ã—</button></div>
                                    <div class="flex gap-2 text-xs">
                                        <div class="flex-1 bg-slate-50 p-2 rounded-lg flex justify-between"><span>å‰©</span><input v-model.number="l.total" class="bg-transparent text-right font-bold w-20 outline-none text-slate-700"></div>
                                        <div class="w-24 bg-emerald-50 p-2 rounded-lg flex justify-between"><span>ä¾›</span><input v-model.number="l.monthlyPayment" class="bg-transparent text-right font-bold w-12 outline-none text-emerald-600"></div>
                                    </div>
                                </div>
                                <button @click="loans.push({id:Date.now(),name:'',total:0,years:30,monthlyPayment:0})" class="w-full py-2 bg-slate-50 text-[10px] font-bold text-blue-500 rounded-xl mt-1">+ åŠ è´·æ¬¾</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœç´¢ä¸æµæ°´ -->
                <div class="pt-2 pb-6">
                    <div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-3 mb-4 sticky top-0 z-10">
                        <span class="text-lg">ğŸ”</span>
                        <input v-model="searchText" class="w-full text-sm font-medium bg-transparent outline-none placeholder:text-slate-400" placeholder="æœç´¢è´¦å•ã€é‡‘é¢...">
                    </div>
                    <div class="space-y-3">
                        <div v-for="tx in filteredTransactions" :key="tx.id" @click="openTxModal(tx)" 
                            class="bg-white p-4 rounded-[20px] shadow-[0_4px_16px_rgba(0,0,0,0.02)] border border-slate-50 flex items-center justify-between active:scale-95 transition">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-2xl flex items-center justify-center text-xl shadow-sm" :class="getTypeColor(tx.type, true)">{{ tx.icon || 'ğŸ“' }}</div>
                                <div>
                                    <div class="font-bold text-slate-700 text-sm flex items-center gap-2">
                                        {{ tx.category }}
                                        <span v-if="tx.project" class="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded-md font-bold">{{tx.project}}</span>
                                        <span v-if="tx.type==='adjust'" class="text-[9px] bg-amber-50 text-amber-500 px-1.5 py-0.5 rounded-md font-bold">è°ƒä»“/å‡€å€¼</span>
                                    </div>
                                    <div class="text-[10px] text-slate-400 mt-0.5 font-medium">
                                        {{ tx.date.slice(5) }} <span v-if="tx.desc" class="text-slate-300">|</span> {{tx.desc}}
                                        <span v-if="tx.type==='transfer'" class="text-blue-400 block mt-0.5">{{getAccountName(tx.fromId)}} â†’ {{getAccountName(tx.toId)}}</span>
                                        <span v-else-if="tx.type==='adjust'">{{getAccountName(tx.accountId)}}</span>
                                        <span v-else>Â· {{ getAccountName(tx.accountId) }}</span>
                                    </div>
                                </div>
                            </div>
                            <span class="font-bold text-base font-mono tracking-tight" :class="getTypeColor(tx.type)">
                                {{ tx.type==='expense'?'-':(tx.type==='income'?'+':'') }}{{ formatNumber(tx.amount) }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- >>>>>> Tab 2: æŠ¥è¡¨ (Stats) <<<<<< -->
            <div v-else-if="currentTab === 'stats'" class="space-y-6 animate-fade-in">
                <!-- ç­›é€‰ -->
                <div class="flex justify-between items-center bg-white p-2 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="font-bold text-slate-800 ml-3">åˆ†æçœ‹æ¿</h2>
                    <div class="bg-slate-100 p-1 rounded-xl flex">
                        <button v-for="r in ['week','month','year']" :key="r" @click="statsRange=r; renderStats()" 
                            :class="statsRange===r ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-400'"
                            class="px-4 py-1.5 rounded-lg text-xs font-bold transition capitalize">{{r}}</button>
                    </div>
                </div>

                <!-- å›¾è¡¨: æŠ•èµ„è¶‹åŠ¿ -->
                <div class="card-ios p-6">
                    <h3 class="text-xs font-bold text-amber-500 mb-4 uppercase tracking-widest flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-amber-500"></span> æŠ•èµ„å¸‚å€¼è¶‹åŠ¿ (Invest)</h3>
                    <div class="h-48 relative"><canvas id="investChart"></canvas></div>
                </div>

                <!-- å›¾è¡¨: æ”¶æ”¯è¶‹åŠ¿ -->
                <div class="card-ios p-6">
                    <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-widest">æ”¶æ”¯æµæ°´ (Cashflow)</h3>
                    <div class="h-40 relative"><canvas id="trendChart"></canvas></div>
                </div>

                <!-- å›¾è¡¨: æ„æˆ -->
                <div class="card-ios p-6">
                    <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-widest">æ”¯å‡ºæ„æˆ (Category)</h3>
                    <div class="h-56 relative"><canvas id="catChart"></canvas></div>
                </div>
            </div>

            <!-- >>>>>> Tab 3: æˆ‘çš„ (Mine) <<<<<< -->
            <div v-else-if="currentTab === 'mine'" class="space-y-6 animate-fade-in">
                <div class="bg-slate-900 rounded-[32px] p-8 text-white shadow-2xl shadow-slate-200">
                    <div class="flex items-center gap-5">
                        <div class="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center text-3xl">ğŸ˜</div>
                        <div>
                            <h2 class="text-xl font-bold">æˆ‘çš„è´¦æˆ·</h2>
                            <p class="text-xs text-slate-400 mt-1">æœ¬åœ°å®‰å…¨å­˜å‚¨ Â· æ— äº‘ç«¯æ³„éœ²</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-4 border-b border-slate-50 text-xs font-bold text-slate-400 uppercase tracking-widest">Preferences</div>
                    <div class="p-2">
                        <div class="flex justify-between items-center p-4 hover:bg-slate-50 rounded-2xl transition">
                            <span class="text-sm font-bold text-slate-700">æœˆåº¦é¢„ç®—é™é¢</span>
                            <input v-model.number="settings.monthlyBudget" @change="saveData" type="number" class="text-right text-sm font-bold text-blue-600 bg-transparent outline-none w-24">
                        </div>
                        <div class="flex justify-between items-center p-4 hover:bg-slate-50 rounded-2xl transition">
                            <span class="text-sm font-bold text-slate-700">è‡ªå®šä¹‰é¡¹ç›®æ ‡ç­¾</span>
                            <button @click="manageProjects" class="text-xs font-bold text-blue-500 bg-blue-50 px-3 py-1.5 rounded-lg">ç¼–è¾‘</button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-4 border-b border-slate-50 text-xs font-bold text-slate-400 uppercase tracking-widest">Data & Security</div>
                    <div class="p-2 space-y-1">
                        <button @click="exportToFile" class="w-full p-4 flex items-center gap-3 hover:bg-slate-50 rounded-2xl transition text-left"><span class="text-lg">ğŸ“¤</span><span class="text-sm font-bold text-slate-600">å¤‡ä»½æ‰€æœ‰æ•°æ® (iCloud)</span></button>
                        <button @click="exportToExcel" class="w-full p-4 flex items-center gap-3 hover:bg-slate-50 rounded-2xl transition text-left"><span class="text-lg">ğŸ“Š</span><span class="text-sm font-bold text-slate-600">å¯¼å‡º Excel æŠ¥è¡¨</span></button>
                        <button @click="resetApp" class="w-full p-4 flex items-center gap-3 hover:bg-red-50 rounded-2xl transition text-left group"><span class="text-lg">ğŸ—‘ï¸</span><span class="text-sm font-bold text-red-400 group-hover:text-red-500">æ¸…ç©ºå¹¶é‡ç½® App</span></button>
                    </div>
                </div>
            </div>

        </main>

        <!-- åº•éƒ¨å¯¼èˆª (Proçº§ç»ç’ƒæ€) -->
        <nav class="bg-white/85 backdrop-blur-xl border-t border-slate-200/50 flex justify-around items-center h-24 safe-pb fixed bottom-0 w-full z-40">
            <button @click="currentTab='home'" :class="currentTab==='home'?'text-slate-900':'text-slate-400'" class="flex flex-col items-center gap-1 w-20 transition active:scale-90"><span class="text-2xl" :class="currentTab==='home'?'scale-110':''">ğŸ </span><span class="text-[10px] font-bold">æ˜ç»†</span></button>
            <div class="relative -top-8"><button @click="openTxModal(null)" class="w-16 h-16 rounded-[24px] bg-slate-900 text-white shadow-2xl nav-fab-shadow flex items-center justify-center text-3xl border-4 border-[#F2F4F7] active:scale-90 transition hover:-translate-y-1 duration-300">ï¼‹</button></div>
            <button @click="currentTab='stats'; nextTick(()=>renderStats())" :class="currentTab==='stats'?'text-slate-900':'text-slate-400'" class="flex flex-col items-center gap-1 w-20 transition active:scale-90"><span class="text-2xl" :class="currentTab==='stats'?'scale-110':''">ğŸ“Š</span><span class="text-[10px] font-bold">æŠ¥è¡¨</span></button>
            <button @click="currentTab='mine'" :class="currentTab==='mine'?'text-slate-900':'text-slate-400'" class="flex flex-col items-center gap-1 w-20 transition active:scale-90"><span class="text-2xl" :class="currentTab==='mine'?'scale-110':''">ğŸ‘¤</span><span class="text-[10px] font-bold">æˆ‘çš„</span></button>
        </nav>

        <!-- å…¨å±è®°è´¦å¼¹çª— (Modal) -->
        <transition name="slide-up">
        <div v-if="showTxModal" class="fixed inset-0 z-50 bg-[#F2F4F7] flex flex-col pt-safe safe-pb">
            <!-- Modal Header -->
            <div class="px-6 py-4 flex justify-between items-center bg-transparent">
                <button @click="showTxModal=false" class="text-slate-400 font-bold text-sm bg-white px-4 py-2 rounded-full shadow-sm active:scale-95 transition">å–æ¶ˆ</button>
                <div class="flex bg-white p-1 rounded-full shadow-sm">
                    <button v-for="t in ['expense','income','transfer','adjust']" :key="t" @click="setTxType(t)" 
                        :class="newTx.type===t ? 'bg-slate-900 text-white' : 'text-slate-400'"
                        class="px-3 py-2 rounded-full text-xs font-bold transition capitalize">
                        {{t==='expense'?'æ”¯å‡º':(t==='income'?'æ”¶å…¥':(t==='transfer'?'è½¬è´¦':'è°ƒä»·'))}}
                    </button>
                </div>
                <button @click="confirmTx" class="text-white bg-blue-600 font-bold text-sm px-5 py-2 rounded-full shadow-lg active:scale-95 transition">ä¿å­˜</button>
            </div>
            
            <!-- Amount Display (Dynamic) -->
            <div class="py-6 text-center">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">{{newTx.type==='adjust'?'New Price':'Amount'}}</div>
                <div class="flex justify-center items-end gap-1">
                    <span class="text-4xl font-bold mb-2 text-slate-300">Â¥</span>
                    <input type="number" v-model.number="newTx.amount" class="text-7xl font-black text-center outline-none w-72 bg-transparent text-slate-800 placeholder:text-slate-200" placeholder="0" autofocus>
                </div>
                <p v-if="newTx.type==='adjust' && selectedStock" class="text-xs text-amber-500 font-bold mt-2">å½“å‰æŒä»“: {{selectedStock.shares}}è‚¡ @ Â¥{{selectedStock.price}}</p>
            </div>

            <div class="flex-1 overflow-y-auto px-6 space-y-6 pb-32">
                
                <!-- 1. è´¦æˆ·é€‰æ‹©å™¨ -->
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3 ml-2">Account è´¦æˆ·</p>
                    <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                        <!-- è°ƒä»·æ¨¡å¼ï¼šåªæ˜¾ç¤ºè‚¡ç¥¨ -->
                        <template v-if="newTx.type === 'adjust'">
                            <button v-for="s in stocks" :key="s.id" @click="newTx.accountId=s.id" :class="newTx.accountId===s.id?'bg-slate-800 text-white ring-4 ring-slate-200':'bg-white text-slate-600 shadow-sm'" class="px-5 py-3 rounded-2xl text-sm font-bold whitespace-nowrap transition">ğŸ“ˆ {{s.name}}</button>
                        </template>
                        <!-- æ­£å¸¸æ¨¡å¼ï¼šå…¨è´¦æˆ· (è½¬è´¦æ—¶æ˜¾ç¤ºFrom/To) -->
                        <template v-else-if="newTx.type === 'transfer'">
                             <div class="w-full bg-white p-4 rounded-3xl flex items-center justify-between shadow-sm">
                                <div class="w-[45%]">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">From</label>
                                    <select v-model="newTx.fromId" class="w-full bg-slate-50 p-3 rounded-2xl text-sm font-bold appearance-none outline-none"><option value="cash">ğŸ‘› ç°é‡‘</option><option value="debit">ğŸ’³ å‚¨è“„å¡</option></select>
                                </div>
                                <div class="text-slate-300">â”</div>
                                <div class="w-[45%]">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">To</label>
                                    <select v-model="newTx.toId" class="w-full bg-slate-50 p-3 rounded-2xl text-sm font-bold appearance-none outline-none"><option value="cash">ğŸ‘› ç°é‡‘</option><option value="debit">ğŸ’³ å‚¨è“„å¡</option><option v-for="c in creditCards" :value="c.id">ğŸ’³ {{c.name}}</option><option v-for="s in stocks" :value="s.id">ğŸ“ˆ {{s.name}}</option></select>
                                </div>
                            </div>
                        </template>
                        <template v-else>
                            <button @click="newTx.accountId='cash'" :class="newTx.accountId==='cash'?'bg-slate-800 text-white ring-4 ring-slate-200':'bg-white text-slate-600 shadow-sm'" class="px-5 py-3 rounded-2xl text-sm font-bold whitespace-nowrap transition">ğŸ‘› ç°é‡‘</button>
                            <button @click="newTx.accountId='debit'" :class="newTx.accountId==='debit'?'bg-slate-800 text-white ring-4 ring-slate-200':'bg-white text-slate-600 shadow-sm'" class="px-5 py-3 rounded-2xl text-sm font-bold whitespace-nowrap transition">ğŸ’³ å‚¨è“„å¡</button>
                            <button v-for="c in creditCards" :key="c.id" @click="newTx.accountId=c.id" :class="newTx.accountId===c.id?'bg-slate-800 text-white ring-4 ring-slate-200':'bg-white text-slate-600 shadow-sm'" class="px-5 py-3 rounded-2xl text-sm font-bold whitespace-nowrap transition">ğŸ’³ {{c.name}}</button>
                            <button v-for="s in stocks" :key="s.id" @click="newTx.accountId=s.id" :class="newTx.accountId===s.id?'bg-slate-800 text-white ring-4 ring-slate-200':'bg-white text-slate-600 shadow-sm'" class="px-5 py-3 rounded-2xl text-sm font-bold whitespace-nowrap transition">ğŸ“ˆ {{s.name}}</button>
                        </template>
                    </div>
                </div>

                <!-- 2. è‚¡ç¥¨äº¤æ˜“è¡¥å……ä¿¡æ¯ (ä»…å½“è´¦æˆ·æ¶‰åŠè‚¡ç¥¨æ—¶å‡ºç°) -->
                <div v-if="isStockTransaction && newTx.type !== 'adjust'" class="bg-amber-50 p-4 rounded-2xl border border-amber-100">
                    <p class="text-xs font-bold text-amber-500 uppercase mb-2">è‚¡ç¥¨æˆäº¤è¯¦æƒ…</p>
                    <div class="flex gap-3">
                        <div class="w-1/2"><label class="text-[10px] text-amber-400 font-bold block mb-1">æˆäº¤å•ä»·</label><input type="number" v-model.number="newTx.stockPrice" class="w-full bg-white p-2 rounded-xl text-sm font-bold outline-none" placeholder="å•ä»·"></div>
                        <div class="w-1/2"><label class="text-[10px] text-amber-400 font-bold block mb-1">æˆäº¤è‚¡æ•°</label><input type="number" v-model.number="newTx.stockShares" class="w-full bg-white p-2 rounded-xl text-sm font-bold outline-none" placeholder="è‚¡æ•°"></div>
                    </div>
                </div>

                <!-- 3. åˆ†ç±» (æ”¶æ”¯æ¨¡å¼) -->
                <div v-if="['expense','income', 'adjust'].includes(newTx.type)">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3 ml-2">Category åˆ†ç±»</p>
                    <div class="grid grid-cols-5 gap-4">
                        <div v-for="cat in currentCategories" :key="cat.name" @click="newTx.category=cat.name; newTx.icon=cat.icon" class="flex flex-col items-center gap-2 transition active:scale-90 cursor-pointer" :class="{'opacity-100': newTx.category===cat.name, 'opacity-40 grayscale': newTx.category!==cat.name}">
                            <div class="w-14 h-14 rounded-[20px] flex items-center justify-center text-2xl shadow-sm transition duration-300" :class="newTx.category===cat.name?'bg-white border-2 border-slate-800 shadow-lg':'bg-white border border-slate-100'">{{cat.icon}}</div>
                            <span class="text-[10px] font-bold text-slate-600">{{cat.name}}</span>
                        </div>
                    </div>
                </div>

                <!-- 4. è¯¦ç»†ä¿¡æ¯ -->
                <div class="space-y-4">
                    <div class="flex gap-3">
                        <div class="w-1/2 bg-white p-3 rounded-2xl shadow-sm"><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Date</label><input type="date" v-model="newTx.date" class="w-full bg-transparent font-bold text-slate-700 text-sm outline-none"></div>
                        <div class="w-1/2 bg-white p-3 rounded-2xl shadow-sm flex items-center justify-between px-3">
                             <div class="w-full">
                                <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Project</label>
                                <select v-model="newTx.project" class="w-full bg-transparent font-bold text-slate-700 text-sm outline-none"><option value="">æ— é¡¹ç›®</option><option v-for="p in settings.projects" :value="p">{{p}}</option></select>
                             </div>
                             <button @click="addProject" class="text-blue-500 font-bold text-lg ml-1 leading-none" title="æ·»åŠ é¡¹ç›®">+</button>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm"><input type="text" v-model="newTx.desc" class="w-full bg-transparent font-bold text-slate-700 text-sm outline-none placeholder:text-slate-300" placeholder="æ·»åŠ å¤‡æ³¨ (å¯é€‰)..."></div>
                </div>

                <div v-if="editingTx" class="pt-4"><button @click="deleteTx" class="w-full py-4 bg-red-50 text-red-500 font-bold rounded-2xl text-sm border border-red-100 hover:bg-red-100 transition">ğŸ—‘ï¸ åˆ é™¤æ­¤è®°å½•</button></div>
            </div>
        </div>
        </transition>

    </div>
</div>

<script>
    const { createApp, nextTick } = Vue;

    createApp({
        data() {
            return {
                isUnlocked: false, hasLocalData: false, showImport: false, showTxModal: false,
                passwordInput: '', masterKey: '', encryptedString: '', importString: '',
                currentTab: 'home', searchText: '',
                
                assets: { cash: 0, debit: 0 },
                deposits: [], stocks: [], loans: [], creditCards: [], 
                transactions: [], history: [], 
                settings: { monthlyBudget: 5000, projects: ['è£…ä¿®','æ—…æ¸¸','äººæƒ…','å® ç‰©','æ±½è½¦','åŒ»ç–—','æ•™è‚²','å¤§ä»¶'] },
                
                newTx: { type: 'expense', amount: '', category: 'é¤é¥®', icon: 'ğŸ”', desc: '', accountId: 'cash', fromId:'cash', toId:'debit', date: new Date().toISOString().slice(0,10), project: '', stockPrice:'', stockShares:'' },
                editingTx: null,
                ui: { cashOpen: false, creditOpen: true, investOpen: false, loanOpen: false },
                
                categories: {
                    expense: [
                        {name:'é¤é¥®',icon:'ğŸ”'},{name:'è´­ç‰©',icon:'ğŸ›ï¸'},{name:'äº¤é€š',icon:'ğŸš—'},{name:'ä½æˆ¿',icon:'ğŸ '},
                        {name:'å¨±ä¹',icon:'ğŸ®'},{name:'åŒ»ç–—',icon:'ğŸ’Š'},{name:'æ•™è‚²',icon:'ğŸ“'},{name:'å® ç‰©',icon:'ğŸ¾'},
                        {name:'ç¾å¦†',icon:'ğŸ’„'},{name:'è¿åŠ¨',icon:'ğŸƒ'},{name:'ç¤¾äº¤',icon:'ğŸ¥‚'},{name:'æ—…æ¸¸',icon:'âœˆï¸'},
                        {name:'æ•°ç ',icon:'ğŸ“±'},{name:'é€šè®¯',icon:'ğŸ“'},{name:'æŠ•èµ„',icon:'ğŸ“‰'},{name:'å…¶ä»–',icon:'ğŸ“'}
                    ],
                    income: [
                        {name:'å·¥èµ„',icon:'ğŸ’°'},{name:'ç†è´¢',icon:'ğŸ“ˆ'},{name:'å…¼èŒ',icon:'ğŸ’¼'},{name:'ç¤¼é‡‘',icon:'ğŸ§§'},
                        {name:'å¥–é‡‘',icon:'ğŸ…'},{name:'æŠ¥é”€',icon:'ğŸ§¾'},{name:'å…¶ä»–',icon:'ğŸ’'}
                    ]
                },
                statsRange: 'month', statsData: { income:0, expense:0, projectStats:[] }, 
                trendChart: null, catChart: null, investChart: null
            }
        },
        computed: {
            currentDate() { return new Date().toLocaleDateString(); },
            cashTotal() { return (this.assets.cash||0) + (this.assets.debit||0); },
            depositTotal() { return this.deposits.reduce((s,i)=>s+(i.amount||0),0); },
            stockTotal() { return this.stocks.reduce((s,i)=>s+((i.shares||0)*(i.price||0)),0); },
            creditTotal() { return this.creditCards.reduce((sum, c) => sum + (c.lastMonthBill||0) + (c.currentMonthBill||0) + (c.installments||[]).reduce((is,i)=>is+(i.total-(i.monthlyAmount*(i.paidMonths||0))),0), 0); },
            loanTotal() { return this.loans.reduce((s,i)=>s+(i.total||0),0); },
            totalAssets() { return this.cashTotal + this.depositTotal + this.stockTotal; },
            totalLiabilities() { return this.creditTotal + this.loanTotal; },
            netWorth() { return this.totalAssets - this.totalLiabilities; },
            
            monthlyStats() {
                const cm = new Date().toISOString().slice(0,7);
                const income = this.transactions.filter(t=>t.type==='income' && t.date.startsWith(cm)).reduce((s,t)=>s+t.amount,0);
                let expense = this.transactions.filter(t=>t.type==='expense' && t.date.startsWith(cm)).reduce((s,t)=>s+t.amount,0);
                this.loans.forEach(l => expense += (l.monthlyPayment||0));
                this.creditCards.forEach(c => (c.installments||[]).forEach(i => expense += (i.monthlyAmount||0)));
                return { income, expense };
            },
            budgetProgress() { return (this.monthlyStats.expense / (this.settings.monthlyBudget || 1)) * 100; },
            currentCategories() { return this.newTx.type === 'expense' ? this.categories.expense : this.categories.income; },
            
            isStockTransaction() {
                if(this.newTx.type === 'transfer') return this.stocks.find(s=>s.id===this.newTx.fromId) || this.stocks.find(s=>s.id===this.newTx.toId);
                return false; 
            },
            selectedStock() { return this.newTx.type==='adjust' ? this.stocks.find(s=>s.id===this.newTx.accountId) : null; },
            
            filteredTransactions() {
                let txs = [...this.transactions].sort((a,b)=>new Date(b.date)-new Date(a.date));
                if(this.searchText) {
                    const low = this.searchText.toLowerCase();
                    txs = txs.filter(t => (t.desc&&t.desc.toLowerCase().includes(low)) || t.amount.toString().includes(low) || (t.project&&t.project.includes(low)));
                }
                return txs.slice(0, 50);
            }
        },
        mounted() {
            if(localStorage.getItem('myWealth_V16_FINAL')) this.hasLocalData = true;
        },
        methods: {
            unlock() {
                if(!this.passwordInput) return;
                this.masterKey = this.passwordInput;
                const local = localStorage.getItem('myWealth_V16_FINAL');
                if(local) { if(!this.decryptAndLoad(local)) alert("å¯†ç é”™è¯¯"); } else { this.isUnlocked = true; this.saveData(); }
            },
            decryptAndLoad(str) {
                try {
                    const bytes = CryptoJS.AES.decrypt(str, this.masterKey);
                    const data = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                    Object.assign(this, data);
                    if(!this.settings) this.settings = { monthlyBudget: 5000, projects: ['è£…ä¿®'] };
                    this.isUnlocked = true;
                    return true;
                } catch(e) { return false; }
            },
            
            // === æ ¸å¿ƒé€»è¾‘ ===
            setTxType(t) {
                this.newTx.type = t;
                if (t === 'adjust') {
                    this.newTx.category = 'ç†è´¢';
                    this.newTx.icon = 'ğŸ“ˆ';
                } else if (t === 'expense' && this.newTx.category === 'ç†è´¢') {
                    this.newTx.category = 'é¤é¥®'; // reset to default expense if switching back
                    this.newTx.icon = 'ğŸ”';
                }
            },
            openTxModal(tx) { 
                this.editingTx = tx;
                this.newTx = tx ? JSON.parse(JSON.stringify(tx)) : { 
                    type: 'expense', amount: '', category: 'é¤é¥®', icon: 'ğŸ”', desc: '', 
                    accountId: 'cash', fromId: 'cash', toId: 'debit',
                    date: new Date().toISOString().slice(0,10), project: '', stockPrice:'', stockShares:'' 
                };
                this.showTxModal = true; 
            },
            updateAccount(tx, revert=false) {
                const f = revert ? -1 : 1;
                const {type, amount, accountId, fromId, toId, stockShares, stockPrice} = tx;
                
                if (type === 'adjust') {
                    const st = this.stocks.find(s=>s.id === accountId);
                    if (st) st.price = amount; 
                    return; 
                }
                if (type === 'transfer') {
                    this.modifyBalance(fromId, -amount * f);
                    this.modifyBalance(toId, amount * f);
                    const toStock = this.stocks.find(s=>s.id === toId);
                    const fromStock = this.stocks.find(s=>s.id === fromId);
                    if (toStock && stockShares) toStock.shares += stockShares * f; 
                    if (fromStock && stockShares) fromStock.shares -= stockShares * f;
                } else {
                    if(['cash','debit'].includes(accountId)) {
                        this.modifyBalance(accountId, (type==='income'?amount:-amount)*f);
                    } else {
                        let cc=this.creditCards.find(c=>c.id===accountId), ln=this.loans.find(l=>l.id===accountId);
                        if(cc) cc.currentMonthBill += (type==='expense'?amount:-amount)*f; 
                        else if(ln) ln.total += (type==='income'?-amount:amount)*f;
                    }
                }
            },
            modifyBalance(id, delta) {
                if(id==='cash') this.assets.cash += delta;
                else if(id==='debit') this.assets.debit += delta;
                else {
                    let cc=this.creditCards.find(c=>c.id===id);
                    if(cc) cc.currentMonthBill -= delta; 
                }
            },
            confirmTx() {
                if(!this.newTx.amount) return;
                if(this.editingTx) { this.updateAccount(this.editingTx, true); this.transactions = this.transactions.filter(t=>t.id!==this.editingTx.id); }
                const final = { id: this.editingTx?.id||Date.now(), ...this.newTx };
                this.updateAccount(final);
                this.transactions.push(final);
                this.showTxModal = false;
                this.saveData();
            },
            deleteTx() {
                if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
                this.updateAccount(this.editingTx, true);
                this.transactions = this.transactions.filter(t=>t.id!==this.editingTx.id);
                this.showTxModal = false;
                this.saveData();
            },
            addProject() {
                const p = prompt("è¯·è¾“å…¥æ–°é¡¹ç›®åç§°:");
                if(p && !this.settings.projects.includes(p)) {
                    this.settings.projects.push(p);
                    this.newTx.project = p;
                    this.saveData();
                }
            },

            // === æŠ¥è¡¨æ¸²æŸ“ ===
            renderStats() {
                const ctxTrend = document.getElementById('trendChart');
                const ctxCat = document.getElementById('catChart');
                const ctxInvest = document.getElementById('investChart');
                if(!ctxTrend || !ctxCat || !ctxInvest) return;
                if(this.trendChart) this.trendChart.destroy();
                if(this.catChart) this.catChart.destroy();
                if(this.investChart) this.investChart.destroy();

                const now = new Date();
                let startStr = "";
                if(this.statsRange==='week') { const d=new Date(); d.setDate(d.getDate()-7); startStr=d.toISOString().slice(0,10); }
                else if(this.statsRange==='month') { startStr=now.toISOString().slice(0,7); }
                else { startStr=now.toISOString().slice(0,4); }

                const txs = this.transactions.filter(t => t.date >= startStr && t.type!=='transfer' && t.type!=='adjust');
                this.statsData.income = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
                this.statsData.expense = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);

                const projMap = {};
                txs.filter(t=>t.type==='expense' && t.project).forEach(t => projMap[t.project] = (projMap[t.project]||0)+t.amount);
                this.statsData.projectStats = Object.entries(projMap).sort((a,b)=>b[1]-a[1]).map(([name, amount])=>({name, amount, percent: Math.round(amount/this.statsData.expense*100)}));

                const catMap = {};
                txs.filter(t=>t.type==='expense').forEach(t => catMap[t.category] = (catMap[t.category]||0)+t.amount);
                const cats = Object.entries(catMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
                
                this.catChart = new Chart(ctxCat, {
                    type: 'doughnut',
                    data: { labels: cats.map(x=>x[0]), datasets: [{ data: cats.map(x=>x[1]), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { size: 10 } } } } }
                });

                const days = {};
                txs.forEach(t => { const d=t.date.slice(5); if(!days[d]) days[d]={in:0,out:0}; if(t.type==='income') days[d].in+=t.amount; else days[d].out+=t.amount; });
                const labels = Object.keys(days).sort();
                this.trendChart = new Chart(ctxTrend, {
                    type: 'bar',
                    data: { labels, datasets: [ { label:'æ”¯', data: labels.map(d=>days[d].out), backgroundColor:'#10b981', borderRadius:3 }, { label:'æ”¶', data: labels.map(d=>days[d].in), backgroundColor:'#ef4444', borderRadius:3 } ] },
                    options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{display:false}} }
                });
                
                const investLabels = this.history.slice(-30).map(h => h.date.slice(5));
                const investData = this.history.slice(-30).map(h => h.stockVal || 0);
                this.investChart = new Chart(ctxInvest, {
                    type: 'line',
                    data: { labels: investLabels, datasets: [{ label: 'å¸‚å€¼', data: investData, borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
                });
            },

            manageProjects() {
                const input = prompt("å½“å‰é¡¹ç›®åˆ—è¡¨ (ç”¨é€—å·åˆ†éš”):", this.settings.projects.join(','));
                if(input !== null) { this.settings.projects = input.split(',').map(s=>s.trim()).filter(s=>s); this.saveData(); }
            },
            addCreditCard() { this.creditCards.push({id:Date.now(), name:'', lastMonthBill:0, currentMonthBill:0, installments:[]}); },
            addInstallment(card) {
                const name=prompt("åˆ†æœŸäº‹é¡¹åç§° (å¦‚: iPhone)"), total=Number(prompt("åˆ†æœŸæ€»é‡‘é¢")), months=Number(prompt("åˆ†æœŸæœŸæ•°"));
                if(name&&total&&months) card.installments.push({name, total, months, monthlyAmount:total/months, paidMonths:0});
            },
            removeCreditCard(idx) { if(confirm("åˆ é™¤æ­¤å¡ï¼Ÿ")) this.creditCards.splice(idx,1); },
            calcLoanMonthly(l) { if(l.total && l.years) l.monthlyPayment = Math.round(l.total / (l.years * 12)); },
            getAccountName(id) {
                if(id==='cash') return 'ç°é‡‘'; if(id==='debit') return 'å‚¨è“„å¡';
                return (this.creditCards.concat(this.stocks, this.loans).find(x=>x.id===id)||{}).name || 'æœªçŸ¥';
            },
            getTypeColor(type, bg=false) {
                if(type==='income') return bg ? 'bg-red-50 text-red-500' : 'text-income';
                if(type==='transfer') return bg ? 'bg-blue-50 text-blue-500' : 'text-transfer';
                if(type==='adjust') return bg ? 'bg-amber-50 text-amber-500' : 'text-adjust';
                return bg ? 'bg-emerald-50 text-emerald-500' : 'text-expense';
            },
            toggleAll() { this.ui.cashOpen=!this.ui.cashOpen; this.ui.creditOpen=this.ui.cashOpen; this.ui.investOpen=this.ui.cashOpen; this.ui.loanOpen=this.ui.cashOpen; },
            
            saveData() {
                const today = new Date().toLocaleDateString();
                const currentStockVal = this.stockTotal;
                if(!this.history.find(h=>h.date===today)) { 
                    this.history.push({date:today, val:this.netWorth, stockVal: currentStockVal}); 
                    if(this.history.length>30) this.history.shift(); 
                } else { 
                    const h = this.history.find(h=>h.date===today);
                    h.val = this.netWorth;
                    h.stockVal = currentStockVal;
                }
                const data = { assets:this.assets, deposits:this.deposits, stocks:this.stocks, loans:this.loans, creditCards:this.creditCards, transactions:this.transactions, history:this.history, settings:this.settings };
                const str = CryptoJS.AES.encrypt(JSON.stringify(data), this.masterKey).toString();
                localStorage.setItem('myWealth_V16_FINAL', str);
                if(this.isUnlocked && this.currentTab==='stats') this.renderStats();
            },
            
            exportToFile() {
                const data = localStorage.getItem('myWealth_V16_FINAL');
                const blob = new Blob([data], { type: 'text/plain' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `wealth_backup_${new Date().toISOString().slice(0,10)}.txt`; a.click();
            },
            handleFileImport(event) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const bytes = CryptoJS.AES.decrypt(e.target.result, this.masterKey);
                        JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                        localStorage.setItem('myWealth_V16_FINAL', e.target.result);
                        alert("æ¢å¤æˆåŠŸï¼åˆ·æ–°é¡µé¢ç”Ÿæ•ˆã€‚");
                        location.reload();
                    } catch(err) { alert("æ–‡ä»¶æ— æ•ˆæˆ–å¯†ç ä¸åŒ¹é…"); }
                };
                reader.readAsText(event.target.files[0]);
            },
            importData() {
                try {
                    const bytes = CryptoJS.AES.decrypt(this.importString, this.masterKey);
                    const data = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                    Object.assign(this, data);
                    this.saveData();
                    this.showImport = false;
                    alert("æ¢å¤æˆåŠŸ");
                } catch(e){ alert('æ¢å¤å¤±è´¥'); }
            },
            exportToExcel() {
                let csv = "\uFEFFæ—¥æœŸ,ç±»å‹,é‡‘é¢,åˆ†ç±»,é¡¹ç›®,è´¦æˆ·,å¤‡æ³¨\n";
                this.transactions.forEach(t => csv += `${t.date},${t.type==='income'?'æ”¶å…¥':(t.type==='transfer'?'è½¬è´¦':(t.type==='adjust'?'è°ƒä»“':'æ”¯å‡º'))},${t.amount},${t.category||'-'},${t.project||'-'},${this.getAccountName(t.accountId)},${t.desc}\n`);
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
                link.download = `è´¦å•_${new Date().toLocaleDateString()}.csv`;
                link.click();
            },
            resetApp() { if(confirm("âš ï¸ ç¡®å®šé‡ç½®ï¼Ÿæ•°æ®å°†æ°¸ä¹…ä¸¢å¤±ï¼")) { localStorage.removeItem('myWealth_V16_FINAL'); location.reload(); } },
            lockApp() { this.saveData(); this.isUnlocked = false; this.passwordInput = ''; },
            formatNumber(num) { return num ? num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') : '0.00'; }
        }
    }).mount('#app');
</script>
</body>
</html>
